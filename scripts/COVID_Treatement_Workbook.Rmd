---
title: "RAMP/COPING treatment paper core notebook"

author: "K L Purves"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: cerulean
code_folding: show

html_notebook:
  theme: cerulean
toc: yes
---

This workbook runs code and shows results for the manuscript ***Access and uptake of mental health services during the COVID-19 pandemic: rates, barriers and usefulness***. 

# Project description

## Research questions

1. What are the rates for treatment seeking for MH concerns at each time point (wave)
- rates over time

2. 

## Details, discussion and questions

How do we show change over time in treatment seeking and receipt over time?
- are services overwhelmed?

## Predictors

We select predictors that predict worse outcomes for common mental health problems in this sample [see GitHub for relevant paper here](https://github.com/klpurves/PANCHANGE_analysis/tree/forest_plots)


## submission

Will submit to Psychological Medicine in first instance

## variables that need creating

- did you seek treatment at any time

### Variable categorisation

**treatment type:**
supported (requires contact) or self guided ()

Categorisation makes sense for resource allocation etc.

**reasons for seeking**
new or existing
crisis as a third (number dependent)

**barriers**
Systemic and client level

### People who have helped along the way
Henry 
Laura
Molly

## Figures

1. COVID figures, lockdown dates, histogram/density 
2. Bar plot 
3. Map of the UK showing rates of treatment seeking and receipt per area (prop sought treatment == size, proportion received == colour) probably district or rgion level?
4. Forest plots



# set up 

Clear global environment
```{r Clear global environment}
remove(list = ls())
```

## Call in set up scripts

```{r source files}
#source data directory: data_path
source("/Users/kirstin/Dropbox/SGDP/RAMP/Projects/Treatment/file_paths.R")
setwd(wd)
source("./scripts/palettes.R")
source("./scripts/libraries.R")

```


```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE,
                      root.dir=wd)

knitr::opts_chunk$set(fig.path="figures/")



options(bitmapType = 'quartz') # to render fonts better
```

Retrieve the current date to use it for file endings to not overwrite files when one exports files
```{r Recent date}
date = Sys.Date()
```

## R functions

```{r call in function library functions}

# source all functions in the function library folder
#files.sources = paste0("/FunctionLib",list.files("/FunctionLib"))
#sapply(files.sources, source)

```

# Data wrangling

## Data import
RAMP
```{r read in data ramp}
treatRAMP <- readRDS(file = paste0(data_path, "/ramp_followupb/treatment_ramp_followupb.rds"))
demRAMP <- readRDS(file = paste0(data_path, "/ramp/dem_ramp.RDS"))

```

COPING
Note, external data refrence is a hash-id for coping. So it is consistent across aprticipants and matches, but is not linkable to GLAD ID
```{r read in data coping}
treatCOPE <- readRDS(file = paste0(cope_path, "/coping_followupa_ongoing/treatment_coping_followupa_ongoing.rds"))
demCOPE.glad <- readRDS(file = paste0(data_path, "/coping_glad/dem_coping_glad.RDS"))
demCOPE.edgi <- readRDS(file = paste0(data_path, "/coping_edgi/dem_coping_edgi.RDS"))
demCOPE.nbr <- readRDS(file = paste0(data_path, "/coping_nbr/dem_coping_nbr.RDS"))

```

# Create a wave columns in treatment data
Base this on dates of the follow ups drawn from qualtrics.

RAMP
5 waves

1 - May 2020
2 - June 2020
3 - July 2020 (start date actually the last day of June)
4 - September 2020
5 - November 2020

```{r identify wave dates ramp}
setwd(wd)
source("./scripts/RAMPwaves.R")
```

COPING
```{r identify wave dates coping}
setwd(wd)
source("./scripts/COPINGwaves.R")
```

## select only relevant demographics

```{r demographic select list}
keepcols.cope <- c("externalDataReference","dem.which_gender_do_you_identify_with")
cols.cope <- c("LoginID","Gender")
keepcols.nbr <- c("subjectid")
cols.nbr <- c("LoginID")
keepcols.ramp <- c("externalDataReference","dem2.how_old_are_you","dem2.which_gender_do_you_identify_with")
cols.ramp <- c("LoginID","Age","Gender")
```


```{r demographic select}
dem.cope.glad <- demCOPE.glad[names(demCOPE.glad) %in% keepcols.cope]
dem.cope.edgi <- demCOPE.edgi[names(demCOPE.edgi) %in% keepcols.cope]
dem.cope.nbr <- demCOPE.nbr[names(demCOPE.nbr) %in% keepcols.nbr]
dem.ramp <- demRAMP[names(demRAMP) %in% keepcols.ramp]

names(dem.cope.glad) <- cols.cope
names(dem.cope.edgi) <- cols.cope
names(dem.cope.nbr) <- cols.nbr
names(dem.ramp) <- cols.ramp
```
## add sample columns 

```{r add sample col}

dem.cope.glad$Sample <-  "COPING"
dem.cope.edgi$Sample <- "COPING"
dem.cope.nbr$Sample <- "COPING"
dem.ramp$Sample <- "RAMP"

treatRAMP$Sample <- "RAMP"
treatCOPE$Sample <- "COPING"

```

## SPACE FOR PREDICTOR CLEANING

Will need to find and add predictor variables. Will add this here.

## merge demographcis

Waiting till I can get age into GLAD & EDGI

```{r demographics merge}

dem <- merge(dem.cope.glad,dem.cope.edgi)
dem <- merge(dem,dem.cope.nbr)
dem <- merge(dem,dem.ramp)

```

## Rename the treatment variables and drop irrelevant ones

used the [data dictionary](https://docs.google.com/spreadsheets/d/1Vp028XLxbcXeOdjeuI-3y-kVenKWDR4hW9iJ1tHpttI/edit#gid=1527211037) to identify the relevant items and rename them

```{r rename COPE & RAMP datasets and select variables}
setwd(wd)
source("./scripts/renameRAMPtreatment.R")

treatRAMP.fin <- treatRAMP.renamed[names(treatRAMP.renamed) %in% treatnames]
treatCOPE.fin <- treatCOPE.renamed[names(treatCOPE.renamed) %in% treatnames]

```
## merge RAMP and COPING treatment data

Use rbind to add COPING to RAMP

```{r merge coping and ramp treatment data}

treat_dat <- rbind(treatRAMP.fin,treatCOPE.fin)
  
```

## order wave variable

```{r reorder wave factor}

treat_dat$wave <- factor(treat_dat$wave,
                         levels = c("May 2020","June 2020", "July 2020","August 2020","September 2020","October 2020","November 2020","Deember 2020","January 2021"))

```

## Create summary variables for treatment

### Sought help for new or pre-existing MH disorder 

### Type of treatment (supported / self guided)

### received treatment if sought (per wave)

### Sought treatment at any time

### received treatment at any time

### Client level vs systemic barriers



# Aim 1 analyses

## Descriptives

### Response rates per wave

```{r response rates per wave}

treat_dat %>%
  group_by(wave) %>%
  count()


```
### Frequency of treatment seeking per wave

```{r treatment seeking freq by wave}

treat_dat %>%
  group_by(wave) %>%
  freq(soughthelp_for_self)

```

### Frequency of treatment seeking


## Analytic decision notes

### Including cohort as a covariate

This would likely be a collider (sx severity is going to be associated with both cohort and treatment seeking)

