---
title: "RAMP/COPING treatment paper core notebook"
author: "K L Purves"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    df_print: paged
    highlight: monochrome
    number_sections: no
    standalone: no
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
  word_document:
    toc: yes
    toc_depth: '3'
html_notebook:
  theme: cerulean
code_folding: show
toc: yes
---

This workbook runs code and shows results for the manuscript ***Access and uptake of mental health services during the COVID-19 pandemic: rates, barriers and usefulness***. 

# Project description

#### Research questions

1. What are the rates for treatment seeking for MH concerns at each time point (wave)
- rates over time

2. 

#### Details, discussion and questions

How do we show change over time in treatment seeking and receipt over time?
- are services overwhelmed?

#### Predictors

We select predictors that predict worse outcomes for common mental health problems in this sample [see GitHub for relevant paper here](https://github.com/klpurves/PANCHANGE_analysis/tree/forest_plots)


#### submission

Will submit to Psychological Medicine in first instance

#### variables that need creating

- did you seek treatment at any time

#### Variable categorisation

**treatment type:**
supported (requires contact) or self guided ()

Categorisation makes sense for resource allocation etc.

**reasons for seeking**
new or existing
crisis as a third (number dependent)

**barriers**
Systemic and client level

#### People who have helped along the way
Henry 
Laura
Molly

#### Figures

1. COVID figures, lockdown dates, histogram/density 
2. Bar plot 
3. Map of the UK showing rates of treatment seeking and receipt per area (prop sought treatment == size, proportion received == colour) probably district or rgion level?
4. Forest plots

** prevention figure: bars for each barrier type, coloured by whether systemic or client led

# set up 

Clear global environment
```{r Clear global environment}
remove(list = ls())
```

#### Call in set up scripts

```{r Setup, source files, echo=FALSE}
#source data directory: data_path
source("/Users/katherineyoung/OneDrive - King's College London/MQ_project/papers/RAMP-COPING_MH_treatment_paper/file_paths.R")
setwd(wd)
source("./scripts/palettes.R")
source("./scripts/libraries.R")

```


```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE,
                      root.dir=wd)

knitr::opts_chunk$set(fig.path="figures/")

options(bitmapType = 'quartz') # to render fonts better
```

Retrieve the current date to use it for file endings to not overwrite files when one exports files
```{r Recent date}
date = Sys.Date()
```

#### R functions

```{r call in function library functions}
# source all functions in the function library folder
files.sources = paste0("/Users/katherineyoung/OneDrive - King's College London/MQ_project/papers/RAMP-COPING_MH_treatment_paper/CovidTreatment/FunctionLib/",list.files("/Users/katherineyoung/OneDrive - King's College London/MQ_project/papers/RAMP-COPING_MH_treatment_paper/CovidTreatment/FunctionLib"))


sapply(files.sources, source)

library("eeptools")

```

#Add_numeric function
Function used to convert character variables into numeric variables.
```{r add_numeric function}
add_numeric <- function(dat, exclude = NULL) {
  dat_fct <- sjlabelled::as_label(dat)

  dat <- dat[!colnames(dat) %in% exclude]
  colnames(dat) <- paste(colnames(dat), "numeric", sep = "_")
  return(bind_cols(dat_fct, dat))
}
```
# Colour palettes
Define colours for plotting this are the standard coping colours
```{r Colour palettes: COPING}
COPINGpalette2 <- c("#78D9C5",
                    "#F5BE5E")

COPINGpalette3 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9")

COPINGpalette4 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73")

COPINGpalette5 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98")

COPINGpalette6 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73",
                    "#FFED98",
                    "#BFD2EB")

COPINGpalette7 <- c("#78D9C5",
                    "#F5BE5E",
                    "#EEB6E9",
                    "#DBDB73", 
                    "#FFED98",
                    "#BFD2EB", 
                    "#808080")

COPINGpaletteGRAD <- c("#F5BE5E",
                       "#FFD284",
                       "#FFEED1",
                       "#B5B5B5",
                       "#DEFFF8",
                       "#94F6E1",
                       "#78D9C5")

COPINGNeuCenterpalette <- c("#78D9C5",
                            "#808080",
                            "#F5BE5E")

RAMPworseGRADpalette <- c("#78D9C5",
                          "#FFEED1",
                          "#F5BE5E",
                          "#FFB1B5")
GLADpalette = c("#efc00b", 
                "#b7dee8")  

RAMPlikertpalette <- c("#78D9C5",
                       "#8DD5B4",
                       "#A2D0A3",
                       "#B7CC92",
                       "#CBC780",
                       "#E0C36F",
                    "#F5BE5E")
```

Choose in this chunk which palette to use
04.07.2020 - Default to 2 colour COPING palette
```{r Choose colour palette}
palette = COPINGpalette2
```

# ggplot theme
Set up ggplot theme for the plots
```{r ggplot theme}
library(ggpubr)

theme_personal <-  theme(
    text = element_text(color = "black"),
    axis.title = element_text(color = "black"),
    axis.text = element_text(color = "black"),
    legend.background = element_blank(),
    legend.box.background = element_blank(),
    panel.background = element_blank(), 
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_line(
      colour = "gray",
      linetype = "dashed",
      size = 0.2
      ),
    axis.ticks = element_blank()
    )
```
# Data wrangling

#### Data import
RAMP
```{r read in data ramp}
treatRAMP <- readRDS(file = paste0(data_path, "/ramp_followupb/treatment_ramp_followupb.rds"))
demRAMP <- readRDS(file = paste0(data_path, "/ramp/dem_ramp.RDS"))

```

COPING
Note, external data reference is a hash-id for coping. So it is consistent across participants and matches, but is not linkable to GLAD ID
```{r read in data coping}
treatCOPE <- readRDS(file = paste0(data_path, "/coping_followupa_ongoing/treatment_coping_followupa_ongoing.rds"))

demCOPE.glad <- readRDS(file = paste0(data_path, "/coping_glad/dem_coping_glad.RDS"))
demCOPE.glad.baseline <- readRDS(file = paste0(data_path, "/glad/dem_glad.RDS"))

demCOPE.edgi <- readRDS(file = paste0(data_path, "/coping_edgi/dem_coping_edgi.RDS"))
demCOPE.edgi.baseline <- readRDS(file = paste0(data_path_baseline, "/edgi/dem_edgi.RDS"))
#demCOPE.edgi.baseline <- readRDS("/Users/katherineyoung/King's College London/MT-TNG BioResource EDIT - ilovedata - data_raw/2021-10-03/edgi/dem_edgi.rds")


demCOPE.nbr <- readRDS(file = paste0(data_path_baseline, "/coping_nbr/demographics_coping_nbr.RDS"))
demographicsCOPE.nbr <- readRDS(file = paste0(data_path, "/coping_nbr/demographics_coping_nbr.RDS"))
#demCOPE.nbr.baseline <- fread(paste0(data_path, "/nbr/NBR_hlq_dem_data_hash.csv"))
demCOPE.nbr.baseline <- fread(file = paste0(data_path_demCOPE,"coping_participants_export_20200730_hashed.csv"))


#GLADpostcode <- fread(paste0(postpath,"/GLAD_COPING_postcodes.csv"))
#EDGIpostcode <- fread(paste0(postpath,"/EDGI_COPING_postcodes.csv"))
#NBRpostcode <- fread(paste0(postpath,"/NBR_postcodes_hash.csv"))

MHD.COPE.glad <- readRDS(file = paste0(data_path, "/coping_glad/mhd_coping_glad.rds"))
#MHD.COPE.edgi <- readRDS(file = paste0(data_path, "/coping_edgi/mhd_coping_edgi.rds")) 
MHD.COPE.nbr <- readRDS(file = paste0(data_path, "/coping_nbr/mhd_coping_nbr.rds"))

MHD.RAMP <- readRDS(file = paste0(data_path_baseline, "/ramp/mhd_ramp.rds"))

```


# Get age,gender & ethnicity for GLAD, EDGI & NBR

## GLAD
```{r age gender ethnicity GLAD}

GLADdemvars <- demCOPE.glad.baseline %>%
  select("externalDataReference","dem.which_gender_do_you_identify_with","dem.questions_based_details_gather","dem.how_old_are_you_now.txt") %>%
  rename(ID=externalDataReference,
         Gender=dem.which_gender_do_you_identify_with,
         Ethnicity=dem.questions_based_details_gather,
         Age.linear = dem.how_old_are_you_now.txt)

```


### make age categorical

Age cats:

-77: Seen but not answered
16-18
19-25
26-35
36-45
46-55
56-65
66-70
71-75
76-80
81-85
86-90
91-100
100+

RECODING TO BE EQUAL INTERVALS
16-25
26-35
36-45
46-55
56-65
66-75
76+

```{r age categorical GLAD}

GLADdemvars <- GLADdemvars %>%
  mutate(AgeAll = case_when(Age.linear >=16 & Age.linear <= 18 ~ "16-18",
                            Age.linear >=19 & Age.linear <= 25 ~ "19-25",
                            Age.linear >=26 & Age.linear <= 35 ~ "26-35",
                            Age.linear >=36 & Age.linear <= 45 ~ "36-45",
                            Age.linear >=46 & Age.linear <= 55 ~ "46-55",
                            Age.linear >=56 & Age.linear <= 65 ~ "56-65",
                            Age.linear >=66 & Age.linear <= 70 ~ "66-70",
                            Age.linear >=71 & Age.linear <= 75 ~ "71-75",
                            Age.linear >=76 & Age.linear <= 80 ~ "76-80",
                            Age.linear >=81 & Age.linear <= 85 ~ "81-85",
                            Age.linear >=86 & Age.linear <= 90 ~ "86-90",
                            Age.linear >=91 & Age.linear <= 100 ~ "91-100",
                            Age.linear >=101 ~ "100+",
                            Age.linear ==-77 ~ "Did not respond"),
         Age80up = case_when(Age.linear >=16 & Age.linear <= 18 ~ "16-18",
                            Age.linear >=19 & Age.linear <= 25 ~ "19-25",
                            Age.linear >=26 & Age.linear <= 35 ~ "26-35",
                            Age.linear >=36 & Age.linear <= 45 ~ "36-45",
                            Age.linear >=46 & Age.linear <= 55 ~ "46-55",
                            Age.linear >=56 & Age.linear <= 65 ~ "56-65",
                            Age.linear >=66 & Age.linear <= 70 ~ "66-70",
                            Age.linear >=71 & Age.linear <= 75 ~ "71-75",
                            Age.linear >=76 & Age.linear <= 80 ~ "76-80",
                            Age.linear >=81  ~ "81+",
                            Age.linear ==-77 ~ "Did not respond"),
         AgeRecoded = case_when(Age.linear >=16 & Age.linear <= 25 ~ "16-25",
                            Age.linear >=26 & Age.linear <= 35 ~ "26-35",
                            Age.linear >=36 & Age.linear <= 45 ~ "36-45",
                            Age.linear >=46 & Age.linear <= 55 ~ "46-55",
                            Age.linear >=56 & Age.linear <= 65 ~ "56-65",
                            Age.linear >=66 & Age.linear <= 75 ~ "66-75",
                            Age.linear >=76 & Age.linear <= 80 ~ "76+",
                            Age.linear ==-77 ~ "Did not respond"))

```


## EDGI
```{r age gender ethnicity EDGI}

EDGIdemvars <- demCOPE.edgi.baseline %>%
  select("externalDataReference","demographics.what_gender_do_you_identify_with","demographics.what_gender_do_you_identify_with","demographics.what_gender_do_you_identify_with") %>%
  rename(ID=externalDataReference,
         Gender=demographics.what_gender_do_you_identify_with,
         Ethnicity=demographics.what_gender_do_you_identify_with,
         Age.linear = demographics.what_gender_do_you_identify_with)

```


### make age categorical

Age cats:

-77: Seen but not answered
16-18
19-25
26-35
36-45
46-55
56-65
66-70
71-75
76-80
81-85
86-90
91-100
100+

```{r age categorical EDGI}

EDGIdemvars <- EDGIdemvars %>%
  mutate(AgeAll = case_when(Age.linear >=16 & Age.linear <= 18 ~ "16-18",
                            Age.linear >=19 & Age.linear <= 25 ~ "19-25",
                            Age.linear >=26 & Age.linear <= 35 ~ "26-35",
                            Age.linear >=36 & Age.linear <= 45 ~ "36-45",
                            Age.linear >=46 & Age.linear <= 55 ~ "46-55",
                            Age.linear >=56 & Age.linear <= 65 ~ "56-65",
                            Age.linear >=66 & Age.linear <= 70 ~ "66-70",
                            Age.linear >=71 & Age.linear <= 75 ~ "71-75",
                            Age.linear >=76 & Age.linear <= 80 ~ "76-80",
                            Age.linear >=81 & Age.linear <= 85 ~ "81-85",
                            Age.linear >=86 & Age.linear <= 90 ~ "86-90",
                            Age.linear >=91 & Age.linear <= 100 ~ "91-100",
                            Age.linear >=101 ~ "100+",
                            Age.linear ==-77 ~ "Did not respond"),
         Age80up = case_when(Age.linear >=16 & Age.linear <= 18 ~ "16-18",
                            Age.linear >=19 & Age.linear <= 25 ~ "19-25",
                            Age.linear >=26 & Age.linear <= 35 ~ "26-35",
                            Age.linear >=36 & Age.linear <= 45 ~ "36-45",
                            Age.linear >=46 & Age.linear <= 55 ~ "46-55",
                            Age.linear >=56 & Age.linear <= 65 ~ "56-65",
                            Age.linear >=66 & Age.linear <= 70 ~ "66-70",
                            Age.linear >=71 & Age.linear <= 75 ~ "71-75",
                            Age.linear >=76 & Age.linear <= 80 ~ "76-80",
                            Age.linear >=81  ~ "81+",
                            Age.linear ==-77 ~ "Did not respond"),
        AgeRecoded = case_when(Age.linear >=16 & Age.linear <= 25 ~ "16-25",
                            Age.linear >=26 & Age.linear <= 35 ~ "26-35",
                            Age.linear >=36 & Age.linear <= 45 ~ "36-45",
                            Age.linear >=46 & Age.linear <= 55 ~ "46-55",
                            Age.linear >=56 & Age.linear <= 65 ~ "56-65",
                            Age.linear >=66 & Age.linear <= 75 ~ "66-75",
                            Age.linear >=76 & Age.linear <= 80 ~ "76+",
                            Age.linear ==-77 ~ "Did not respond"))

```


## NBR
### Select variables
```{r age gender ethnicity NBR}

NBRdemvars <- demCOPE.nbr.baseline %>%
  select("NBR ID","gender","ethnicity","age") %>%
  rename(ID=`NBR ID`,
         Gender=gender,
         Ethnicity=ethnicity,
         Age.linear = age)

```
########################################################

```{r nbr age cleaning}
  exclude_cols_dem <- c("ID",
                        "Sample",
                        "Age_uncleaned",
                        "EduYrs")

nbr.dem.raw.id <- demographicsCOPE.nbr %>%
    drop_na(subjectid) %>% # Drop NAs
    distinct(subjectid, .keep_all = TRUE) %>% # Remove duplicates based on ID
#    separate(subjectid, into = c("Sample", "ID.intm"), sep = 6) %>% # Split ID in Sample and Number
#    separate(ID.intm, into = "ID", sep = 7) %>%
    mutate(ID = subjectid) %>%
    select(
      ID, # ID
      Birthyear_unc = dem.year, # Birthyear
      Birthmonth = dem.month, #Birthmonth
      Birthday = dem.day, #Birthday
      Gender_unc = dem.which_gender_do_you_identify_with, # Gender
      Sex = dem.select_questionnaire_items_medical #Sex
    ) %>%
    add_numeric(., exclude = exclude_cols_dem) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

  # Inspect dimensions
  dim(nbr.dem.raw.id)
  # Inspect colnames
  colnames(nbr.dem.raw.id)
```

### NBR converting birth year to age
```{r nbr dem calculating age from birthday}
nbr.dem.raw.id$Birthyear_numeric <- nbr.dem.raw.id$Birthyear_unc_numeric + 1900

#create dob as date format
nbr.dem.raw.id$Birthdate <- as.Date(paste(nbr.dem.raw.id$Birthyear_numeric,
                                  nbr.dem.raw.id$Birthmonth_numeric,
                                  nbr.dem.raw.id$Birthday_numeric,
                                  sep = "-"))

head(nbr.dem.raw.id$Birthdate)

#Calculate dem.age(remove NAs as it throws an error)
#ages <- age_calc(na.omit(nbr.dem.raw.id$Birthdate), enddate = Sys.Date(), units = "years")
#end of may set as arbitrary endpoint for baseline data for rough estimate of age
ages <- age_calc(na.omit(nbr.dem.raw.id$Birthdate), enddate = as.Date("2020-05-30"), units = "years")

#Create dem.agecolumn
nbr.dem.raw.id$Age_uncleaned<- NA

#Populate with values (excluding NAs)
nbr.dem.raw.id$Age_uncleaned[!is.na(nbr.dem.raw.id$Birthdate)] <- ages

#Round age down
nbr.dem.raw.id$Age_uncleaned <- floor(nbr.dem.raw.id$Age_uncleaned)

#Visualise
head(nbr.dem.raw.id$Age_uncleaned)
head(nbr.dem.raw.id$Birthdate)

```

### make age categorical

Age cats:

-77: Seen but not answered
16-18
19-25
26-35
36-45
46-55
56-65
66-70
71-75
76-80
81-85
86-90
91-100
100+

```{r age categorical NBR}
all_NBR_dems <- left_join(NBRdemvars, nbr.dem.raw.id)

NBRdemvars$Age.linear <- all_NBR_dems$Age_uncleaned
NBRdemvars <- NBRdemvars %>%
  mutate(AgeAll = case_when(Age.linear >=16 & Age.linear <= 18 ~ "16-18",
                            Age.linear >=19 & Age.linear <= 25 ~ "19-25",
                            Age.linear >=26 & Age.linear <= 35 ~ "26-35",
                            Age.linear >=36 & Age.linear <= 45 ~ "36-45",
                            Age.linear >=46 & Age.linear <= 55 ~ "46-55",
                            Age.linear >=56 & Age.linear <= 65 ~ "56-65",
                            Age.linear >=66 & Age.linear <= 70 ~ "66-70",
                            Age.linear >=71 & Age.linear <= 75 ~ "71-75",
                            Age.linear >=76 & Age.linear <= 80 ~ "76-80",
                            Age.linear >=81 & Age.linear <= 85 ~ "81-85",
                            Age.linear >=86 & Age.linear <= 90 ~ "86-90",
                            Age.linear >=91 & Age.linear <= 100 ~ "91-100",
                            Age.linear >=101 ~ "100+",
                            Age.linear ==-77 ~ "Did not respond"),
         Age80up = case_when(Age.linear >=16 & Age.linear <= 18 ~ "16-18",
                            Age.linear >=19 & Age.linear <= 25 ~ "19-25",
                            Age.linear >=26 & Age.linear <= 35 ~ "26-35",
                            Age.linear >=36 & Age.linear <= 45 ~ "36-45",
                            Age.linear >=46 & Age.linear <= 55 ~ "46-55",
                            Age.linear >=56 & Age.linear <= 65 ~ "56-65",
                            Age.linear >=66 & Age.linear <= 70 ~ "66-70",
                            Age.linear >=71 & Age.linear <= 75 ~ "71-75",
                            Age.linear >=76 & Age.linear <= 80 ~ "76-80",
                            Age.linear >=81  ~ "81+",
                            Age.linear ==-77 ~ "Did not respond"),
        AgeRecoded = case_when(Age.linear >=16 & Age.linear <= 25 ~ "16-25",
                            Age.linear >=26 & Age.linear <= 35 ~ "26-35",
                            Age.linear >=36 & Age.linear <= 45 ~ "36-45",
                            Age.linear >=46 & Age.linear <= 55 ~ "46-55",
                            Age.linear >=56 & Age.linear <= 65 ~ "56-65",
                            Age.linear >=66 & Age.linear <= 75 ~ "66-75",
                            Age.linear >=76 & Age.linear <= 80 ~ "76+",
                            Age.linear ==-77 ~ "Did not respond"))

```


### Map ethnicity categories

-99: prefer not to say
-88: Dont know
-77: Seen but not answered

White
Mixed or multiple ethnicities
Asian or Asian british
Black or Black british
Arab
Other

```{r recategorise NBR ethnicity}

NBRdemvars <- NBRdemvars %>%
  mutate(Ethnicity = case_when(Ethnicity ==  "A" |
                               Ethnicity ==  "A (White - British)" |
                                 Ethnicity ==  "B" |
                                 Ethnicity == "B (White - Irish)" |
                                 Ethnicity ==  "C" |
                                 Ethnicity == "C (White - Other White)" ~ "White",
                               
                               Ethnicity == "D (Mixed - White and Black Caribbean)" |
                                 Ethnicity ==  "D" |
                                 Ethnicity == "E (Mixed - White and Black African)" |
                                 Ethnicity ==  "E" |
                                 Ethnicity == "F (Mixed - White and Asian)" |
                                 Ethnicity ==  "F" |
                                 Ethnicity == "G (Mixed - Other Mixed)" ~ "Mixed or multiple ethnicities",
                               Ethnicity ==  "G" |
                               Ethnicity == "H (Asian or Asian British - Indian)" |
                                 Ethnicity ==  "H" |
                                 Ethnicity == "J (Asian or Asian British - Pakistani)" |
                                 Ethnicity ==  "J" |
                                 Ethnicity == "K (Asian or Asian British - Bangladeshi)" |
                                 Ethnicity ==  "K" |
                                 Ethnicity == "L (Asian or Asian British - Other Asian)" ~ "Asian or Asian British",
                               Ethnicity ==  "L" |
                               Ethnicity == "M (Black or Black British - Caribbean)" |
                                 Ethnicity ==  "M" |
                                 Ethnicity == "N (Black or Black British - African)" |
                                 Ethnicity ==  "N" |
                                 Ethnicity == "P (Black or Black British - Other Black)" ~ "Black or Black British",
                               Ethnicity ==  "P" |
                               Ethnicity == "R (Other Ethnic - Chinese)" |
                                 Ethnicity ==  "R" |
                               Ethnicity ==  "S" |
                                   Ethnicity == "S (Other Ethnic - Other Ethnic)" ~ "Other",
                               Ethnicity ==  "Z" |
                               Ethnicity == "Z (Not Stated)" ~ "Seen but not answered"))
                                 
   

```

### clean gender other column from blank to labelled

```{r NBR clean gender}
NBRdemvars <- NBRdemvars %>%
  mutate(Gender = case_when(Gender == "Male" ~ "Male",
                            Gender == "Female" ~ "Female",
                            Gender == "" ~ "Did not respond"))
```


#### Create a wave columns in treatment data
Base this on dates of the follow ups drawn from qualtrics.

RAMP
5 waves

1 - May 2020
2 - June 2020
3 - July 2020 (start date actually the last day of June)
4 - September 2020
5 - November 2020

```{r identify wave dates ramp}
setwd(wd)
source("./scripts/RAMPwaves.R")
```

COPING
```{r identify wave dates coping}
setwd(wd)
source("./scripts/COPINGwaves.R")
```
#### drop data before data collection started

Drop Any data collected earleir than June (our first instance of the questionnaire)

```{r drop May dat}

treatRAMP <- treatRAMP %>%
  filter(startDate > as.POSIXct("2020-06-01"))

```


#### select only relevant demographics

```{r demographic select list}
keepcols.cope <- c("externalDataReference","dem.which_gender_do_you_identify_with")
cols.cope <- c("ID","Gender")
keepcols.nbr <- c("subjectid")
cols.nbr <- c("ID")
keepcols.ramp <- c("Login ID","dem2.how_old_are_you","dem2.which_gender_do_you_identify_with","dem2.where_in_the_uk_do_you_live.txt","dem2.what_is_your_ethnic_origin")
cols.ramp <- c("ID","Age","Gender","Postcode","Ethnicity")

names.postcode <- c("ID","Postcode")

```


```{r demographic select}
dem.cope.glad <- demCOPE.glad[names(demCOPE.glad) %in% keepcols.cope]
dem.cope.edgi <- demCOPE.edgi[names(demCOPE.edgi) %in% keepcols.cope]
dem.cope.nbr <- demCOPE.nbr[names(demCOPE.nbr) %in% keepcols.nbr]
dem.ramp <- demRAMP[names(demRAMP) %in% keepcols.ramp]

names(dem.cope.glad) <- cols.cope
names(dem.cope.edgi) <- cols.cope
names(dem.cope.nbr) <- cols.nbr
names(dem.ramp) <- cols.ramp


#names(GLADpostcode) <- names.postcode
#names(EDGIpostcode) <- names.postcode
#names(NBRpostcode) <- names.postcode


```
Clean postcode to keep only outcode for COPING

```{r clean COPING postcodes}

#setwd(wd)
#source("./scripts/clean_COPING_postcode_data.R")

```

Add postcode to COPING

```{r add postcode to coping}

#dem.cope.glad <- left_join(dem.cope.glad,GLADpostcode)
#dem.cope.edgi <- left_join(dem.cope.edgi,EDGIpostcode)
#dem.cope.nbr <- left_join(dem.cope.nbr,NBRpostcode)

```

#### Add extra demographic variables

```{r merge glad/edgi/nbr baseline demographics to their other demographics}

dem.cope.glad <- left_join(dem.cope.glad, GLADdemvars)
dem.cope.edgi <- left_join(dem.cope.edgi, EDGIdemvars)
dem.cope.nbr <- left_join(dem.cope.nbr, NBRdemvars)

```


#### add sample columns 

```{r add sample col}

dem.cope.glad$Sample <-  "COPING"
dem.cope.glad$SampleCOPE <-  "GLAD"
dem.cope.edgi$Sample <- "COPING"
dem.cope.edgi$SampleCOPE <- "EDGI"
dem.cope.nbr$Sample <- "COPING"
dem.cope.nbr$SampleCOPE <- "NBR"
dem.ramp$Sample <- "RAMP"

treatRAMP$Sample <- "RAMP"
treatCOPE$Sample <- "COPING"

```



# Demographics cleaning

## clean age (RAMP)

Age cats:

-77: Seen but not answered
1: 16-18
2: 19-25
3: 26-35
4: 36-45
5: 46-55
6: 56-65
7: 66-70
8: 71-75
9: 76-80
10: 81-85
11: 86-90
12: 91-100
13: 100+

```{r make and label age factors}

dem.ramp <- dem.ramp %>%
  mutate_at(vars(Age),
            list(factor))  %>%
  mutate(AgeAll = fct_recode(Age, 
                                "16-18"="1",
                                "19-25"="2",
                                "26-35"="3",
                                "36-45"="4",
                                "46-55"="5",
                                "56-65"="6",
                                "66-70"="7",
                                "71-75"="8",
                                "76-80"="9",
                                "81-85"="10",
                                "86-90"="11",
                                "91-100"="12",
                                "100+"="13",
                                "Did not respond"="-77"
                                ),
         Age80up = fct_recode(Age, 
                                "16-18"="1",
                                "19-25"="2",
                                "26-35"="3",
                                "36-45"="4",
                                "46-55"="5",
                                "56-65"="6",
                                "66-70"="7",
                                "71-75"="8",
                                "76-80"="9",
                                "81+"="10",
                                "81+"="11",
                                "81+"="12",
                                "81+"="13",
                                "Did not respond"="-77"
                                ),  
         AgeRecoded = fct_recode(Age, 
                                "16-25"="1",
                                "16-25"="2",
                                "26-35"="3",
                                "36-45"="4",
                                "46-55"="5",
                                "56-65"="6",
                                "66-75"="7",
                                "66-75"="8",
                                "76+"="9",
                                "76+"="10",
                                "76+"="11",
                                "76+"="12",
                                "76+"="13",
                                "Did not respond"="-77"
                                ))

```

## Join RAMP, GLAD and EDGI

```{r join ramp, edgi and glad dems}

dem <- merge(dem.ramp,dem.cope.glad, all=TRUE)
dem <- merge(dem,dem.cope.edgi, all=TRUE)

```

## clean ethnicity
Ethnicity:

-99: prefer not to say
-88: Dont know
-77: Seen but not answered
1: White
2: Mixed or multiple ethnicities
3: Asian or Asian british
4: Black or Black british
5: Arab
6 :Other

```{r make and label ethnicity factors}

dem <- dem %>%
  mutate_at(vars(Ethnicity),
            list(factor))  %>%
  mutate(Ethnicity = fct_recode(Ethnicity, 
                                "White"="1",
                                "Mixed or multiple ethnicities"="2",
                                "Asian or Asian British"="3",
                                "Black or Black British"="4",
                                "Arab"="5",
                                "Other"="6",
                                "Prefer not to say"="-99",
                                "Don't know"="-88",
                                "Did not respond"="-77"
                                ))

```



## clean gender
Gender cats:

-99: prefer not to say
-88: Dont know
-77: Seen but not answered
0: Male
1: female
3: Non-binary
4: prefer to self define

```{r make and label gender factors}

dem <- dem %>%
  mutate_at(vars(Gender),
            list(factor))  %>%
  mutate(Gender = fct_recode(Gender, 
                                "Male"="0",
                                "Female"="1",
                                "Non-binary"="2",
                                "Prefer to self define"="3",
                                "Prefer not to say"="-99",
                                "Don't know"="-88",
                                "Did not respond"="-77"
                                ))

```

#### merge demographics with NBR 

```{r demographics merge}

dem <- merge(dem,dem.cope.nbr,all=TRUE)

```


#### get gender and age columns to add to treatment

```{r gender and age from demo}
demgen <- subset(dem,select = c("ID","Gender","AgeRecoded","Sample"))
```


# mental health diagnosis cleaning


rename id columns so they all match

```{r rename mhd id vars}

MHD.RAMP <- MHD.RAMP %>%
  rename(ID="Login ID")

MHD.COPE.nbr <- MHD.COPE.nbr %>%
  rename(ID="subjectid")

MHD.COPE.glad <- MHD.COPE.glad %>%
  rename(ID="externalDataReference")



```

## Identify subset of diagnoses we have for all datasets.

This includes the full range of MH questions we asked in RAMP

```{r rename ramp var names to match COPING}

names(MHD.RAMP) <- sub("mhq","mhd",names(MHD.RAMP))
names(MHD.RAMP) <- sub(".1","",names(MHD.RAMP))


names(MHD.COPE.glad) <- sub(".1","",names(MHD.COPE.glad))
names(MHD.COPE.glad) <- sub(".1","",names(MHD.COPE.glad))



```
Rename EDGI colums to make sure we can compare
```{r rename edgi mental health diagnosis names}

MHD.COPE.edgi <- demCOPE.edgi.baseline
names(MHD.COPE.edgi) <- sub("demographics","mhd",names(MHD.COPE.edgi))
names(MHD.COPE.edgi) <- sub(".1","",names(MHD.COPE.edgi))
names(MHD.COPE.edgi) <- sub("externalDataReference","ID",names(MHD.COPE.edgi))


```

#CLEAN ALL REMAINING MISMATCHING VARIABLES
```{r rename all other mismatching variables}

names(MHD.RAMP) <- sub("mhd.posttraumatic_stress_disorder_ptsd","mhd.ptsd",names(MHD.RAMP))
names(MHD.RAMP) <- sub("mhd.pregnancy_depression","mhd.depression_during_or_after_pregnancy",names(MHD.RAMP))
names(MHD.RAMP) <- sub("mhd.premenstrual_dysphoric_disorder_pmdd","mhd.pmdd",names(MHD.RAMP))
names(MHD.RAMP) <- sub("mhd.specific_phobia_e.g._phobia_of_flying","mhd.specific_phobia",names(MHD.RAMP))
names(MHD.RAMP) <- sub("mhd.body_dysmorphic_disorder_bdd","mhd.bdd",names(MHD.RAMP))
names(MHD.RAMP) <- sub("mhd.skin_picking_obsessive_compulsive","mhd.other_ocd",names(MHD.RAMP))
names(MHD.RAMP) <- sub("mhd.obsessive_compulsive_related_disorder.txt","mhd.other_obsessivecompulsive_related_disorders",names(MHD.RAMP))
names(MHD.RAMP) <- sub("mhd.autism_aspergers_or_autistic_spectrum_disorder","mhd.autism_spectrum_disorder_asd",names(MHD.RAMP))
names(MHD.RAMP) <- sub("mhd.psychological_overeating_or_bingeeating_disorder","mhd.bingeeating_disorder",names(MHD.RAMP))
names(MHD.COPE.edgi) <- sub("mhd.postnatalantenatal_depression","mhd.postnatal_depression",names(MHD.COPE.edgi))

#add columns for questions not asked in order to retain in dataset
MHD.COPE.glad <- MHD.COPE.glad %>%
add_column(mhd.schizoaffective_disorder = NA) 
MHD.COPE.nbr <- MHD.COPE.nbr %>%
add_column(mhd.schizoaffective_disorder = NA) 
MHD.COPE.edgi <- MHD.COPE.edgi %>%
add_column(mhd.schizoaffective_disorder = NA) 

MHD.RAMP <- MHD.RAMP %>%
add_column(mhd.postnatal_depression = NA) 
MHD.RAMP <- MHD.RAMP %>%
add_column(mhd.obsessivecompulsive_disorder = NA) 

```

```{r find column columns}

common_col_names <- intersect(names(MHD.RAMP),names(MHD.COPE.glad))
common_col_names <- intersect(common_col_names,names(MHD.COPE.nbr))

# remove the second personality option which says what specific personality disorder is diagnosed.
common_col_names <- common_col_names[common_col_names != "mhd.personality_disorder_diagnosed"]

```



find intersect with edgi columns

```{r intersect mhd with edgi}
common_col_names_edg <- intersect(common_col_names,names(MHD.COPE.edgi))

```
this shows that the only ones not common are eating disorder categories. makes sense as EDGI is ascertained on the basis of having one. So if we collapse across eating disorders we can assume that all edgi fall into this. Will add EDGI last to achieve this. 


### select the appropriate columns and merge samples


```{r select columns}

MH.RAMP <- MHD.RAMP %>%
  select(all_of(common_col_names)) %>%
  mutate(Sample = "RAMP")

MH.GLAD <- MHD.COPE.glad %>%
  select(all_of(common_col_names)) %>%
  mutate(Sample = "COPING",
         SampleCOPE = "GLAD")

MH.NBR <- MHD.COPE.nbr %>%
  select(all_of(common_col_names)) %>%
  mutate(Sample = "COPING",
         SampleCOPE = "NBR")

```


```{r merge the three datasets}

MH <- merge(MH.RAMP,MH.GLAD,all = "TRUE")
MH <- merge(MH,MH.NBR,all = "TRUE")

```


```{r collapse all eating disorders together and drop the others}

MH <- MH %>%
  mutate(mhd.eating_disorder = case_when(mhd.anorexia_nervosa == 1 |
                                           mhd.atypical_anorexia_nervosa == 1|
                                           mhd.bulimia_nervosa == 1|
                                           mhd.bingeeating_disorder == 1 ~1)) %>%
  select(-c(mhd.anorexia_nervosa,mhd.atypical_anorexia_nervosa,mhd.bulimia_nervosa,mhd.bingeeating_disorder))

```

EDGI all have eating disorders (ascertained for this)
```{r creat eating disorder category for EDGI}

MHD.COPE.edgi$mhd.eating_disorder <- 1

```

adjust common col list for EDGI

```{r adjust common cols for edgi}

common_col_names <- common_col_names[common_col_names != "mhd.anorexia_nervosa"]
common_col_names <- common_col_names[common_col_names != "mhd.atypical_anorexia_nervosa"]
common_col_names <- common_col_names[common_col_names !="mhd.bulimia_nervosa"]
common_col_names <- common_col_names[common_col_names !="mhd.bingeeating_disorder"]


common_col_names <- append(common_col_names,"mhd.eating_disorder")

```

```{r select columns for EDGI}

MH.EDGI <- MHD.COPE.edgi %>%
  select(all_of(common_col_names_edg)) %>%
  mutate(Sample = "COPING",
         SampleCOPE = "EDGI")

```

Merge EDGI onto rest

```{r merge edgi MH to others}

MH <- MH <- merge(MH,MH.EDGI,all = "TRUE")

```

drop start and end date (don't need it as we just need a single point per person)

```{r drop start and end date}

MH <- MH %>%
  select(-c(startDate,endDate)) 

```

```{r collapse other disorder categories}

MH <- MH %>%
  mutate(mhd.depressive_disorder = case_when(mhd.depression == 1|
                                           mhd.depression_during_or_after_pregnancy == 1|
                                           mhd.pmdd == 1|
                                           mhd.postnatal_depression == 1 ~1)) %>%
  select(-c(mhd.depression,mhd.depression_during_or_after_pregnancy,mhd.pmdd,mhd.postnatal_depression))

MH <- MH %>%
  mutate(mhd.anxiety_disorder = case_when(mhd.anxiety_nerves_or_generalised_anxiety_disorder == 1 |
                                           mhd.social_anxiety_or_social_phobia == 1|
                                           mhd.specific_phobia == 1|
                                           mhd.agoraphobia == 1|
                                           mhd.panic_disorder == 1|
                                           mhd.panic_attacks == 1 ~1)) %>%
  select(-c(mhd.anxiety_nerves_or_generalised_anxiety_disorder,mhd.social_anxiety_or_social_phobia,mhd.specific_phobia,mhd.agoraphobia,mhd.panic_disorder,mhd.panic_attacks))

#mhd.obsessivecompulsive_disorder_ocd == 1 |
  
MH <- MH %>%
  mutate(mhd.ocrd = case_when(mhd.obsessivecompulsive_disorder == 1|
                                           mhd.bdd == 1|
                                           mhd.other_ocd == 1|
                                           mhd.other_obsessivecompulsive_related_disorders == 1 ~1)) %>%
  select(-c(mhd.bdd,mhd.other_ocd,mhd.other_obsessivecompulsive_related_disorders,mhd.obsessivecompulsive_disorder))

MH <- MH %>%
  mutate(mhd.psychotic_disorder = case_when(mhd.schizophrenia == 1 |
                                           mhd.schizoaffective_disorder == 1|
                                           mhd.psychosis_type_psychotic_illness == 1 ~1)) %>%
  select(-c(mhd.schizophrenia,mhd.psychosis_type_psychotic_illness,mhd.schizoaffective_disorder,mhd.dont_know,mhd.prefer_not_to_answer))

```



# Rename the treatment variables and drop irrelevant ones

used the [data dictionary](https://docs.google.com/spreadsheets/d/1Vp028XLxbcXeOdjeuI-3y-kVenKWDR4hW9iJ1tHpttI/edit#gid=1527211037) to identify the relevant items and rename them

```{r rename COPE & RAMP datasets and select variables}
setwd(wd)
source("./scripts/renameRAMPtreatment.R")

treatRAMP.fin <- treatRAMP.renamed[names(treatRAMP.renamed) %in% treatnames]
treatCOPE.fin <- treatCOPE.renamed[names(treatCOPE.renamed) %in% treatnames]

```
#### merge RAMP and COPING treatment data

Use rbind to add COPING to RAMP

```{r merge coping and ramp treatment data}

treat_dat <- rbind(treatRAMP.fin,treatCOPE.fin)
  
```

#### order wave variable

```{r reorder wave factor}

treat_dat$wave <- factor(treat_dat$wave,
                         levels = c("May 2020","June 2020", "July 2020","August 2020","September 2020","October 2020","November 2020","December 2020","January 2021","February 2021","March 2021","April 2021", "May 2021", "June 2021"))

```

#### Drop June and January timepoints
```{r drop un-needed timepoints}

treat_dat <- filter(treat_dat,  wave == "July 2020" | wave == "August 2020" | wave == "September 2020" | wave == "October 2020" | wave == "November 2020" | wave == "December 2020"| wave == "December 2020"| wave == "January 2021"| wave == "February 2021"| wave == "March 2021"| wave == "April 2021"| wave == "May 2021" | wave == "June 2021")
```

#### Drop accidental duplicate IDs

these are IDS that were allocated twice by qualtrics. Technical errors. Will drop all instances (we lose 80 IDs doing this)
```{r id  duplicates}

DupIDdat <- treat_dat %>%
  pivot_wider(id_cols = ID,
              names_from = wave,
              values_from = soughthelp_for_self,
              values_fn = length)

dupids <- DupIDdat$ID[( DupIDdat$`July 2020` > 1 |
                        DupIDdat$`August 2020` > 1 | 
                        DupIDdat$`September 2020` > 1 |
                        DupIDdat$`October 2020` > 1 | 
                        DupIDdat$`November 2020` > 1 |
                        DupIDdat$`December 2020` > 1 | 
                        DupIDdat$`January 2021` > 1 |
                        DupIDdat$`February 2021` > 1 |
                        DupIDdat$`March 2021` > 1 |
                        DupIDdat$`April 2021` > 1 |
                        DupIDdat$`May 2021` > 1 |
                        DupIDdat$`June 2021` > 1
                        )]

dupids <- unique(dupids)

```

Now drop from our treatment data

```{r drop dups from treatment}
treat_dat <- treat_dat[(treat_dat$ID %!in% dupids),]
```

#### make seen but not responded NA 

```{r make -77 in treatment seeking NA}

treat_dat$soughthelp_for_self <- ifelse(treat_dat$soughthelp_for_self == -77,NA,treat_dat$soughthelp_for_self)

```

#### Create summary variables for treatment
Grouping variables to make sensible categories for comparing different aspects of treatment seeking


##### Sought help for new or pre-existing MH disorder 

Categorise reasons for help seeking into whether it was for a pre-existing, newly emerging MH disorder or a crisis

```{r dummy reason for help seek variable}

treat_dat <- treat_dat %>%
  mutate(ReasonSeek = case_when(
    reasonhelp_new_mh == 1 ~ "Newly emerging symptoms",
    reasonhelp_cont_mh == 1 | reasonhelp_worsen_mh == 1 | reasonhelp_repeat_prescription == 1 | reasonhelp_change_med == 1 | reasonhelp_alt_support == 1 ~ "Existing mental health",
  reasonhelp_mh_crisis == 1 ~ "Mental health crisis",
  reasonhelp_new_med == 1 ~ "Seeking new treatment",
  reasonhelp_other == 1 ~ "Other"))

treat_dat <- treat_dat %>%
  mutate(
  Reason_Existing_Mh = rowSums(cbind(reasonhelp_cont_mh, reasonhelp_worsen_mh,  reasonhelp_repeat_prescription, reasonhelp_change_med, reasonhelp_alt_support), na.rm = T))

reasonscols = c("reasonhelp_new_mh", "reasonhelp_cont_mh", "reasonhelp_worsen_mh", "reasonhelp_mh_crisis", "reasonhelp_repeat_prescription", "reasonhelp_change_med", "reasonhelp_new_med", "reasonhelp_alt_support", "reasonhelp_other"  )

treat_dat <- treat_dat %>%
  mutate(total_n_reasons = rowSums(treat_dat[names(treat_dat) %in% reasonscols], na.rm = T))

sum(treat_dat$total_n_reasons)
sum(treat_dat$Reason_New_Tx)
sum(treat_dat$Reason_other)

```


##### Type of treatment (supported / self guided)

Categorise places where treatment was sought into supported or self-guided


make Prefer not to say (-77) NA

```{r na for PNS treatment type sought}
treat_dat[grep("wherehelp",names(treat_dat))] <-apply(treat_dat[grep("wherehelp",names(treat_dat))],2,function(x) ifelse(x == -77,NA, x))

treat_dat[grep("reasonhelp",names(treat_dat))] <-apply(treat_dat[grep("reasonhelp",names(treat_dat))],2,function(x) ifelse(x == -77,NA, x))

treat_dat[grep("reasonNo",names(treat_dat))] <-apply(treat_dat[grep("reasonNo",names(treat_dat))],2,function(x) ifelse(x == -77,NA, x))

```



create variable counting number of self guided or supported treatment types sought per wave per person

```{r type sought counts}

supportcols <- c("wherehelp_sought_emergency_mh","wherehelp_sought_online_talk_therapy",
                 "wherehelp_sought_gp","wherehelp_sought_existing_mh_team",
                " wherehelp_received_nonnhs_phone","wherehelp_sought_nhs_111")

selfcols <- c("wherehelp_sought_gov_website","wherehelp_received_selfguide_online",
                 "wherehelp_sought_nongov_website","wherehelp_sought_struc_therapy")


treat_dat$TypeSought.Supported.total <- rowSums(treat_dat[names(treat_dat) %in% supportcols],na.rm = T)
treat_dat$TypeSought.SelfGuided.total <- rowSums(treat_dat[names(treat_dat) %in% selfcols],na.rm = T)

#calculate total sources sought
  treat_dat$TypeSought.All.total <- rowSums(cbind(treat_dat$TypeSought.SelfGuided.total, treat_dat$TypeSought.Supported.total), na.rm = T)

```



```{r dummy treatment not received if sought}

treat_dat  <- treat_dat %>%
  mutate(AnyNoReceipt = case_when(AnyReceived == 0 ~1,
                                  TRUE ~ 0))

```

##### number of agencies from which treatment was received, if sought

```{r type received counts}

supportcols <- c("wherehelp_received_emergency_mh","wherehelp_received_online_talk_therapy","wherehelp_received_gp","wherehelp_received_existing_mh_team","wherehelp_received_nonnhs_phone","wherehelp_received_nhs_111")

selfcols <- c("wherehelp_received_gov_website","wherehelp_received_selfguide_online","wherehelp_received_nongov_website","wherehelp_received_struc_therapy")

othercols <- c("wherehelp_received_other")


soughtcols <- c("wherehelp_sought_emergency_mh", "wherehelp_sought_existing_mh_team", "wherehelp_sought_online_talk_therapy", "wherehelp_sought_gp",  "wherehelp_sought_nhs_111", "wherehelp_sought_nonnhs_phone", "wherehelp_sought_gov_website", "wherehelp_sought_nongov_website",  "wherehelp_sought_selfguide_online", "wherehelp_sought_struc_therapy", 
 "wherehelp_sought_other" )

receivecols <- c("wherehelp_received_emergency_mh","wherehelp_received_online_talk_therapy","wherehelp_received_gp","wherehelp_received_existing_mh_team","wherehelp_received_nonnhs_phone","wherehelp_received_nhs_111","wherehelp_received_gov_website","wherehelp_received_selfguide_online","wherehelp_received_nongov_website","wherehelp_received_struc_therapy","wherehelp_received_other")

reasoncols <- c("preventhelp_emergency_mh", "preventhelp_existing_mh_team", "preventhelp_online_talk_therapy", "preventhelp_gp", "preventhelp_nhs_111", "preventhelp_nonnhs_phone", "preventhelp_gov_website", "preventhelp_nongov_website", "preventhelp_online_self_therapy", "preventhelp_struc_therapy", "preventhelp_other")

helpfulnesscols <- c("treatmenthelpful_emergency_mh", "treatmenthelpful_existing_mh_team", "treatmenthelpful_online_talk_therapy", "treatmenthelpful_gp", "treatmenthelpful_nhs_111", "treatmenthelpful_nonnhs_phone", "treatmenthelpful_gov_website", "treatmenthelpful_nongov_website", "treatmenthelpful_online_self_therapy", "treatmenthelpful_struc_therapy", "treatmenthelpful_other")

treat_dat$TypeReceived.Supported.total <- rowSums(treat_dat[names(treat_dat) %in% supportcols],na.rm = T)
treat_dat$TypeReceived.SelfGuided.total <- rowSums(treat_dat[names(treat_dat) %in% selfcols],na.rm = T)

#calculate total sources received
  treat_dat$TypeReceived.All.total <- rowSums(cbind(treat_dat$TypeReceived.SelfGuided.total, treat_dat$TypeReceived.Supported.total), na.rm = T)
  
#calculate total reasons not received

total_reasons <- treat_dat %>%
  mutate(total_reasons_non_na = sum(!is.na(treat_dat[names(treat_dat) %in% reasoncols])))

#calculate total sought but not received
    treat_dat$SoughtNotReceived.All.total <- (treat_dat$TypeSought.All.total - treat_dat$TypeReceived.All.total)
    
    

```

##### Sought treatment at any time (How many times, how many total responses)

Create a dataset and column that identifies how many times someone sought help, how many times they responded, and if they ever sought help

Making a new dataset where the count by ID is tracked
```{r treatment seek in any wave count}

treat_dat_byID <- treat_dat %>%
  group_by(ID) %>%
  tally(soughthelp_for_self)

treat_dat_byIDSamp <- treat_dat %>%
  group_by(ID,Sample) %>%
  tally(soughthelp_for_self)

```
##### Reason not sought
```{r reason not sought}

reason_not_sought <- tibble(reason = c("Feel fine","Feel better","Not bad enough","Don't think help available","Bad past experience","Didn't know where to find","Too busy","Want to but haven't","Other"),category = c("Mild or no current symptoms","Mild or no current symptoms","Mild or no current symptoms","Systemic","Systemic","Systemic","Client","Client","Other"), n = 1:9)

reason_not_sought[1,3] <- sum(treat_dat$reasonNohelp_feel_fine==1,na.rm=TRUE)
reason_not_sought[2,3] <- sum(treat_dat$reasonNohelp_I_feel_better==1,na.rm=TRUE)
reason_not_sought[3,3] <- sum(treat_dat$reasonNohelp_I_dont_think_I_feel_bad_enough==1,na.rm=TRUE)
reason_not_sought[4,3] <- sum(treat_dat$reasonNohelp_I_want_help_dont_think_its_available==1,na.rm=TRUE)
reason_not_sought[5,3] <- sum(treat_dat$reasonNohelp_Bad_experiences_in_past==1,na.rm=TRUE)
reason_not_sought[6,3] <- sum(treat_dat$reasonNohelp_I_didnt_know_where_to_find==1,na.rm=TRUE)
reason_not_sought[7,3] <- sum(treat_dat$reasonNohelp_Too_busy==1,na.rm=TRUE)
reason_not_sought[8,3] <- sum(treat_dat$reasonNohelp_I_want_to_but_havent==1,na.rm=TRUE)
reason_not_sought[9,3] <- sum(treat_dat$reasonNohelp_other==1,na.rm=TRUE)

```

```{r treatment seek in any wave}

treat_dat_byID$AnySeek <- ifelse(treat_dat_byID$n > 0,"Sought help at least once", "Never sought help")
treat_dat_byIDSamp$AnySeek <- ifelse(treat_dat_byIDSamp$n > 0,"Sought help at least once", "Never sought help")

```

##### Client level vs systemic barriers
identify if treatment was received when sought according to category

```{r run script to relabel and clean treatment help and barrier factors}
setwd(wd)
## factorise and label barrier and helpfulness 
source("./scripts/relabel_barriers_help_factors.R")
```


Identify whether barriers are systemic or client-level
```{r dummy type of barriers, eval = FALSE}
## systemic
treat_dat[grep("prevent",names(treat_dat))] <- apply(treat_dat[grep("prevent",names(treat_dat))], 2, function(x) 
  ifelse(x == "Could not get an appointment","Systemic",x))

treat_dat[grep("prevent",names(treat_dat))] <- apply(treat_dat[grep("prevent",names(treat_dat))], 2, function(x) 
  ifelse(x == "Waiting list was too long","Systemic",x))

treat_dat[grep("prevent",names(treat_dat))] <- apply(treat_dat[grep("prevent",names(treat_dat))], 2, function(x) 
  ifelse(x == "Was assessed and was unable to be offered support","Systemic",x))

treat_dat[grep("prevent",names(treat_dat))] <- apply(treat_dat[grep("prevent",names(treat_dat))], 2, function(x) 
  ifelse(x == "Support option was unavailable when tried to access it","Systemic",x))

## client level
treat_dat[grep("prevent",names(treat_dat))] <- apply(treat_dat[grep("prevent",names(treat_dat))], 2, function(x) 
  ifelse(x == "None of the support options were relevant","Client-level",x))

treat_dat[grep("prevent",names(treat_dat))] <- apply(treat_dat[grep("prevent",names(treat_dat))], 2, function(x) 
  ifelse(x == "Didn't feel well enough to engage","Client-level",x))

treat_dat[grep("prevent",names(treat_dat))] <- apply(treat_dat[grep("prevent",names(treat_dat))], 2, function(x) 
  ifelse(x == "Was too busy to engage","Client-level",x))

treat_dat[grep("prevent",names(treat_dat))] <- apply(treat_dat[grep("prevent",names(treat_dat))], 2, function(x) 
  ifelse(x == "Felt better","Client-level",x))

```

#### group agencies for help prevention into client-led or supported
creates PreventHelp_Supported and PreventHelp_SelfGuided columns

```{r group barrier agencies into client led or supported}
setwd(wd)
source("./scripts/Barriers_column_creation.R")
```

### helpfulness

#### Relabel factors

```{r relabel helpfullness factors}

setwd(wd)
source("./scripts/Relabel_helpful_factors.R")

```
#### group agencies for helpfulness into client led or supported.
Assess helpfulness for both type seperately depending on helpfulness by agency sought

```{r group helpfullness agencies into client led or supported}
setwd(wd)
source("./scripts/Helpfulness_column_creation.R")
```

# Analyses

## Descriptives


### Demographics

Age, ethnicity and gender for those who have responded to at least 1 wave of the treatment survey, dropping duplicates as per treat_dt step


```{r drop all IDS that are not included in our treatment data from the demographics data}

dem <- dem %>%
  filter(dem$ID %in% treat_dat_byID$ID) %>%
  distinct(.)

```


**At the moment this is only keeping 15656 people, when we have 27926 distinct IDs in the treatment data. It is possible this is due to not having demographic info for the NBR sample, but need to check these numbers once NBR is added and look into it if these are still out**


#### check numbers

##### Ethnicity

```{r ethnicity table}

dem %>%
  freq(Ethnicity)

```
By sample
```{r ethnicity by Sample table}

dem %>%
  group_by(Sample) %>%
  freq(Ethnicity)


```
##### Gender

```{r Gender table}

dem %>%
  freq(Gender)

```
By sample
```{r Gender by Sample table}


dem %>%
  group_by(Sample) %>%
  freq(Gender)
```

##### Age (all brackets)


```{r Age table}
dem %>%
  freq(AgeAll)

```

By sample
```{r Age by Sample table}

dem %>%
  group_by(Sample) %>%
  freq(AgeAll)

```


##### Age (81+ collapses)


```{r Age 81+ table}

dem %>%
  freq(Age80up)

```

By sample
```{r Age 81+  by Sample table}

dem %>%
  group_by(Sample) %>%
  freq(Age80up)

```

### Mental health diagnoses

Clean so we match treatment data and dont have duplicates
```{r drop all IDS that are not included in our treatment data from the MHD data}

MH <- MH %>%
  filter(MH$ID %in% treat_dat_byID
         
         $ID) %>%
  distinct(.)

```

List of diagnosis columns

```{r list diagnoses cols}

dia_cols <- c("mhd.depressive_disorder","mhd.anxiety_disorder","mhd.ptsd","mhd.ocrd","mhd.eating_disorder","mhd.mania_hypomania_bipolar_or_manicdepression","mhd.psychotic_disorder","mhd.personality_disorder","mhd.autism_spectrum_disorder_asd","mhd.attention_deficit_hyperactivity_disorder")

```

#### everyone

frequencies for all diagnoses
```{r freq tables for diagnoses,eval=FALSE, echo=FALSE}

for (i in dia_cols){
  print(freq(MH[i]))
}

```


#### By sample
frequencies for all diagnoses
```{r freq tables for diagnoses by sample, eval=FALSE}

for (i in dia_cols){
  print(i)
    print(ctable(MH[,i],MH$Sample))
}

```

## Add gender and age 

Add gender and age to treatment data 

```{r add gender to treat datgender}
treat_dat <- left_join(treat_dat,demgen)
```


### Response rates per wave

```{r response rates per wave}

treat_dat_count <- treat_dat %>%
  group_by(wave, soughthelp_for_self) %>%
  count()

treat_dat_count

```

##### Response rates by gender
```{r response rates per wave by gender}
treat_dat_count_gender <- treat_dat %>%
  filter(Gender == "Male" | Gender == "Female") %>%
  filter(!is.na(soughthelp_for_self)) %>%
  group_by(soughthelp_for_self, Gender) %>%
  count()

treat_dat_count_gender

treat_dat_count_gender <- treat_dat_count_gender %>%
  pivot_wider(id_cols = Gender, names_from = soughthelp_for_self, values_from = n)

treat_dat_count_gender$total <- rowSums(treat_dat_count_gender[,2:3])

treat_dat_count_gender <- treat_dat_count_gender %>%
  mutate(p_sought = `1`/(`0` + `1`)*100,
         p_not_sought = `0`/(`0` + `1`)*100)

treat_dat_count_gender

```

```{r chisq response gender}

tx_seeking_gender_chisq <- chisq.test(treat_dat_count_gender[c(2:3)])
tx_seeking_gender_chisq
tx_seeking_gender_chisq$p.value

```

##### Response rates by age
```{r response rates per wave by gender}
treat_dat_count_age <- treat_dat %>%
  filter(!is.na(soughthelp_for_self)) %>%
  filter(!is.na(AgeRecoded)) %>%
  group_by(soughthelp_for_self, AgeRecoded) %>%
  count()
treat_dat_count_age

treat_dat_count_age <- treat_dat_count_age %>%
  pivot_wider(id_cols = AgeRecoded, names_from = soughthelp_for_self, values_from = n)

treat_dat_count_age$total <- rowSums(treat_dat_count_age[,2:3])

treat_dat_count_age <- treat_dat_count_age %>%
  mutate(p_sought = `1`/(`0` + `1`)*100,
         p_not_sought = `0`/(`0` + `1`)*100)
treat_dat_count_age
```

```{r chisq response agge}

tx_seeking_age_chisq <- chisq.test(treat_dat_count_age[c(2:3)])
tx_seeking_age_chisq
tx_seeking_age_chisq$p.value

```

```{r plot response rates per wave}

treat_dat_count_plot <- treat_dat_count  %>%
  ggplot(mapping = aes(
    x=wave,
    y=n)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = position_dodge2(preserve = "single")
    ) +
  labs(
    x = "Time point",
    y = "Number of participants") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette4
  ) +
  coord_flip()
treat_dat_count_plot


```

By sample
```{r response rates per wave by sample}

treat_dat_count_by_sample <- treat_dat %>%
  group_by(wave,Sample) %>%
  count()
```

###*Plot sample size*
```{r plot response rates per wave per sample}

treat_dat_count_by_sample_plot <- treat_dat_count_by_sample  %>%
  ggplot(mapping = aes(
    x=wave,
    y=n)
    ) +
    geom_bar(aes(fill = Sample),
      stat="identity",
     position = position_dodge2(preserve = "single")
    ) +
  labs(
    x = "Time point",
    y = "Number of participants") +
  theme_personal +
  scale_fill_manual(
    values = COPINGpalette4
  ) +
  coord_flip()
treat_dat_count_by_sample_plot


```
# *order factors*

```{r order factors}

treat_dat$wave <- factor(treat_dat$wave,levels=c("June 2021","May 2021","April 2021","March 2021","February 2021","January 2021","December 2020","November 2020","October 2020","September 2020","August 2020","July 2020"),ordered=TRUE)
  
```

# CREATE LONG DATASET

"wherehelp_sought_emergency_mh"                    
"wherehelp_sought_existing_mh_team"               
"wherehelp_sought_online_talk_therapy" 
"wherehelp_sought_gp"      
"wherehelp_sought_nhs_111" 
"wherehelp_sought_nonnhs_phone" 
"wherehelp_sought_gov_website"  
"wherehelp_sought_nongov_website"
"wherehelp_sought_selfguide_online"                
"wherehelp_sought_struc_therapy" 
"wherehelp_sought_other"   

"wherehelp_received_emergency_mh"                  
"wherehelp_received_existing_mh_team"                           
"wherehelp_received_online_talk_therapy"                                
"wherehelp_received_gp"                                                 
"wherehelp_received_nhs_111"                                           
"wherehelp_received_nonnhs_phone"                                      "wherehelp_received_gov_website"                                      
"wherehelp_received_nongov_website"                 
"wherehelp_received_selfguide_online"                                 "wherehelp_received_struc_therapy"                                    
"wherehelp_received_other"                          

"treatmenthelpful_emergency_mh"                     
"treatmenthelpful_existing_mh_team"                
"treatmenthelpful_online_talk_therapy"              
"treatmenthelpful_gp"                              
"treatmenthelpful_nhs_111"                          
"treatmenthelpful_nonnhs_phone"                    
"treatmenthelpful_gov_website"                      
"treatmenthelpful_nongov_website"                  
"treatmenthelpful_online_self_therapy"              
"treatmenthelpful_struc_therapy"                   
"treatmenthelpful_other"        

### Tx seeking

```{r create long datasets}

seek_long <- treat_dat %>% 
  filter(soughthelp_for_self == 1) %>%
pivot_longer(c(wherehelp_sought_emergency_mh,                    
wherehelp_sought_existing_mh_team,               
wherehelp_sought_online_talk_therapy, 
wherehelp_sought_gp,      
wherehelp_sought_nhs_111, 
wherehelp_sought_nonnhs_phone, 
wherehelp_sought_gov_website,  
wherehelp_sought_nongov_website,
wherehelp_sought_selfguide_online,                
wherehelp_sought_struc_therapy, 
wherehelp_sought_other), names_to = "Type", values_to= "sought")

sum(seek_long$sought, na.rm=T)
```

### Tx receiving

```{r tx receipt}

receive_long <- treat_dat %>% 
  filter(soughthelp_for_self ==1) %>%
pivot_longer(c(wherehelp_received_emergency_mh,                    
wherehelp_received_existing_mh_team,               
wherehelp_received_online_talk_therapy, 
wherehelp_received_gp,      
wherehelp_received_nhs_111, 
wherehelp_received_nonnhs_phone, 
wherehelp_received_gov_website,  
wherehelp_received_nongov_website,
wherehelp_received_selfguide_online,                
wherehelp_received_struc_therapy, 
wherehelp_received_other), names_to = "Type", values_to= "received")

receive_long %>%
  count(received, na.rm=T)

treat_long <- cbind(seek_long,receive_long[,80])

treat_long <- treat_long %>%
  mutate(sought_and_received = 
           case_when(
             sought == 1 & received == 1 ~ 1,
             TRUE ~ 0
           )) %>%
         mutate(sought_not_received = 
                  case_when(
                    sought == 1 & received == 0 ~1,
                    TRUE ~0
                  ))

table(treat_long$sought_and_received)
table(treat_long$sought_not_received)

treat_long %>%
  group_by(Type) %>%
  summarise(n_sought = sum(sought, na.rm = T), n_sought_and_received = sum(sought_and_received, na.rm = T), n_sought_not_received = sum(sought_not_received, na.rm = T), prop_not_received = n_sought_not_received/n_sought*100)

```

### Tx helpfulness

```{r add helpfulness}

helpfulness_long <- treat_dat %>% 
  filter(soughthelp_for_self ==1) %>%
pivot_longer(c(treatmenthelpful_emergency_mh,                    
treatmenthelpful_existing_mh_team,               
treatmenthelpful_online_talk_therapy, 
treatmenthelpful_gp,      
treatmenthelpful_nhs_111, 
treatmenthelpful_nonnhs_phone, 
treatmenthelpful_gov_website,  
treatmenthelpful_nongov_website,
treatmenthelpful_online_self_therapy,                
treatmenthelpful_struc_therapy, 
treatmenthelpful_other), names_to = "Type", values_to= "helpful")
                
helpfulness_long %>%
  count(helpful, na.rm=T)

treat_long <- cbind(treat_long,helpfulness_long[,80])

table(treat_long$helpful)

summary_helpful <- treat_long %>%
  filter(!is.na(helpful)) %>%
  group_by(helpful) %>%
  count(helpful)

total_helpful <- sum(summary_helpful$n)

summary_helpful <- summary_helpful %>%
  mutate(prop_helpful = n / total_helpful*100)
summary_helpful

help_long <- treat_long %>%
  filter(!is.na(helpful)) %>%
  group_by(Type, helpful) %>%
  summarise(n = n())

help_wide <- help_long %>%
  pivot_wider(.,id_cols = Type, names_from = helpful, values_from = n)

help_wide$total <- rowSums(help_wide[2:8])

help_wide_prop <- help_wide %>%
  mutate(`Extremely unhelpful` =  `Extremely unhelpful`/total*100,
         `Very unhelpful` = `Very unhelpful`/total*100,
         `Somewhat unhelpful` = `Somewhat unhelpful`/total*100,
         `Neither helpful nor unhelpful` = `Neither helpful nor unhelpful`/total*100,
         `Somewhat helpful` = `Somewhat helpful`/total*100,
         `Very helpful` = `Very helpful`/total*100,
         `Extremely helpful` = `Extremely helpful`/total*100)
help_wide_prop

```

# categorise by treatment type - virtual

```{r virtual or other, eval = FALSE}

treat_long <- treat_long %>%
  mutate(typeVirtual = case_when(
    Type ==  "wherehelp_sought_emergency_mh" ~ "other service",
    Type ==  "wherehelp_sought_existing_mh_team" ~ "other service",
    Type ==  "wherehelp_sought_online_talk_therapy" ~ "exclusively virtual",
    Type ==  "wherehelp_sought_gp" ~ "other service",
    Type ==  "wherehelp_sought_nhs_111" ~ "exclusively virtual",
    Type ==  "wherehelp_sought_nonnhs_phone" ~ "exclusively virtual",
    Type ==  "wherehelp_sought_gov_website" ~ "exclusively virtual",
    Type ==  "wherehelp_sought_nongov_website" ~ "exclusively virtual",
    Type ==  "wherehelp_sought_selfguide_online" ~ "exclusively virtual",
    Type ==  "wherehelp_sought_struc_therapy" ~ "other",
    Type ==  "wherehelp_sought_other" ~ "other"))


```

### tx seeking

```{r tx seeking virtual}

#treatment seeking by virtual 
treat_long %>%
  group_by(typeVirtual) %>%
  summarise(n_sought = sum(sought, na.rm = T), propsought = n_sought/total_seeking_attempts*100)
  
sum(treat_long$sought, na.rm = T)
```

```{r tx seeking gender}

total_seeking_attempts <- sum(treat_long$sought, na.rm = T) 

gender_seek <- treat_long %>%
  filter(Gender == "Male" | Gender == "Female") %>%
  group_by(Gender) %>%
  summarise(n_sought = sum(sought, na.rm = T), propsought = n_sought/total_seeking_attempts*100)
  gender_seek
  
sum(treat_long$sought, na.rm = T)


```

#### PLOT: tx seeking virtual by wave
```{r tx seeking virtual plot}

tx_seek_virtual_gender <- treat_long %>%
  filter(Gender == "Male" | Gender == "Female") %>%
  group_by(Gender, wave) %>%
  summarise(n_sought = sum(sought, na.rm = T))
tx_seek_virtual_gender

tx_seek_gender_all <- treat_long %>%
    group_by(Gender, wave) %>%
  summarise(n_sought = sum(sought, na.rm = T))
tx_seek_gender_all

```

##### - A) count virtual*wave
```{r}
tx_seek_virtual_wave %>% 
  ggplot(mapping = aes(wave, n_sought, fill = typeVirtual)) +
  geom_bar(aes(),
           stat = "identity",
           position = "dodge") +
  coord_flip() +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Wave",  y = "Treatment sought (N)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm"))
```

##### - B) proportion gender*type
```{r}

tx_seek_gender_type <- treat_long %>%
  filter(Gender == "Male" | Gender == "Female") %>%
  group_by(Gender, Type) %>%
  summarise(n_sought = sum(sought, na.rm = T))
tx_seek_gender_type

tx_seek_gender_type_n <- tx_seek_gender_type %>%
  pivot_wider(., id_cols = Gender, names_from = Type, values_from = n_sought )

tx_seek_gender_type_n$total <- rowSums(tx_seek_gender_type_n[2:11])

tx_seek_chisq <- chisq.test(tx_seek_gender_type_n[,2:11])
tx_seek_chisq$expected

chisq.test(tx_seek_gender_type_n[,2:11])

tx_seek_gender_type_prop <- tx_seek_gender_type_n %>%
  mutate(
    wherehelp_sought_emergency_mh =  wherehelp_sought_emergency_mh/total*100,
    wherehelp_sought_existing_mh_team =  wherehelp_sought_existing_mh_team/total*100,
    wherehelp_sought_gov_website =  wherehelp_sought_gov_website/total*100,
    wherehelp_sought_gp =  wherehelp_sought_gp/total*100,
    wherehelp_sought_nhs_111 =  wherehelp_sought_nhs_111/total*100,
    wherehelp_sought_nongov_website =  wherehelp_sought_nongov_website/total*100,
    wherehelp_sought_nonnhs_phone =  wherehelp_sought_nonnhs_phone/total*100,
    wherehelp_sought_online_talk_therapy =  wherehelp_sought_online_talk_therapy/total*100,
    wherehelp_sought_other =  wherehelp_sought_other/total*100,
    wherehelp_sought_selfguide_online =  wherehelp_sought_selfguide_online/total*100,
    wherehelp_sought_struc_therapy =  wherehelp_sought_struc_therapy/total*100
         )
tx_seek_gender_type_prop


```

##### - B) proportion age*type
```{r}

tx_seek_age_type <- treat_long %>%
  filter(!is.na(AgeRecoded)) %>%
  group_by(AgeRecoded, Type) %>%
  summarise(n_sought = sum(sought, na.rm = T))
tx_seek_age_type

tx_seek_age_type_n <- tx_seek_age_type %>%
  pivot_wider(., id_cols = AgeRecoded, names_from = Type, values_from = n_sought )

tx_seek_age_type_n$total <- rowSums(tx_seek_age_type_n[2:11])

tx_seek_chisq <- chisq.test(tx_seek_age_type_n[,2:11])
tx_seek_chisq
tx_seek_chisq$expected

tx_seek_age_type_prop <- tx_seek_age_type_n %>%
  mutate(
    wherehelp_sought_emergency_mh =  wherehelp_sought_emergency_mh/total*100,
    wherehelp_sought_existing_mh_team =  wherehelp_sought_existing_mh_team/total*100,
    wherehelp_sought_gov_website =  wherehelp_sought_gov_website/total*100,
    wherehelp_sought_gp =  wherehelp_sought_gp/total*100,
    wherehelp_sought_nhs_111 =  wherehelp_sought_nhs_111/total*100,
    wherehelp_sought_nongov_website =  wherehelp_sought_nongov_website/total*100,
    wherehelp_sought_nonnhs_phone =  wherehelp_sought_nonnhs_phone/total*100,
    wherehelp_sought_online_talk_therapy =  wherehelp_sought_online_talk_therapy/total*100,
    wherehelp_sought_other =  wherehelp_sought_other/total*100,
    wherehelp_sought_selfguide_online =  wherehelp_sought_selfguide_online/total*100,
    wherehelp_sought_struc_therapy =  wherehelp_sought_struc_therapy/total*100
         )
tx_seek_age_type_prop


```

##### - C) count all types*wave
```{r}

tx_seek_wave_all %>% 
  ggplot(mapping = aes(wave, n_sought, fill = Type)) +
  geom_bar(aes(),
           stat = "identity",
           position = "dodge") +
  coord_flip() +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Wave",  y = "Treatment sought (N") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm"))
```

##### - D) proportion main types*wave
```{r}
tx_seek_wave_prop <- tx_seek_wave %>%
  pivot_wider(., id_cols = wave, names_from = Type, values_from = n_sought )

tx_seek_wave_prop$total <- rowSums(tx_seek_wave_prop[2:6])

tx_seek_wave_prop <- tx_seek_wave_prop %>%
  mutate(
    wherehelp_sought_emergency_mh =  wherehelp_sought_emergency_mh/total*100,
    wherehelp_sought_existing_mh_team =  wherehelp_sought_existing_mh_team/total*100,
    wherehelp_sought_gp =  wherehelp_sought_gp/total*100,
    wherehelp_sought_online_talk_therapy =  wherehelp_sought_online_talk_therapy/total*100,
    wherehelp_sought_selfguide_online =  wherehelp_sought_selfguide_online/total*100
         )
tx_seek_wave_prop

tx_seek_wave_prop_long <- tx_seek_wave_prop %>%
  pivot_longer(c(wherehelp_sought_emergency_mh:wherehelp_sought_selfguide_online), names_to = "Type", values_to = "percent")
  

tx_seek_wave_prop_long %>% 
  ggplot(mapping = aes(wave, percent, fill = Type)) +
  geom_bar(aes(),
           stat = "identity",
           position = "stack") +
  coord_flip() +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Wave",  y = "Treatment sought (N") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm"))


```




##### - E) proportion all types - pie
```{r}
tx_seek_wave_prop_all <- tx_seek_wave_all %>%
  pivot_wider(., id_cols = wave, names_from = Type, values_from = n_sought )

tx_seek_wave_prop_all$total <- rowSums(tx_seek_wave_prop_all[2:12])

tx_seek_wave_prop_all <- tx_seek_wave_prop_all %>%
  mutate(
    wherehelp_sought_emergency_mh =  wherehelp_sought_emergency_mh/total*100,
    wherehelp_sought_existing_mh_team =  wherehelp_sought_existing_mh_team/total*100,
    wherehelp_sought_gp =  wherehelp_sought_gp/total*100,
    wherehelp_sought_online_talk_therapy =  wherehelp_sought_online_talk_therapy/total*100,
    wherehelp_sought_selfguide_online =  wherehelp_sought_selfguide_online/total*100,
    wherehelp_sought_gov_website =  wherehelp_sought_gov_website/total*100,
    wherehelp_sought_nhs_111 =  wherehelp_sought_nhs_111/total*100,
    wherehelp_sought_nongov_website =  wherehelp_sought_nongov_website/total*100,
    wherehelp_sought_nonnhs_phone =  wherehelp_sought_nonnhs_phone/total*100,
    wherehelp_sought_other =  wherehelp_sought_other/total*100,
    wherehelp_sought_struc_therapy =  wherehelp_sought_struc_therapy/total*100
         )
tx_seek_wave_prop_all

tx_seek_wave_prop_all_long <- tx_seek_wave_prop_all %>%
  pivot_longer(c(wherehelp_sought_emergency_mh:wherehelp_sought_struc_therapy), names_to = "Type", values_to = "percent") %>%
  group_by(Type) %>%
  summarise(percent = mean(percent))

tx_seek_wave_prop_all_long <- tx_seek_wave_prop_all_long[order(tx_seek_wave_prop_all_long$percent),]

tx_seek_wave_prop_all_long <- tx_seek_wave_prop_all_long %>%
  mutate(Type = case_when(
    Type == "wherehelp_sought_nhs_111" ~ "NHS 111",
    Type == "wherehelp_sought_selfguide_online" ~ "Online Self-guided",
    Type == "wherehelp_sought_emergency_mh" ~ "Emergency MH team",
    Type == "wherehelp_sought_nonnhs_phone" ~ "Non-NHS phone line",
    Type == "wherehelp_sought_other" ~ "Other",
    Type == "wherehelp_sought_gov_website" ~ "Government website",
    Type == "wherehelp_sought_nongov_website" ~ "Non-government website",
    Type == "wherehelp_sought_struc_therapy" ~ "Structured therapeutic activity",
    Type == "wherehelp_sought_online_talk_therapy" ~ "Online talk therapy",
    Type == "wherehelp_sought_existing_mh_team" ~ "Existing MH team",
    Type == "wherehelp_sought_gp" ~ "GP"
  ))


tx_seek_wave_prop_all_long$Type <- factor(tx_seek_wave_prop_all_long$Type, levels = c("NHS 111","Online Self-guided", "Emergency MH team", "Non-NHS phone line", "Other", "Government website", "Non-government website", "Structured therapeutic activity", "Online talk therapy", "Existing MH team", "GP"), ordered = TRUE)

#positions for labels
labels_tx_seek_wave_prop_all_long <- tx_seek_wave_prop_all_long %>%  mutate(csum = rev(cumsum(rev(percent))), 
         pos = percent/2 + lead(csum, 1),
         pos = if_else(is.na(pos), percent/2, pos))

tx_type_pie <- tx_seek_wave_prop_all_long %>%
  ggplot() +
  geom_bar(width = 1, aes(x="", y=percent, fill = Type), stat = "identity") +
 #     scale_fill_manual(values = COPINGpalette4) +
  coord_polar("y",start=0) +
  theme_void() +
  labs( fill = "Treatment type") +
  geom_label_repel(data = labels_tx_seek_wave_prop_all_long,
                            aes(x = "", y = pos, label = paste0(round(percent,0),"%")),
                   size = 4.5,
                   nudge_x = 1,
    show.legend = FALSE) +
  scale_linetype_manual(
                           guide = guide_legend(reverse = TRUE) )
tx_type_pie


```

### tx gap virtual

```{r tx gap virtual}

#treatment gap by virtual
tx_gap_virtual <- treat_long %>%
  group_by(typeVirtual) %>%
  summarise(n_sought = sum(sought, na.rm = T), n_sought_and_received = sum(sought_and_received, na.rm = T), n_sought_not_received = sum(sought_not_received, na.rm = T), prop_not_received = n_sought_not_received/n_sought*100)
tx_gap_virtual

tx_gap_virtual_chisq <- chisq.test(tx_gap_virtual[c(3:4)])
tx_gap_virtual_chisq
tx_gap_virtual_chisq$p.value
```


#### PLOT: tx gap virtual by wave

##### - A) Treatment gap virtual*wave
```{r plot treatment gap virtual}

tx_gap_virtual_wave <- treat_long %>%
  filter(typeVirtual != "other") %>%
  group_by(typeVirtual, wave) %>%
  summarise(n_sought = sum(sought, na.rm = T), n_sought_and_received = sum(sought_and_received, na.rm = T), n_sought_not_received = sum(sought_not_received, na.rm = T), prop_not_received = n_sought_not_received/n_sought*100)
tx_gap_virtual_wave



tx_gap_virtual_wave %>% 
  ggplot(mapping = aes(wave, prop_not_received, fill = typeVirtual)) +
  geom_bar(aes(),
           stat = "identity",
           position = "dodge") +
  coord_flip() +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Wave",  y = "Treatment sought but not received (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm"))
```

tx_gap_wave_summary <- treat_long %>%
  group_by(wave) %>%
  summarise(n_sought = sum(sought, na.rm = T), n_sought_and_received = sum(sought_and_received, na.rm = T), n_sought_not_received = sum(sought_not_received, na.rm = T), prop_not_received = n_sought_not_received/n_sought*100)
tx_gap_wave_summary


##### - B) Treatment gap all types*gender



```{r }

tx_gap_gender_main <- treat_long %>%
 filter(Gender == "Male" | Gender == "Female") %>%
  group_by(Gender) %>%
  summarise(n_sought = sum(sought, na.rm = T), n_sought_and_received = sum(sought_and_received, na.rm = T), n_sought_not_received = sum(sought_not_received, na.rm = T), prop_not_received = n_sought_not_received/n_sought*100, prop_received = n_sought_and_received/n_sought*100)
tx_gap_gender_main

chisq.test(tx_gap_gender_main[,3:4])

tx_gap_gender <- treat_long %>%
 filter(Gender == "Male" | Gender == "Female") %>%
  group_by(Gender, Type) %>%
  summarise(n_sought = sum(sought, na.rm = T), n_sought_and_received = sum(sought_and_received, na.rm = T), n_sought_not_received = sum(sought_not_received, na.rm = T), prop_not_received = n_sought_not_received/n_sought*100)
tx_gap_gender

tx_gap_gender_wide_n <- tx_gap_gender %>%
  pivot_wider(id_cols = Gender, names_from = Type, values_from = n_sought_not_received)
tx_gap_gender_wide_n

chisq.test(tx_gap_gender_wide_n[-1])

tx_gap_gender_wide_prop <- tx_gap_gender %>%
  pivot_wider(id_cols = Gender, names_from = Type, values_from = prop_not_received)
tx_gap_gender_wide_prop

chisq.test(tx_gap_gender_wide_prop[-1])



```

##### - B) Treatment gap all types*age



```{r }

tx_gap_age_main <- treat_long %>%
 filter(!is.na(AgeRecoded)) %>%
  group_by(AgeRecoded) %>%
  summarise(n_sought = sum(sought, na.rm = T), n_sought_and_received = sum(sought_and_received, na.rm = T), n_sought_not_received = sum(sought_not_received, na.rm = T), prop_not_received = n_sought_not_received/n_sought*100, prop_received = n_sought_and_received/n_sought*100)
tx_gap_age_main

chisq.test(tx_gap_age_main[,3:4])

tx_gap_age <- treat_long %>%
 filter(!is.na(AgeRecoded)) %>%
  group_by(AgeRecoded, Type) %>%
  summarise(n_sought = sum(sought, na.rm = T), n_sought_and_received = sum(sought_and_received, na.rm = T), n_sought_not_received = sum(sought_not_received, na.rm = T), prop_not_received = n_sought_not_received/n_sought*100)
tx_gap_age

tx_gap_age_wide_n <- tx_gap_age %>%
  pivot_wider(id_cols = AgeRecoded, names_from = Type, values_from = n_sought_not_received)
tx_gap_age_wide_n

chisq.test(tx_gap_age_wide_n[-1])

tx_gap_age_wide_prop <- tx_gap_age %>%
  pivot_wider(id_cols = AgeRecoded, names_from = Type, values_from = prop_not_received)
tx_gap_age_wide_prop

chisq.test(tx_gap_gender_wide_prop[-1])



```

##### - C) Treatment gap main types*wave
```{r }

tx_gap_wave_main <- treat_long %>%
  filter(typeVirtual != "other") %>%
  filter(Type != "wherehelp_sought_gov_website") %>%
  filter(Type != "wherehelp_sought_nhs_111") %>%
  filter(Type != "wherehelp_sought_nongov_website") %>%
  filter(Type != "wherehelp_sought_nonnhs_phone") %>%
  group_by(Type, wave) %>%
  summarise(n_sought = sum(sought, na.rm = T), n_sought_and_received = sum(sought_and_received, na.rm = T), n_sought_not_received = sum(sought_not_received, na.rm = T), prop_not_received = n_sought_not_received/n_sought*100)
tx_gap_wave_main

tx_gap_wave_main %>% 
  ggplot(mapping = aes(wave, prop_not_received, fill = Type)) +
  geom_bar(aes(),
           stat = "identity",
           position = "dodge") +
  coord_flip() +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Wave",  y = "Percent (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm"))

```

##### - D) Treatment gap all types
```{r }

tx_gap <- treat_long %>%
  group_by(Type) %>%
  summarise(n_sought = sum(sought, na.rm = T), n_sought_and_received = sum(sought_and_received, na.rm = T), n_sought_not_received = sum(sought_not_received, na.rm = T), prop_not_received = n_sought_not_received/n_sought*100)
tx_gap

tx_gap %>% 
  ggplot(mapping = aes(Type, prop_not_received, fill = Type)) +
  geom_bar(aes(),
           stat = "identity",
           position = "dodge") +
  coord_flip() +
 theme(legend.position = "none", legend.title = element_blank())  +
  labs(x = "treatment type",  y = "Percent treatment gap (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm"))

```

##### - E) Treatment gap main types
```{r }

tx_gap_main <- treat_long %>%
  filter(typeVirtual != "other") %>%
  filter(Type != "wherehelp_sought_gov_website") %>%
  filter(Type != "wherehelp_sought_nhs_111") %>%
  filter(Type != "wherehelp_sought_nongov_website") %>%
  filter(Type != "wherehelp_sought_nonnhs_phone") %>%
  group_by(Type) %>%
  summarise(n_sought = sum(sought, na.rm = T), n_sought_and_received = sum(sought_and_received, na.rm = T), n_sought_not_received = sum(sought_not_received, na.rm = T), prop_not_received = n_sought_not_received/n_sought*100)
tx_gap_main

tx_gap_main %>% 
  ggplot(mapping = aes(Type, prop_not_received, fill = Type)) +
  geom_bar(aes(),
           stat = "identity",
           position = "dodge") +
  coord_flip() +
 theme(legend.position = "none", legend.title = element_blank())  +
  labs(x = "Treatment type",  y = "Percent treatment gap (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm"))

```

### tx helpfulness virtual
```{r tx helpfulness virtual}
#helpfulness

help_long_virtual <- treat_long %>%
  filter(!is.na(helpful)) %>%
  group_by(typeVirtual, helpful) %>%
  summarise(n = n())

help_wide_virtual <- help_long_virtual %>%
  pivot_wider(.,id_cols = typeVirtual, names_from = helpful, values_from = n)

help_wide_virtual$total <- rowSums(help_wide_virtual[2:8])

help_wide_virtual_prop <- help_wide_virtual %>%
  mutate(`Extremely unhelpful` =  `Extremely unhelpful`/total*100,
         `Very unhelpful` = `Very unhelpful`/total*100,
         `Somewhat unhelpful` = `Somewhat unhelpful`/total*100,
         `Neither helpful nor unhelpful` = `Neither helpful nor unhelpful`/total*100,
         `Somewhat helpful` = `Somewhat helpful`/total*100,
         `Very helpful` = `Very helpful`/total*100,
         `Extremely helpful` = `Extremely helpful`/total*100)
help_wide_virtual_prop

helpful_virtual_chisq <- chisq.test(help_wide_virtual[c(2:8)])
helpful_virtual_chisq
helpful_virtual_chisq$p.value

```

#### PLOT: helpfulness
##### - A) Treatment helpfulness*virtual
```{r}


help_long_virtual_prop <- 
  help_wide_virtual_prop %>%
  pivot_longer(c(`Extremely unhelpful`:`Extremely helpful`), names_to = "Helpfulness", values_to= "Percent")

help_long_virtual_prop$Helpfulness <- factor(help_long_virtual_prop$Helpfulness,levels=c("Extremely unhelpful", "Very unhelpful", "Somewhat unhelpful", "Neither helpful nor unhelpful", "Somewhat helpful","Very helpful","Extremely helpful"),ordered=TRUE)

help_long_virtual_prop$Helpfulness <- fct_rev(help_long_virtual_prop$Helpfulness)

help_long_virtual_prop %>% 
  filter(typeVirtual != "other") %>%
  ggplot(mapping = aes(typeVirtual, Percent, fill = Helpfulness)) +
  geom_bar(aes(),
           stat = "identity",
           position = "stack") +
 theme(legend.position = "top", legend.title = element_blank())  +
  labs(x = "Treatment type",  y = "Percent treatment gap (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  scale_fill_manual(values = RAMPlikertpalette) +
  theme(legend.key.size = unit(.25, "cm"))

```

help_long_all<- treat_long %>%
  filter(!is.na(helpful)) %>%
  group_by(Type) %>%
  group_by(Type, helpful) %>%
  summarise(n = n())
  
  
  help_wide_all <- help_long_all %>%
  pivot_wider(.,id_cols = Type, names_from = helpful, values_from = n)

help_wide_all$total <- rowSums(help_wide_all[2:8])

help_wide_all_prop <- help_wide_all %>%
  mutate(`Extremely unhelpful` =  `Extremely unhelpful`/total*100,
         `Very unhelpful` = `Very unhelpful`/total*100,
         `Somewhat unhelpful` = `Somewhat unhelpful`/total*100,
         `Neither helpful nor unhelpful` = `Neither helpful nor unhelpful`/total*100,
         `Somewhat helpful` = `Somewhat helpful`/total*100,
         `Very helpful` = `Very helpful`/total*100,
         `Extremely helpful` = `Extremely helpful`/total*100)
help_wide_all_prop

##### - B) Treatment helpfulness*main
```{r}

help_long_main <- treat_long %>%
  filter(!is.na(helpful)) %>%
  filter(typeVirtual != "other") %>%
  filter(Type != "wherehelp_sought_gov_website") %>%
  filter(Type != "wherehelp_sought_nhs_111") %>%
  filter(Type != "wherehelp_sought_nongov_website") %>%
  filter(Type != "wherehelp_sought_nonnhs_phone") %>%
  group_by(Type) %>%
  group_by(Type, helpful) %>%
  summarise(n = n())

help_wide_main <- help_long_main %>%
  pivot_wider(.,id_cols = Type, names_from = helpful, values_from = n)

help_wide_main$total <- rowSums(help_wide_main[2:8])

help_wide_main_prop <- help_wide_main %>%
  mutate(`Extremely unhelpful` =  `Extremely unhelpful`/total*100,
         `Very unhelpful` = `Very unhelpful`/total*100,
         `Somewhat unhelpful` = `Somewhat unhelpful`/total*100,
         `Neither helpful nor unhelpful` = `Neither helpful nor unhelpful`/total*100,
         `Somewhat helpful` = `Somewhat helpful`/total*100,
         `Very helpful` = `Very helpful`/total*100,
         `Extremely helpful` = `Extremely helpful`/total*100)
help_wide_main_prop

help_long_main_prop <- 
  help_wide_main_prop %>%
  pivot_longer(c(`Extremely unhelpful`:`Extremely helpful`), names_to = "Helpfulness", values_to= "Percent")

help_long_main_prop$Helpfulness <- factor(help_long_main_prop$Helpfulness,levels=c("Extremely unhelpful", "Very unhelpful", "Somewhat unhelpful", "Neither helpful nor unhelpful", "Somewhat helpful","Very helpful","Extremely helpful"),ordered=TRUE)

help_long_main_prop$Helpfulness <- fct_rev(help_long_main_prop$Helpfulness)

help_long_main_prop %>% 
  ggplot(mapping = aes(Type, Percent, fill = Helpfulness)) +
  geom_bar(aes(),
           stat = "identity",
           position = "stack",
           color = "black") +
 theme(legend.position = "top", legend.title = element_blank())  +
  labs(x = "Treatment type",  y = "Percent treatment gap (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = RAMPlikertpalette) +
  theme(legend.key.size = unit(.25, "cm"))

```

# CREATE REASONS DATASET

"reasonhelp_new_mh"                                
"reasonhelp_cont_mh"                                
"reasonhelp_worsen_mh"                             
"reasonhelp_mh_crisis"                              
"reasonhelp_repeat_prescription"                   
"reasonhelp_change_med"                             
"reasonhelp_new_med"                               
"reasonhelp_alt_support"                            
"reasonhelp_other"                                 


```{r create long datasets}

reasons_long <- treat_long %>% 
  filter(sought == 1) %>%
  pivot_longer(c(reasonhelp_new_mh:reasonhelp_other), names_to = "Reason", values_to= "reason_given")

total_reasons <- sum(reasons_long$reason_given, na.rm=T)
total_reasons

table(reasons_long$reason_given)

```

## summary all reasons sought

```{r total reasons}
summary_reasons <- reasons_long %>%
  group_by(Reason) %>%
  summarise(n = sum(reason_given, na.rm = T), prop = n/total_reasons*100)
summary_reasons
```

```{r total reasons by wave}
summary_reasons_wave <- reasons_long %>%
  group_by(wave, Reason) %>%
  summarise(n = sum(reason_given, na.rm = T), prop = n/total_reasons*100)
summary_reasons_wave

```

## summary recategorise reasons

```{r recategorise reasons}
reasons_long <- reasons_long %>%
  mutate(Reason_cat = case_when(
    Reason == "reasonhelp_new_mh" ~ "Newly emerging symptoms", 
    Reason == "reasonhelp_cont_mh" ~ "Existing mental health", 
    Reason == "reasonhelp_worsen_mh" ~ "Existing mental health", 
    Reason == "reasonhelp_mh_crisis" ~ "Mental health crisis", 
    Reason == "reasonhelp_repeat_prescription" ~ "Existing mental health", 
    Reason == "reasonhelp_change_med" ~ "Existing mental health", 
    Reason == "reasonhelp_new_med" ~ "Seeking new treatment", 
    Reason == "reasonhelp_alt_support" ~ "Existing mental health", 
    Reason == "reasonhelp_other" ~ "Other"))

summary_reasons_cat <- reasons_long %>%
  group_by(Reason_cat) %>%
  summarise(n = sum(reason_given, na.rm = T), prop = n/total_reasons*100)
summary_reasons_cat

summary_reasons_cat_wave <- reasons_long %>%
  group_by(Reason_cat, wave) %>%
  summarise(n = sum(reason_given, na.rm = T))
summary_reasons_cat_wave

summary_reasons_cat_wave_wide <- summary_reasons_cat_wave %>%
  pivot_wider(.,id_cols = wave, names_from = Reason_cat, values_from = n)

summary_reasons_cat_wave_wide$total <- rowSums(summary_reasons_cat_wave_wide[2:6])

summary_reasons_cat_wave_wide_prop <- summary_reasons_cat_wave_wide %>%
  mutate(`Existing mental health` =  `Existing mental health`/total*100,
         `Mental health crisis` = `Mental health crisis`/total*100,
         `Newly emerging symptoms` = `Newly emerging symptoms`/total*100,
         `Other` = `Other`/total*100,
         `Seeking new treatment` = `Seeking new treatment`/total*100,)
summary_reasons_cat_wave_wide_prop


```

##### PLOT: reasons sought by month

```{r}

summary_reasons_cat_wave_long_prop <- 
  summary_reasons_cat_wave_wide_prop %>%
  pivot_longer(c(`Existing mental health`:`Seeking new treatment`), names_to = "Reason", values_to= "Percent")

summary_reasons_cat_wave_long_prop$Reason <- factor(summary_reasons_cat_wave_long_prop$Reason,levels=c("Existing mental health", "Mental health crisis", "Newly emerging symptoms", "Seeking new treatment", "Other"),ordered=TRUE)

summary_reasons_cat_wave_long_prop$Reason <- fct_rev(summary_reasons_cat_wave_long_prop$Reason)

summary_reasons_cat_wave_long_prop %>%
  ggplot(mapping = aes(wave, Percent, fill = Reason)) +
  geom_bar(aes(),
           stat = "identity",
           position = "stack") +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Wave",  y = "Percent reason for seeking (%)") +
  coord_flip() +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  scale_fill_manual(values = rev(COPINGpalette5)) +
  theme(legend.key.size = unit(.25, "cm"))

```

## summary reasons sought by treatment type (virtual)

```{r reasons by treatment type}

summary_reasons_cat_virtual <- reasons_long %>%
  group_by(Reason_cat, typeVirtual) %>%
  summarise(n = sum(reason_given, na.rm = T))
summary_reasons_cat_virtual

summary_reasons_cat_virtual_wide <- summary_reasons_cat_virtual %>%
  pivot_wider(.,id_cols = typeVirtual, names_from = Reason_cat, values_from = n)
summary_reasons_cat_virtual_wide

summary_reasons_cat_virtual_wide$total <- rowSums(summary_reasons_cat_virtual_wide[2:6])

summary_reasons_cat_virtual_wide_prop <- summary_reasons_cat_virtual_wide %>%
  mutate(`Existing mental health` =  `Existing mental health`/total*100,
         `Mental health crisis` = `Mental health crisis`/total*100,
         `Newly emerging symptoms` = `Newly emerging symptoms`/total*100,
         `Other` = `Other`/total*100,
         `Seeking new treatment` = `Seeking new treatment`/total*100,)
summary_reasons_cat_virtual_wide_prop


```

# CREATE REASONS NOT RECEIVED DATASET

"preventhelp_emergency_mh"                         
"preventhelp_existing_mh_team"                      
"preventhelp_online_talk_therapy"                  
"preventhelp_gp"                                    
"preventhelp_nhs_111"                              
"preventhelp_nonnhs_phone"                          
"preventhelp_gov_website"                          
"preventhelp_nongov_website"                        
"preventhelp_online_self_therapy"                  
"preventhelp_struc_therapy"                         
"preventhelp_other"   

```{r create long reasons not received dataset}

reasons_not_received_long <- treat_dat %>% 
  filter(soughthelp_for_self == 1) %>%
  pivot_longer(c(preventhelp_emergency_mh:preventhelp_other), names_to = "Type", values_to= "reason_given")

total_reasons_not <- sum(reasons_not_received_long$reason_given, na.rm=T)
total_reasons_not

table(reasons_not_received_long$reason_given)

```

## summary reasons not received

```{r reasons not received - all}
summary_not_received <- reasons_not_received_long %>%
  filter(!is.na(reason_given)) %>%
  group_by(reason_given) %>%
  count(reason_given)

total_not_received <- sum(summary_not_received$n)

summary_not_received <- summary_not_received %>%
  mutate(prop_not_received = n / total_not_received*100)
summary_not_received

summary_not_received_type <- reasons_not_received_long %>%
  filter(!is.na(reason_given)) %>%
  group_by(Type, reason_given) %>%
  count(reason_given)

not_received_wide <- summary_not_received_type %>%
  pivot_wider(.,id_cols = Type, names_from = reason_given, values_from = n)

not_received_wide$total <- rowSums(not_received_wide[2:9])

not_received_wide_prop <- not_received_wide %>%
  mutate(`Could not get an appointment` =  `Could not get an appointment`/total*100,
         `Waiting list was too long` =  `Waiting list was too long`/total*100,
         `Was assessed and was unable to be offered support` =  `Was assessed and was unable to be offered support`/total*100,
         `None of the support options were relevant` =  `None of the support options were relevant`/total*100,
         `Support option was unavailable when tried to access it` =  `Support option was unavailable when tried to access it`/total*100,
         `Didn't feel well enough to engage` =  `Didn't feel well enough to engage`/total*100,
         `Was too busy to engage` =  `Was too busy to engage`/total*100,
         `Felt better` =  `Felt better`/total*100,
         `Other` =  `Other`/total*100
         )
not_received_wide_prop
```

#### PLOT: reasons not received

##### - A) resons not received*gender
```{r}

reasons_not_gender <- reasons_not_received_long %>%
  filter(Gender == "Male" | Gender == "Female") %>%
  filter(!is.na(reason_given)) %>%
  group_by(Gender, reason_given) %>%
  summarise(n = n())
reasons_not_gender  

reasons_not_gender_wide <- reasons_not_gender %>%
  pivot_wider(id_cols = Gender, names_from = reason_given, values_from = n)
reasons_not_gender_wide

reasons_not_gender_wide$total <- rowSums(reasons_not_gender_wide[-1])

reasons_not_gender_chisq <- chisq.test(reasons_not_gender_wide[2:10])
reasons_not_gender_chisq
reasons_not_gender_chisq$residuals

reasons_not_gender_wide_prop <- reasons_not_gender_wide %>%
  mutate(
    `Could not get an appointment` = `Could not get an appointment`/total*100,
    `Waiting list was too long` = `Waiting list was too long`/total*100,
    `Was assessed and was unable to be offered support` = `Was assessed and was unable to be offered support`/total*100,
    `None of the support options were relevant` = `None of the support options were relevant`/total*100,
    `Support option was unavailable when tried to access it` = `Support option was unavailable when tried to access it`/total*100,
    `Didn't feel well enough to engage` = `Didn't feel well enough to engage`/total*100,
    `Was too busy to engage` = `Was too busy to engage`/total*100,
    `Felt better` = `Felt better`/total*100,
    `Other` = `Other`/total*100
  )

not_received_long_typeVirtual_prop <- reasons_not_received_long %>% pivot_longer(c(`Client-level`:Systemic), names_to = "Reason", values_to = "Percent")

not_received_long_typeVirtual_prop$Reason <- factor(not_received_long_typeVirtual_prop$Reason,levels=c("Client-level","Systemic","Other"),ordered=TRUE)

#summary_reasons_cat_wave_long_prop$Reason <- fct_rev(summary_reasons_cat_wave_long_prop$Reason)

not_received_long_typeVirtual_prop %>%
  filter(typeVirtual != "other") %>%
  ggplot(mapping = aes(typeVirtual, Percent, fill = Reason)) +
  geom_bar(aes(),
           stat = "identity",
           position = "stack") +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Type",  y = "Percent reason for not receiving (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  scale_fill_manual(values = rev(COPINGpalette3)) +
  theme(legend.key.size = unit(.25, "cm"))

```

##### - B) resons not received*main
```{r}

not_received_long_prop <- not_received_wide_prop %>% pivot_longer(c(`Client-level`:Systemic), names_to = "Reason", values_to = "Percent")

not_received_long_prop$Reason <- factor(not_received_long_prop$Reason,levels=c("Client-level","Systemic","Other"),ordered=TRUE)

#summary_reasons_cat_wave_long_prop$Reason <- fct_rev(summary_reasons_cat_wave_long_prop$Reason)

not_received_long_prop %>%
  filter(Type != "preventhelp_other") %>%
  filter(Type != "preventhelp_gov_website") %>%
  filter(Type != "preventhelp_nhs_111") %>%
  filter(Type != "preventhelp_nongov_website") %>%
  filter(Type != "preventhelp_nonnhs_phone") %>%
  filter(Type != "preventhelp_struc_therapy") %>%
  ggplot(mapping = aes(Type, Percent, fill = Reason)) +
  geom_bar(aes(),
           stat = "identity",
           position = "stack") +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Type",  y = "Percent reason for not receiving (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  scale_fill_manual(values = rev(COPINGpalette3)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.key.size = unit(.25, "cm"))

```

# CREATE REASONS NOT SOUGHT DATASET

"reasonNohelp_feel_fine"                            
"reasonNohelp_I_feel_better"                       
"reasonNohelp_I_dont_think_I_feel_bad_enough"       "reasonNohelp_I_want_help_dont_think_its_available"
"reasonNohelp_Bad_experiences_in_past"              
"reasonNohelp_I_want_to_but_havent"                
"reasonNohelp_Too_busy"                             
"reasonNohelp_I_didnt_know_where_to_find"          
"reasonNohelp_other"        

```{r create long reasons not sought datasets}

reasons_not_sought_long <- treat_dat %>% 
  filter(soughthelp_for_self != 1) %>%
  pivot_longer(c(reasonNohelp_feel_fine:reasonNohelp_other), names_to = "ReasonNot", values_to= "reason_given")

total_reasons_not <- sum(reasons_not_sought_long$reason_given, na.rm=T)
total_reasons_not

table(reasons_not_sought_long$reason_given)

```

## summary all reasons NOT sought

```{r total reasons}
summary_reasons_not <- reasons_not_sought_long %>%
  group_by(ReasonNot) %>%
  summarise(n = sum(reason_given, na.rm = T), prop = n/total_reasons_not*100)
summary_reasons_not
```

## summary recategorise reasons not sought

```{r recategorise reasons not sought}
reasons_not_sought_long <- reasons_not_sought_long %>%
  mutate(Reason_cat = case_when(
    ReasonNot == "reasonNohelp_Bad_experiences_in_past" ~ "Systemic", 
    ReasonNot == "reasonNohelp_feel_fine" ~ "Mild or no current symptoms", 
    ReasonNot == "reasonNohelp_I_didnt_know_where_to_find" ~ "Systemic", 
    ReasonNot == "reasonNohelp_I_dont_think_I_feel_bad_enough" ~ "Mild or no current symptoms", 
    ReasonNot == "reasonNohelp_I_feel_better" ~ "Mild or no current symptoms", 
    ReasonNot == "reasonNohelp_I_want_help_dont_think_its_available" ~ "Systemic", 
    ReasonNot == "reasonNohelp_I_want_to_but_havent" ~ "Client", 
    ReasonNot == "reasonNohelp_other" ~ "Other", 
    ReasonNot == "reasonNohelp_Too_busy" ~ "Client"))

summary_reasons_not_sought_cat <- reasons_not_sought_long %>%
  group_by(Reason_cat) %>%
  summarise(n = sum(reason_given, na.rm = T), prop = n/total_reasons_not*100)
summary_reasons_not_sought_cat
```

##### PLOT: reasons not sought: overall
```{r}

summary_reasons_not_sought_cat$Reason_cat <- factor(summary_reasons_not_sought_cat$Reason_cat, levels = c("Mild or no current symptoms", "Client", "Systemic", "Other"),ordered = T)

summary_reasons_not_sought_cat %>%
  ggplot(aes(x="", y=prop, fill=Reason_cat)) +
  geom_bar(width = 1, stat = "identity") +
  scale_fill_manual(values = COPINGpalette4) +
  coord_polar("y",start=0) +
  theme_void() +
  labs( fill = "Category of reason") +
  geom_text(aes(y = c((round(prop,digits=1))),
                x = c(1.2,1.2,1.2,1.2),
                label=paste0(round((prop),0),"%")),
            size=3,
            position = position_stack(vjust = 0.5)
  )



```


#----------------------------------
# FREQ TREATMENT SEEKING: 3 TYPES






## Unique individuals seeking help

```{r confirm unique seeking help}
unique_help_self <- treat_dat %>%
  filter(soughthelp_for_self == 1)

n_unique_help_self <- n_distinct(unique_help_self$ID)
n_unique_whole_sample <- n_distinct(treat_dat$ID)

n_unique_help_self

n_unique_whole_sample

prop_help_self  <- (n_unique_help_self/n_unique_whole_sample)*100
prop_help_self


  

```


## Unique occasions of treatment seeking (wave)

```{r treatment seeking freq by wave}

treat_dat %>%
  filter(soughthelp_for_self == 1) %>%
  count()

treat_dat_seek_count <- treat_dat %>%
  group_by(wave) %>%
  count(soughthelp_for_self)
  
treat_dat_seek_count <- pivot_wider(treat_dat_seek_count, names_from = soughthelp_for_self, values_from = n) 

treat_dat_seek_count$total_responders <- treat_dat_seek_count$`0` + treat_dat_seek_count$`1`

treat_dat_seek_count$prop_responders <- treat_dat_seek_count$`1` / treat_dat_seek_count$total_responders*100

treat_dat_seek_count

sum(treat_dat_seek_count$`1`)
sum(treat_dat_seek_count$total_responders)

#Overall number of reports
sum(treat_dat_seek_count$`1`,na.rm = TRUE)/sum(treat_dat_seek_count$total_responders,na.rm=TRUE)

#Overall proportion of treatment seekers
mean(treat_dat_seek_count$prop_responders, na.rm = TRUE)

```

### +Count N waves treatment sought

```{r count n waves treatment sought}

N_waves <- treat_dat %>%
  pivot_wider(id_cols = ID, names_from = wave, values_from = soughthelp_for_self)


N_waves <- N_waves %>%
    mutate(Total = select(., `July 2020`:`June 2021`) %>% rowSums(na.rm = TRUE))

N_waves_seeking <- N_waves %>%
  filter(Total > 0)

N_waves_table <- table(N_waves_seeking$Total)
N_waves_table

prop.table(N_waves_table)*100
```


```{r plot treatment seeking rates per wave}


treat_dat_seek_count_plot <- treat_dat_seek_count  %>%
  ggplot(mapping = aes(wave, prop_responders,fill = "placeholder")
    ) +
    geom_bar(aes(),
      stat="identity",
     position = position_dodge2(preserve = "single")
    ) +
  labs(title = "Treatment seeking", x = "Time point",  y = "Frequency of seeking treatment (%)") +
  theme_personal +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "none") + 
  scale_fill_manual(
    values = COPINGpalette4
  ) 
treat_dat_seek_count_plot

```



# ***Reduce treat_dat to those seeking treatment***

```{r treat_dat reduced to treatment seekers}

treat_dat <- treat_dat %>%
  filter(soughthelp_for_self == 1)

```

## Unique instances of treatment seeking (wave*type)

```{r unique instances of treatment seeking}

#overall count of responses (non-NA) 
 treat_dat <- treat_dat %>%
  mutate(responses_total_sought = rowSums(!is.na(treat_dat[names(treat_dat) %in% soughtcols])))
sum(treat_dat$responses_total_sought)

#overall count of instances sought (==1)
treat_dat <- treat_dat %>%
  mutate(total_instances_sought = rowSums((treat_dat[names(treat_dat) %in% soughtcols]), na.rm = T))
sum(treat_dat$total_instances_sought)

instances_by_individual <- treat_dat %>%
  group_by(ID) %>%
  summarise(sum_per_user = sum(total_instances_sought, na.rm = TRUE))

mean(instances_by_individual$sum_per_user, na.rm = T)
sd(instances_by_individual$sum_per_user)

```

# FREQ TREATMENT GAPS: 3 TYPES

## code treatment gap

```{r code treatment gap}

#calculate treatment gaps
treat_dat <- treat_dat %>%
  mutate(
    tx_gap_emergency_mh = wherehelp_sought_emergency_mh - wherehelp_received_emergency_mh,
    tx_gap_existing_mh_team = wherehelp_sought_existing_mh_team - wherehelp_received_existing_mh_team,
    tx_gap_online_talk_therapy = wherehelp_sought_online_talk_therapy - wherehelp_received_online_talk_therapy,
    tx_gap_gp = wherehelp_sought_gp - wherehelp_received_gp,
    tx_gap_nhs_111 = wherehelp_sought_nhs_111 - wherehelp_received_nhs_111,
    tx_gap_nonnhs_phone = wherehelp_sought_nonnhs_phone - wherehelp_received_nonnhs_phone,
    tx_gap_gov_website = wherehelp_sought_gov_website - wherehelp_received_gov_website,
    tx_gap_nongov_website = wherehelp_sought_nongov_website - wherehelp_received_nongov_website,
    tx_gap_selfguide_online = wherehelp_sought_selfguide_online - wherehelp_received_selfguide_online,
    tx_gap_struc_therapy = wherehelp_sought_struc_therapy - wherehelp_received_struc_therapy,
    tx_gap_other = wherehelp_sought_other - wherehelp_received_other) 

#remove all negative values (received but not sought)
treat_dat$tx_gap_emergency_mh[treat_dat$tx_gap_emergency_mh < 1] <- 0
treat_dat$tx_gap_existing_mh_team[treat_dat$tx_gap_existing_mh_team < 1] <- 0
treat_dat$tx_gap_online_talk_therapy[treat_dat$tx_gap_online_talk_therapy < 1] <- 0
treat_dat$tx_gap_gp[treat_dat$tx_gap_gp < 1] <- 0
treat_dat$tx_gap_nhs_111[treat_dat$tx_gap_nhs_111 < 1] <- 0
treat_dat$tx_gap_nonnhs_phone[treat_dat$tx_gap_nonnhs_phone < 1] <- 0
treat_dat$tx_gap_gov_website[treat_dat$tx_gap_gov_website < 1] <- 0
treat_dat$tx_gap_nongov_website[treat_dat$tx_gap_nongov_website < 1] <- 0
treat_dat$tx_gap_selfguide_online[treat_dat$tx_gap_selfguide_online < 1] <- 0
treat_dat$tx_gap_struc_therapy[treat_dat$tx_gap_struc_therapy < 1] <- 0
treat_dat$tx_gap_other[treat_dat$tx_gap_other < 1] <- 0

gapcols = c(
  "tx_gap_emergency_mh", 
  "tx_gap_existing_mh_team", 
  "tx_gap_online_talk_therapy", 
  "tx_gap_gp",
  "tx_gap_nhs_111",
  "tx_gap_nonnhs_phone",
  "tx_gap_gov_website",
  "tx_gap_nongov_website",
  "tx_gap_selfguide_online",
  "tx_gap_struc_therapy",
  "tx_gap_other")

treat_dat <- treat_dat %>%
  mutate(total_treat_gap = rowSums((treat_dat[names(treat_dat) %in% gapcols]),na.rm = T))


```

## Instances sought but didn't receive

```{r instances sought but not received}
table(treat_dat$total_treat_gap)
sum(treat_dat$total_treat_gap)

gap_instance_by_wave <- treat_dat %>%
  group_by(wave) %>%
  summarise(treat_gap = sum(total_treat_gap), t_sought = sum(total_instances_sought))

gap_instance_by_wave <- gap_instance_by_wave %>%
  mutate(prop_gap = treat_gap/t_sought*100)
gap_instance_by_wave

total_gap <- sum(gap_instance_by_wave$treat_gap)/sum(gap_instance_by_wave$t_sought)*100
total_gap

```

## One or more treatments sought but none received per wave

```{r wave - sought not received}

#overall count of instances received (==1)
treat_dat <- treat_dat %>%
  mutate(total_instances_received = rowSums((treat_dat[names(treat_dat) %in% receivecols]), na.rm = T))
sum(treat_dat$total_instances_received)

#convert to binary

treat_dat <- treat_dat %>%
  mutate(tx_received = case_when(
    total_instances_received > 0 ~ 1,
    total_instances_received <1 ~0
  ))

table(treat_dat$tx_received)

any_gap_per_wave <- treat_dat %>%
  group_by(wave) %>%
  summarise(n_anyreceieved = sum(tx_received), n_sought = sum(soughthelp_for_self))

(1-sum(any_gap_per_wave$n_anyreceieved)/sum(any_gap_per_wave$n_sought))*100

any_gap_per_wave$prop_gap <- (1-any_gap_per_wave$n_anyreceieved / any_gap_per_wave$n_sought)*100
any_gap_per_wave

```


###*Plot treatment gap*
```{r plot treatment not received if sought}

wave_treatment_gap <- treat_dat %>%
  group_by(wave) %>%
  count(TypeReceived.Any)
  
treat_dat_gap_count <- pivot_wider(wave_treatment_gap, names_from = TypeReceived.Any, values_from = n) 

treat_dat_gap_count <- treat_dat_gap_count[1:12,]
treat_dat_gap_count$total_sought <- treat_dat_gap_count$`Not received` + treat_dat_gap_count$Received

treat_dat_gap_count$prop_received <- treat_dat_gap_count$Received / treat_dat_gap_count$total_sought*100
treat_dat_gap_count$prop_gap <- 100-treat_dat_gap_count$prop_received

count_seek_gap_plot <- treat_dat_gap_count[,c(1,5:6)]
colnames(count_seek_gap_plot)[2] <- "Received"
colnames(count_seek_gap_plot)[3] <- "Not received"

count_seek_gap_plot
#mean treatment gap (as proportion of those seeking)
mean(count_seek_gap_plot$`Not received`)
sd(count_seek_gap_plot$`Not received`)

long_n_receipt <- count_seek_gap_plot %>%
  pivot_longer(!wave, names_to = "received",values_to = "percent")

long_n_receipt$received <- as.factor(long_n_receipt$received)

long_n_receipt$received <- factor(long_n_receipt$received, levels=c("Not received","Received"), ordered=TRUE)

long_n_receipt$wave <-factor(long_n_receipt$wave,levels=c("June 2021","May 2021","April 2021","March 2021","February 2021","January 2021","December 2020","November 2020","October 2020","September 2020","August 2020","July 2020"),ordered=TRUE)
  
treat_dat_received_plot <- long_n_receipt %>%
  ggplot(mapping = aes(wave, percent, fill = received)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  coord_flip() +
  labs( x = "Time point",  y = "Proportion of sample (%)") +
  theme_personal +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "top", legend.title = element_blank())  +
    scale_fill_manual(
    values = rev(COPINGpalette2)
  ) + 
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  guides(fill=guide_legend(nrow=3,byrow=TRUE))

treat_dat_received_plot

```

create a variable that will say if they sought supported or self guided for each support instance
```{r dummy type of treatment sought}

treat_dat <- treat_dat %>%
  mutate(TypeSought.Supported.Any  = case_when(wherehelp_sought_emergency_mh == 1 ~ "Sought Supported",
                               wherehelp_sought_existing_mh_team == 1 ~ "Sought Supported",
                                wherehelp_sought_online_talk_therapy == 1 ~ "Sought Supported",
                                wherehelp_sought_gp == 1 ~ "Sought Supported",
                                wherehelp_sought_nonnhs_phone == 1 ~ "Sought Supported",
                                wherehelp_sought_nhs_111 == 1 ~ "Sought Supported", 
                               TRUE ~ "Did not seek supported treatment"),
         TypeSought.SelfGuide.Any = case_when(
                                wherehelp_sought_gov_website == 1 ~ "Sought Self-guided",
                                wherehelp_sought_selfguide_online == 1 ~ "Sought Self-guided",
                                wherehelp_sought_nongov_website == 1 ~ "Sought Self-guided",
                                wherehelp_sought_struc_therapy == 1 ~ "Sought Self-guided",
                                TRUE ~ "Did not seek self-guided treatment")) %>%
  
  mutate(AnySought = case_when(TypeSought.Supported.Any  == "Sought Supported" ~ 1,
                                  TypeSought.SelfGuide.Any  == "Sought Self-guided" ~ 1,
                                 TRUE ~ 0))
```

##### received treatment if sought 

identify if treatment was received when sought according to category
```{r dummy type of treatment received}

treat_dat <- treat_dat %>%
  mutate(TypeReceived.Any  = 
           case_when(
             wherehelp_received_emergency_mh == 1 ~ "Received",
             wherehelp_received_existing_mh_team == 1 ~ "Received",
             wherehelp_received_online_talk_therapy == 1 ~ "Received",
             wherehelp_received_gp == 1 ~ "Received",
             wherehelp_received_nonnhs_phone == 1 ~ "Received",
             wherehelp_received_nhs_111 == 1 ~ "Received", 
             wherehelp_received_gov_website == 1 ~ "Received",
             wherehelp_received_selfguide_online == 1 ~ "Received",
             wherehelp_received_nongov_website == 1 ~ "Received",
             wherehelp_received_struc_therapy == 1 ~ "Received",
             wherehelp_received_other == 1 ~ "Received",
             TRUE ~ "Not received")) 
```




```{r plot treatment not received if sought - legacy,eval=FALSE}
combined_seek_gap_plot <- treat_dat_gap_count[,c(1,4:6)]
combined_seek_gap_plot$prop_seek <- treat_dat_seek_count$prop_responders
combined_seek_gap_plot$`Treatment sought and received` <- (combined_seek_gap_plot$prop_seek/100*combined_seek_gap_plot$prop_received/100)*100
combined_seek_gap_plot$`Treatment sought but not received` <- (combined_seek_gap_plot$prop_seek/100*combined_seek_gap_plot$prop_gap/100)*100
combined_seek_gap_plot$`Treatment not sought` <- 100-(combined_seek_gap_plot$`Treatment sought and received`+combined_seek_gap_plot$`Treatment sought but not received`)
  
#summary values per wave
combined_seek_gap_plot[,c(1,6:7)]

long_prop_receipt <- combined_seek_gap_plot[,c(1,6:7)] %>%
  pivot_longer(!wave, names_to = "received",values_to = "percent")

long_prop_receipt$received <- as.factor(long_prop_receipt$received)

long_prop_receipt$received <- factor(long_prop_receipt$received, levels=c("Treatment not sought","Treatment sought but not received","Treatment sought and received"), ordered=TRUE)

long_prop_receipt$wave <-factor(long_prop_receipt$wave,levels=c("April 2021","March 2021","February 2021","January 2021","December 2020","November 2020","October 2020","September 2020","August 2020","July 2020"),ordered=TRUE)
  
treat_dat_received_plot <- long_prop_receipt %>%
  ggplot(mapping = aes(wave, percent, fill = received)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  coord_flip() +
  labs( x = "Time point",  y = "Proportion of sample (%)") +
  theme_personal +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "top", legend.title = element_blank())  +
    scale_fill_manual(
    values = rev(COPINGpalette3)
  ) + 
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  guides(fill=guide_legend(nrow=3,byrow=TRUE))
treat_dat_received_plot

#average treatment gap across waves
mean(treat_dat_gap_count$prop_gap)



```


By sample

```{r treatment seeking freq by wave by sample}

txseek_by_sample <- treat_dat %>%
  group_by(wave,Sample) %>%
  freq(soughthelp_for_self)

```

### Reason for seeking treatment by wave

```{r reason seek by wave}

txseek_by_wave <- treat_dat %>%
  group_by(wave) %>%
  freq(ReasonSeek)

long_reasons <- pivot_longer(data = treat_dat, cols = c(reasonhelp_new_mh, Reason_Existing_Mh, reasonhelp_mh_crisis, reasonhelp_new_med,reasonhelp_other), names_to = "Reasons_sought", values_to = "sought")

summary_reasons <- long_reasons %>%
  group_by(wave, Reasons_sought) %>%
  summarise(n = sum(sought, na.rm = T))

wide_reasons <- pivot_wider(summary_reasons, id_cols = wave, names_from = Reasons_sought, values_from = n)

wide_reasons$total <- rowSums(wide_reasons[2:6],)
wide_reasons$Reason_Existing_Mh <- wide_reasons$Reason_Existing_Mh/wide_reasons$total *100
wide_reasons$reasonhelp_mh_crisis <- wide_reasons$reasonhelp_mh_crisis/wide_reasons$total *100
wide_reasons$reasonhelp_new_med <- wide_reasons$reasonhelp_new_med/wide_reasons$total *100
wide_reasons$reasonhelp_new_mh <- wide_reasons$reasonhelp_new_mh/wide_reasons$total *100
wide_reasons$reasonhelp_other <- wide_reasons$reasonhelp_other/wide_reasons$total *100

wide_reasons <- wide_reasons[,1:6]

long_prop_reasons <- wide_reasons %>%
  pivot_longer(!wave, names_to = "reasonSeek", values_to = "percent")

long_prop_reasons$reasonSeek <- factor(long_prop_reasons$reasonSeek, levels = c("reasonhelp_new_med","reasonhelp_other","reasonhelp_mh_crisis","reasonhelp_new_mh","Reason_Existing_Mh"))

treat_dat_seek_count_plot1 <- long_prop_reasons %>%
  ggplot(mapping = aes(wave, percent, fill = reasonSeek)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  coord_flip() +
  labs( x = "Time point",  y = "Proportion of sample (%)") +
  theme_personal +
  theme(legend.position = "top") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.title = element_blank()) +
    theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  scale_fill_manual(
    values = rev(COPINGpalette5)
  ) + guides(fill=guide_legend(nrow=4,byrow=TRUE))
treat_dat_seek_count_plot1


```

```{r reason seek by wave count}

reasons_seek_count <- treat_dat %>%
  group_by(wave) %>%
  count(ReasonSeek)
  
reasons_seek_count <- pivot_wider(reasons_seek_count, names_from = ReasonSeek, values_from = n) 

reasons_seek_count$`Existing mental health` <- as.numeric(reasons_seek_count$`Existing mental health`)
reasons_seek_count$`Mental health crisis` <- as.numeric(reasons_seek_count$`Mental health crisis`)
reasons_seek_count$`Newly emerging symptoms` <- as.numeric(reasons_seek_count$`Newly emerging symptoms`)
reasons_seek_count$`Seeking new treatment` <- as.numeric(reasons_seek_count$`Seeking new treatment`)
reasons_seek_count$Other <- as.numeric(reasons_seek_count$Other)

reasons_seek_count <- reasons_seek_count %>%
  ungroup %>%
  mutate(total_responders = select(., `Existing mental health`:`Seeking new treatment`) %>% rowSums(na.rm = TRUE))

prop_seek_count <- reasons_seek_count[,-(7:8)]

prop_seek_count$`Existing mental health concern` <- reasons_seek_count$`Existing mental health` / reasons_seek_count$total_responders*100
prop_seek_count$`Existing mental health` <- NULL

prop_seek_count$`Mental health crisis` <- reasons_seek_count$`Mental health crisis` / reasons_seek_count$total_responders*100

prop_seek_count$`Newly emerging symptoms` <- reasons_seek_count$`Newly emerging symptoms` / reasons_seek_count$total_responders*100

prop_seek_count$`Seeking new treatment` <- reasons_seek_count$`Seeking new treatment` / reasons_seek_count$total_responders*100

prop_seek_count$Other <- reasons_seek_count$Other / reasons_seek_count$total_responders*100

prop_seek_count


```
###*Plot reason seek*
```{r reason seek by wave plot}

prop_reasons <- prop_seek_count[c(1:6)] 

long_prop_reasons <-  prop_reasons %>%
pivot_longer(!wave, names_to = "ReasonSeek", values_to = "n")

long_prop_reasons$ReasonSeek <- as.factor(long_prop_reasons$ReasonSeek)

long_prop_reasons$ReasonSeek <- factor(long_prop_reasons$ReasonSeek, levels=c("Mental health crisis","Seeking new treatment","Other", "Newly emerging symptoms","Existing mental health concern"), ordered=TRUE)

long_prop_reasons$wave <-factor(long_prop_reasons$wave,levels=c("June 2021","May 2021","April 2021","March 2021","February 2021","January 2021","December 2020","November 2020","October 2020","September 2020","August 2020","July 2020"),ordered=TRUE)
  
treat_dat_seek_count_plot <- long_prop_reasons %>%
  ggplot(mapping = aes(wave, n, fill = ReasonSeek)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  coord_flip() +
  labs( x = "Time point",  y = "Proportion of sample (%)") +
  theme_personal +
  theme(legend.position = "top") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.title = element_blank()) +
    theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  scale_fill_manual(
    values = rev(COPINGpalette5)
  ) + guides(fill=guide_legend(nrow=4,byrow=TRUE))
prop_reasons
treat_dat_seek_count_plot

#COPINGpalette4
#RAMPworseGRADpalette
```
By sample
```{r reason seek by wave by sample}

reason_seek_by_wave_sample <- treat_dat %>%
  group_by(wave,Sample) %>%
  freq(ReasonSeek)

```
###*Plot reason not seek*
```{r reason not seek plot}
total_reasons <- sum(reason_not_sought$n)
reason_not_sought$percent <- reason_not_sought$n/total_reasons*100

summary_reason_not_sought <- reason_not_sought %>%
  group_by(category) %>%
  summarise(total = sum(n))

summary_reason_not_sought$percent <- summary_reason_not_sought$total/total_reasons*100

reason_not_sought
summary_reason_not_sought

reorder_summary <- summary_reason_not_sought %>%
  arrange(match(category, c("Other","Client","Systemic","Mild or no current symptoms"),desc(percent)))

reorder_summary$category <- factor(reorder_summary$category, levels=c("Mild or no current symptoms","Systemic","Client","Other"), ordered=TRUE)

pie <- reorder_summary %>%
  ggplot(aes(x="", y=percent, fill=category)) +
  geom_bar(width = 1, stat = "identity") +
  scale_fill_manual(values = COPINGpalette4) +
  coord_polar("y",start=0) +
  theme_void() +
  labs( fill = "Category of reason") +
  geom_text(aes(y = c((round(percent,digits=1))),
                x = c(1.2,1.2,1.2,1.2),
                label=paste0(round((percent),0),"%")),
            size=3,
            position = position_stack(vjust = 0.5)
  )
pie
```



### Frequency of treatment receipt by type and wave (any instances of treatment, not total instances)

Seeking ANY instances of this type of treatment (i.e., if they sought supported help from 3 sources in a  wave, it will just register once)
BUT they might ALSO have sought help from both routes (i.e., if they sought help from a supported and self guided source, they will register in each of these categories. So we might expect to have more people in the supported + self guided categories per wave than we do who sought help for themselves above)

**Supported**
```{r treatment sought by wave supported any}
tx_supported_by_wave <- treat_dat %>%
  group_by(wave) %>%
  count(TypeSought.Supported.Any)

supported_count <- pivot_wider(tx_supported_by_wave, names_from = TypeSought.Supported.Any, values_from = n) 

supported_count <- supported_count[-c(7),]
supported_count
```
By sample
```{r treatment sought by wave supported any by sample}
tx_seek_by_wave_supported <- treat_dat %>%
  group_by(wave,Sample) %>%
  freq(TypeSought.Supported.Any)

```

**Self guided**
```{r treatment sought by wave self guided any}
tx_selfguided_by_wave <- treat_dat %>%
  group_by(wave) %>%
  count(TypeSought.SelfGuide.Any)

selfguided_count <- pivot_wider(tx_selfguided_by_wave, names_from = TypeSought.SelfGuide.Any, values_from = n) 

selfguided_count <- selfguided_count[-c(7),]
selfguided_count

```

**COMPARISON of FREQ of support type**
```{r comparison of source type}
total_n_supported <- sum(supported_count$`Sought Supported`)
total_n_selfguided <- sum(selfguided_count$`Sought Self-guided`)

#total supported
total_n_supported
#as %
total_n_supported / (total_n_supported+total_n_selfguided)*100

#total self-guided
total_n_selfguided
#as %
total_n_selfguided / (total_n_supported+total_n_selfguided)*100

```

By sample
```{r treatment sought by wave self guided any by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(TypeSought.SelfGuide.Any)

```

### Frequency of treatment seeking overall
Number of people who sought treatment at any point during the pandemic
```{r check  overall treatment seeking}

treat_dat_byID %>%
  freq(AnySeek)

```


By sample
```{r check  overall treatment seeking by sample}

treat_dat_byIDSamp %>%
  group_by(Sample) %>%
  freq(AnySeek)

```

### Count table of treatment seeking across all waves
Number of times people sought treatment at any point during the pandemic (so, 138 people sought help 4 times)
```{r check number of overall treatment seeking}
treat_dat_byID %>%
  freq(n)

```

By sample
```{r check number of overall treatment seeking by sample}
treat_dat_byIDSamp %>%
  group_by(Sample) %>%
  freq(n)
```

### Count of the number of different sources from which treatment was sought, by treatment type, wave

Supported
```{r num sources from which treatment sought supported, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(TypeSought.Supported.total)

```
By sample
```{r num sources from which treatment sought supported by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(TypeSought.Supported.total)

```


Self guided
```{r num sources from which treatment sought self guided, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(TypeSought.SelfGuided.total)

```
By sample
```{r num sources from which treatment sought self guided by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(TypeSought.SelfGuided.total)

```

### Frequency of treatment receipt by wave (any instances of treatment, not total instances)
Receiving ANY instances of this type of treatment (i.e., if they sought and received supported help from 3 sources in a  wave, it will just register once)

Supported
```{r treatment receipt by wave any}
treat_dat %>%
  group_by(wave) %>%
  freq(TypeReceived.Supported.Any)

```
By sample
```{r treatment receipt by wave any by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(TypeReceived.Supported.Any)

```


Supported
```{r treatment receipt by wave self guided any}
treat_dat %>%
  group_by(wave) %>%
  freq(TypeReceived.SelfGuide.Any)
```
By sample
```{r treatment receipt by wave self guided any by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(TypeReceived.SelfGuide.Any)
```

### Frequency of treatment receipt by wave (total)
HOW MANY instances of treatment were received

Supported
```{r treatment receipt by wave supported all}
treat_dat %>%
  group_by(wave) %>%
  freq(TypeReceived.Supported.total)
```
By sample
```{r treatment receipt by wave supported all by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(TypeReceived.Supported.total)
```

**Self guided**
```{r treatment receipt by wave self guided all, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(TypeReceived.SelfGuided.total)
```

By sample
```{r treatment receipt by wave self guided all by sample, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(TypeReceived.SelfGuided.total)
```


### Count of the number of different sources from which treatment was RECEIVED, by treatment type, wave

**Supported**
```{r num sources from which treatment received supported, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(TypeReceived.Supported.total)

```
By sample
```{r num sources from which treatment received supported by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(TypeReceived.Supported.total)

```


**Self guided**
```{r num sources from which treatment received self guided, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(TypeReceived.SelfGuided.total)

```

By sample
```{r num sources from which treatment received self guided by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(TypeReceived.SelfGuided.total)

```

### Frequency of systemic / client reasons for non-receipt by wave and treatment type

Barriers to receiving treatment by wave.

This section highlights the frequency of encountering AT LEAST ONE type of each barrier per person per barrier type per wave.

Does not capture anyone more than once per category. i.e. someone who encountered 3 barriers, 1 of which was sytemic, one was client level and one was other wit appear once for each category. A person who experienced 3 systemic barriers will only be counted once (under systemic) 

#### For supported options**
**Systemic**
```{r check barriers by wave supported systemic, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(PreventHelp_Supported.Systemic)
```
By sample
```{r check barriers by wave supported systemic by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(PreventHelp_Supported.Systemic)
```
###*Plot overall reasons not received*
```{r check barriers overall supported systemic}

treat_dat <- treat_dat %>%
  mutate(total_non_na = rowSums(!is.na(treat_dat[names(treat_dat) %in% reasoncols])))
sum(treat_dat$total_non_na)

reason_not_received <- tibble(reason = c("Systemic","Client","Other"),`Self guided` = 1:3, `Supported` = 1:3)

reason_not_received[1,2] <- sum(treat_dat$PreventHelp_SelfGuided.Systemic==1,na.rm=TRUE)
reason_not_received[2,2] <- sum(treat_dat$PreventHelp_SelfGuided.Client==1,na.rm=TRUE)
reason_not_received[3,2] <- sum(treat_dat$PreventHelp_SelfGuided.Other==1,na.rm=TRUE)
reason_not_received[1,3] <- sum(treat_dat$PreventHelp_Supported.Systemic==1,na.rm=TRUE)
reason_not_received[2,3] <- sum(treat_dat$PreventHelp_Supported.Client==1,na.rm=TRUE)
reason_not_received[3,3] <- sum(treat_dat$PreventHelp_Supported.Other==1,na.rm=TRUE)

self_guided_total <- sum(reason_not_received$`Self guided`)
supported_total <- sum(reason_not_received$`Supported`)

reason_not_received_percent <- reason_not_received[,1:3]

reason_not_received_percent$`Self guided` <- reason_not_received$`Self guided` / self_guided_total*100
reason_not_received_percent$`Supported` <- reason_not_received$`Supported` / supported_total*100

#Output table of reasons not received overall
reason_not_received_overall <- reason_not_received[,1]
reason_not_received_overall$n <- reason_not_received$`Self guided` + reason_not_received$Supported
reason_not_received_overall$percent <- reason_not_received_overall$n/sum(reason_not_received_overall$n)*100

reason_not_received_overall

#Output table of reasons not received by source
reason_not_received_percent

long_percent_reasons_not_received <-  reason_not_received_percent %>%
pivot_longer(!reason, names_to = "Type", values_to = "n")

long_percent_reasons_not_received$reason <- as.factor(long_percent_reasons_not_received$reason)

long_percent_reasons_not_received$reason <- factor(long_percent_reasons_not_received$reason, levels=c("Client","Systemic","Other"), ordered=TRUE)

treat_dat_not_received_plot <- long_percent_reasons_not_received %>%
  ggplot(mapping = aes(Type, n, fill = reason)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Type of treatment",  y = "Proportion of responses (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  scale_fill_manual(
    values = rev(COPINGpalette3)
  ) 
treat_dat_not_received_plot

```

###*Plot reasons not received by source*
```{r Plot reasons not received by source,fig.height=3,fig.width=7}

reason_not_received_by_source <- tibble(source = c("Emergency mental health team","Existing mental health team", "GP","Online talk therapy","NHS 111","Non NHS phone","Government website","Non-government website","Online self-therapy","Structured therapeutic activity","Other"),`Systemic` = 1:11, `Client` = 1:11,`Other` = 1:11)

reason_not_received_by_source[1,2] <- sum(treat_dat$preventhelp_emergency_mh=="Systemic",na.rm=TRUE)
reason_not_received_by_source[1,3] <- sum(treat_dat$preventhelp_emergency_mh=="Client-level",na.rm=TRUE)
reason_not_received_by_source[1,4] <- sum(treat_dat$preventhelp_emergency_mh=="Other",na.rm=TRUE)

reason_not_received_by_source[2,2] <- sum(treat_dat$preventhelp_existing_mh_team=="Systemic",na.rm=TRUE)
reason_not_received_by_source[2,3] <- sum(treat_dat$preventhelp_existing_mh_team=="Client-level",na.rm=TRUE)
reason_not_received_by_source[2,4] <- sum(treat_dat$preventhelp_existing_mh_team=="Other",na.rm=TRUE)

reason_not_received_by_source[3,2] <- sum(treat_dat$preventhelp_gp=="Systemic",na.rm=TRUE)
reason_not_received_by_source[3,3] <- sum(treat_dat$preventhelp_gp=="Client-level",na.rm=TRUE)
reason_not_received_by_source[3,4] <- sum(treat_dat$preventhelp_gp=="Other",na.rm=TRUE)

reason_not_received_by_source[4,2] <- sum(treat_dat$preventhelp_online_talk_therapy=="Systemic",na.rm=TRUE)
reason_not_received_by_source[4,3] <- sum(treat_dat$preventhelp_online_talk_therapy=="Client-level",na.rm=TRUE)
reason_not_received_by_source[4,4] <- sum(treat_dat$preventhelp_online_talk_therapy=="Other",na.rm=TRUE)

reason_not_received_by_source[5,2] <- sum(treat_dat$preventhelp_nhs_111=="Systemic",na.rm=TRUE)
reason_not_received_by_source[5,3] <- sum(treat_dat$preventhelp_nhs_111=="Client-level",na.rm=TRUE)
reason_not_received_by_source[5,4] <- sum(treat_dat$preventhelp_nhs_111=="Other",na.rm=TRUE)

reason_not_received_by_source[6,2] <- sum(treat_dat$preventhelp_nonnhs_phone=="Systemic",na.rm=TRUE)
reason_not_received_by_source[6,3] <- sum(treat_dat$preventhelp_nonnhs_phone=="Client-level",na.rm=TRUE)
reason_not_received_by_source[6,4] <- sum(treat_dat$preventhelp_nonnhs_phone=="Other",na.rm=TRUE)

reason_not_received_by_source[7,2] <- sum(treat_dat$preventhelp_gov_website=="Systemic",na.rm=TRUE)
reason_not_received_by_source[7,3] <- sum(treat_dat$preventhelp_gov_website=="Client-level",na.rm=TRUE)
reason_not_received_by_source[7,4] <- sum(treat_dat$preventhelp_gov_website=="Other",na.rm=TRUE)

reason_not_received_by_source[8,2] <- sum(treat_dat$preventhelp_nongov_website=="Systemic",na.rm=TRUE)
reason_not_received_by_source[8,3] <- sum(treat_dat$preventhelp_nongov_website=="Client-level",na.rm=TRUE)
reason_not_received_by_source[8,4] <- sum(treat_dat$preventhelp_nongov_website=="Other",na.rm=TRUE)

reason_not_received_by_source[9,2] <- sum(treat_dat$preventhelp_online_self_therapy=="Systemic",na.rm=TRUE)
reason_not_received_by_source[9,3] <- sum(treat_dat$preventhelp_online_self_therapy=="Client-level",na.rm=TRUE)
reason_not_received_by_source[9,4] <- sum(treat_dat$preventhelp_online_self_therapy=="Other",na.rm=TRUE)

reason_not_received_by_source[10,2] <- sum(treat_dat$preventhelp_struc_therapy=="Systemic",na.rm=TRUE)
reason_not_received_by_source[10,3] <- sum(treat_dat$preventhelp_struc_therapy=="Client-level",na.rm=TRUE)
reason_not_received_by_source[10,4] <- sum(treat_dat$preventhelp_struc_therapy=="Other",na.rm=TRUE)

reason_not_received_by_source[11,2] <- sum(treat_dat$preventhelp_other=="Systemic",na.rm=TRUE)
reason_not_received_by_source[11,3] <- sum(treat_dat$preventhelp_other=="Client-level",na.rm=TRUE)
reason_not_received_by_source[11,4] <- sum(treat_dat$preventhelp_other=="Other",na.rm=TRUE)

reason_not_received_by_source$total <- reason_not_received_by_source$Systemic + reason_not_received_by_source$Client + reason_not_received_by_source$Other

reason_not_received_by_source_percent <- reason_not_received_by_source[,1:4]

reason_not_received_by_source_percent$Systemic <- reason_not_received_by_source$Systemic / reason_not_received_by_source$total*100
reason_not_received_by_source_percent$Client <- reason_not_received_by_source$Client / reason_not_received_by_source$total*100
reason_not_received_by_source_percent$Other <- reason_not_received_by_source$Other / reason_not_received_by_source$total*100

reason_not_received_by_source
reason_not_received_by_source_percent

#format for plot
long_reason_not_received_by_source_percent <-  reason_not_received_by_source_percent %>%
pivot_longer(!source, names_to = "reason", values_to = "percent")

long_reason_not_received_by_source_percent$source <- as.factor(long_reason_not_received_by_source_percent$source)

long_reason_not_received_by_source_percent$reason <- factor(long_reason_not_received_by_source_percent$reason, levels=c("Other","Client","Systemic"), ordered=TRUE)

long_reason_not_received_by_source_percent$source <- factor(long_reason_not_received_by_source_percent$source,levels=c("Other","Structured therapeutic activity","Online self-therapy","Non-government website","Government website","Non NHS phone","NHS 111","Online talk therapy","GP","Existing mental health team","Emergency mental health team"), ordered = TRUE)

treat_dat_not_received_by_source_plot <- long_reason_not_received_by_source_percent %>%
  ggplot(mapping = aes(source, percent, fill = reason)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  coord_flip() +
  theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Type of treatment",  y = "Proportion of responses (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  scale_fill_manual(
    values = rev(COPINGpalette3)
  ) 
treat_dat_not_received_by_source_plot

```

### ***Type of treatment sought by wave***

```{r type seek by wave}

table(treat_dat$soughthelp_for_self)


type_seek_wave <- treat_dat %>%
  filter(soughthelp_for_self == 1) #filter for those who sought help only
  
type_seek_wave <- pivot_longer(data = type_seek_wave, cols = c(wherehelp_sought_emergency_mh, wherehelp_sought_existing_mh_team, wherehelp_sought_online_talk_therapy, wherehelp_sought_gp, wherehelp_sought_nhs_111, wherehelp_sought_nonnhs_phone, wherehelp_sought_gov_website, wherehelp_sought_nongov_website, wherehelp_sought_selfguide_online, wherehelp_sought_struc_therapy, wherehelp_sought_other), names_to = "Treatment source", values_to = "sought" )

type_seek_wave <- type_seek_wave %>%
  mutate(typeVirtual = case_when(
    `Treatment source` ==  "wherehelp_sought_emergency_mh" ~ "other",
    `Treatment source` ==  "wherehelp_sought_existing_mh_team" ~ "other",
    `Treatment source` ==  "wherehelp_sought_online_talk_therapy" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_gp" ~ "other",
    `Treatment source` ==  "wherehelp_sought_nhs_111" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_nonnhs_phone" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_gov_website" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_nongov_website" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_selfguide_online" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_struc_therapy" ~ "other",
    `Treatment source` ==  "wherehelp_sought_other" ~ "other"))

type_seek_wave$`Treatment source` <- as.factor(type_seek_wave$`Treatment source`)
type_seek_wave$wave <- as.factor(type_seek_wave$wave)


percent_type_seek_wave <- type_seek_wave %>%
  filter(sought != "NA") %>%
  dplyr::group_by(wave, `Treatment source`) %>%
  summarise(n = sum(sought==1)) %>%
  mutate(percent = n/sum(n)*100)

percent_type_seek_wave_cat <- type_seek_wave %>%
  filter(sought != "NA") %>%
  dplyr::group_by(wave, typeVirtual) %>%
  summarise(n = sum(sought==1)) %>%
  mutate(percent = n/sum(n)*100)

percent_type_seek_wave %>% 
  ggplot(mapping = aes(wave, percent, fill = `Treatment source`)) +
  geom_bar(aes(),
           stat = "identity",
           position = "stack") +
  coord_flip() +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Wave",  y = "Percent (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm"))

percent_type_seek_wave_cat %>% 
  ggplot(mapping = aes(wave, percent, fill = typeVirtual)) +
  geom_bar(aes(),
           stat = "identity",
           position = "stack") +
  coord_flip() +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Wave",  y = "Percent (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm"))


```


**Client-level**
```{r check barriers by wave supported client level, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(PreventHelp_Supported.Client)
```
By sample
```{r check barriers by wave supported client by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(PreventHelp_Supported.Client)
```

**Other**
```{r check barriers by wave supported other, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(PreventHelp_Supported.Other)
```
By sample
```{r check barriers by wave supported other by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(PreventHelp_Supported.Other)
```

#### For self guided options**
**Systemic**
```{r check barriers by wave SelfGuided systemic, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(PreventHelp_SelfGuided.Systemic)
```
By sample
```{r check barriers by wave SelfGuided systemic by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(PreventHelp_SelfGuided.Systemic)
```

**Client-level**
```{r check barriers by wave SelfGuided client level, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(PreventHelp_SelfGuided.Client)
```
By sample
```{r check barriers by wave SelfGuided client by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(PreventHelp_SelfGuided.Client)
```

**Other**
```{r check barriers by wave SelfGuided other, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(PreventHelp_SelfGuided.Other)
```
By sample
```{r check barriers by wave SelfGuided other by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(PreventHelp_SelfGuided.Other)
```

### Barriers by agency by wave
#### Supported

***Emergency mental health team***
```{r barriers by agency em mh, eval=FALSE}

treat_dat %>%
  group_by(wave) %>%
  freq(preventhelp_emergency_mh)

```
By sample
```{r barriers by agency em mh by sample, eval=FALSE}

treat_dat %>%
  group_by(wave,Sample) %>%
  freq(preventhelp_emergency_mh)

```

***Existing mental health team***
```{r barriers by agency existing mh, eval=FALSE}

treat_dat %>%
  group_by(wave) %>%
  freq(preventhelp_existing_mh_team)

```
By sample
```{r barriers by agency existing mh by sample, eval=FALSE}

treat_dat %>%
  group_by(wave,Sample) %>%
  freq(preventhelp_existing_mh_team)

```

***Online talk therapy***
```{r barriers by agency online talk, eval=FALSE}

treat_dat %>%
  group_by(wave) %>%
  freq(preventhelp_online_talk_therapy)

```
By sample
```{r barriers by agency online talk by sample, eval=FALSE}

treat_dat %>%
  group_by(wave,Sample) %>%
  freq(preventhelp_online_talk_therapy)

```

***GP***
```{r barriers by agency GP, eval=FALSE}

treat_dat %>%
  group_by(wave) %>%
  freq(preventhelp_gp)

```
By sample
```{r barriers by agency gp by sample, eval=FALSE}

treat_dat %>%
  group_by(wave,Sample) %>%
  freq(preventhelp_gp)

```

***NHS 111***
```{r barriers by agency nhs 111, eval=FALSE}

treat_dat %>%
  group_by(wave) %>%
  freq(preventhelp_nhs_111)

```
By sample
```{r barriers by agency nhs 111 by sample, eval=FALSE}

treat_dat %>%
  group_by(wave,Sample) %>%
  freq(preventhelp_nhs_111)

```

***Non NHS phone***
```{r barriers by agency phone, eval=FALSE}

treat_dat %>%
  group_by(wave) %>%
  freq(preventhelp_nonnhs_phone)

```
By sample
```{r barriers by agencyphone by sample, eval=FALSE}

treat_dat %>%
  group_by(wave,Sample) %>%
  freq(preventhelp_nonnhs_phone)

```

#### Self guided

***Government website***
```{r barriers by agency gov site, eval=FALSE}

treat_dat %>%
  group_by(wave) %>%
  freq(preventhelp_gov_website)

```
By sample
```{r barriers by agency gove site by sample, eval=FALSE}

treat_dat %>%
  group_by(wave,Sample) %>%
  freq(preventhelp_gov_website)

```

***Non-government website***
```{r barriers by agency non gov site, eval=FALSE}

treat_dat %>%
  group_by(wave) %>%
  freq(preventhelp_nongov_website)

```
By sample
```{r barriers by agency non gov site by sample, eval=FALSE}

treat_dat %>%
  group_by(wave,Sample) %>%
  freq(preventhelp_nongov_website)

```

***Online self-therapy***
```{r barriers by agency online self therapy, eval=FALSE}

treat_dat %>%
  group_by(wave) %>%
  freq(preventhelp_online_self_therapy)

```
By sample
```{r barriers by agency online self therapy by sample, eval=FALSE}

treat_dat %>%
  group_by(wave,Sample) %>%
  freq(preventhelp_online_self_therapy)

```

***Structured therapeutic activity***
```{r barriers by agency structured therapeutic activity, eval=FALSE}

treat_dat %>%
  group_by(wave) %>%
  freq(preventhelp_struc_therapy)

```
By sample
```{r barriers by agency structured therapeutic activity by sample, eval=FALSE}

treat_dat %>%
  group_by(wave,Sample) %>%
  freq(preventhelp_struc_therapy)

```

### Frequency of different levels of helpfulness by treatment type (supported/client led) by wave

**For supported options**
```{r check helpfulness by wave supported, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(Helpfulness_Supported)
```
By sample
```{r check helpfulness by wave supported by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(Helpfulness_Supported)
```

**For  client led options**
```{r check helpfulness by wave client led, eval=FALSE}
treat_dat %>%
  group_by(wave) %>%
  freq(Helpfulness_SelfGuided)
```
By sample
```{r check helpfulness by wave client led by sample, eval=FALSE}
treat_dat %>%
  group_by(wave,Sample) %>%
  freq(Helpfulness_SelfGuided)
```

###*Plot helpfulness*
```{r plot helpfulness}

treat_dat <- treat_dat %>%
  mutate(total_helpfulness_non_na = rowSums(!is.na(treat_dat[names(treat_dat) %in% helpfulnesscols])))

helpfulnessTotal <- sum(treat_dat$total_helpfulness_non_na)
helpfulnessTotal

helpful_treat_dat_long <- pivot_longer(data = treat_dat, cols = c(treatmenthelpful_emergency_mh, treatmenthelpful_existing_mh_team, treatmenthelpful_online_talk_therapy, treatmenthelpful_gp, treatmenthelpful_nhs_111, treatmenthelpful_nonnhs_phone, treatmenthelpful_gov_website, treatmenthelpful_nongov_website, treatmenthelpful_online_self_therapy, treatmenthelpful_struc_therapy, treatmenthelpful_other), names_to = "Tx_type", values_to = "helpfulness")

helpful_summary <- helpful_treat_dat_long %>%
  filter( !is.na(helpfulness)) %>%
  group_by(helpfulness) %>%
  summarise(n = n())

helpful_summary$percent <- helpful_summary$n/helpfulnessTotal*100

prop.table(table(helpful_summary))


test <- treat_dat[,c(1,3,6:27,39:49,73,92,95)]

helpfulness_freq_supported <- treat_dat %>%
  freq(Helpfulness_Supported)

helpfulness_freq_self_guided <- treat_dat %>%
  freq(Helpfulness_SelfGuided)

helpfulness_supported <- as.data.frame(helpfulness_freq_supported)
helpfulness_selfguided <- as.data.frame(helpfulness_freq_self_guided)

helpfulness <- helpfulness_supported[1:7,c(1,2)]
helpfulness$`Self guided` <- helpfulness_selfguided[1:7,c(2)]
helpfulness$`Supported` <- helpfulness$`% Valid`
helpful_attritbutes <- attributes(helpfulness)
helpfulness$labels <- helpful_attritbutes$row.names

helpfulness <- helpfulness[,c(3:5)]

#output helpfulness data
helpfulness

#at least 'somewhat' helpful 
#self-guided
sum(helpfulness$`Self guided`[5:7])
#supported
sum(helpfulness$Supported[5:7])

#format for plot
long_helpfulness <-  helpfulness %>%
pivot_longer(!labels, names_to = "Type", values_to = "n")

long_helpfulness$labels <- as.factor(long_helpfulness$labels)

long_helpfulness$labels <- factor(long_helpfulness$labels, levels=c("Extremely helpful","Very helpful","Somewhat helpful","Neither helpful nor unhelpful","Somewhat unhelpful","Very unhelpful","Extremely unhelpful"), ordered=TRUE)

helpfulness_plot <- long_helpfulness %>%
  ggplot(mapping = aes(Type, n, fill = labels)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  theme(legend.position = "right", legend.title = element_blank())  +
  labs( x = "Type of treatment",  y = "Proportion of responses (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  scale_fill_manual(
    values = (RAMPlikertpalette)
  ) 
helpfulness_plot

```

### Frequency of reasons for NOT seeking help

overall
```{r check, eval=FALSE}

for (i in grep("reasonNo", names(treat_dat)))
  print(freq(treat_dat[i]))


```

## Gender and age stratification for barriers

Add gender and age to treatment data 

```{r add gender to treat datgender}
treat_dat <- full_join(treat_dat,demgen)
```


### Treatment seeking rates by Gender
```{r treatment seeking freq by gender}

treat_sought <- treat_dat %>%
  group_by(Gender) %>%
  count(soughthelp_for_self)

#summarise to just male-female for chi-square
tx_sought_mf <- treat_sought[c(10:11,13:14),]

wide_tx_sought_mf <- tx_sought_mf %>%
  pivot_wider(id_cols = Gender, names_from = soughthelp_for_self, values_from = n)

tx_sought_gender_chisq <- chisq.test(wide_tx_sought_mf[-1])
tx_sought_gender_chisq$p.value

tx_sought_gender_chisq

#as proportions
wide_tx_sought_mf$prop_sought <- wide_tx_sought_mf$`1`/(wide_tx_sought_mf$`1` + wide_tx_sought_mf$`0`)*100
wide_tx_sought_mf$prop_not_sought <- wide_tx_sought_mf$`0`/(wide_tx_sought_mf$`1` + wide_tx_sought_mf$`0`)*100

wide_tx_sought_mf

#N for chisq test
sum(wide_tx_sought_mf$`0`) + sum(wide_tx_sought_mf$`1`)
```

### ***Type of treatment sought by gender***

```{r type seek by gender}

type_seek_gender <- treat_dat %>%
  filter(soughthelp_for_self == 1) %>% #filter for those who sought help only
  filter(Gender == "Male" | Gender == "Female")
  
type_seek_gender <- pivot_longer(data = type_seek_gender, cols = c(wherehelp_sought_emergency_mh, wherehelp_sought_existing_mh_team, wherehelp_sought_online_talk_therapy, wherehelp_sought_gp, wherehelp_sought_nhs_111, wherehelp_sought_nonnhs_phone, wherehelp_sought_gov_website, wherehelp_sought_nongov_website, wherehelp_sought_selfguide_online, wherehelp_sought_struc_therapy, wherehelp_sought_other), names_to = "Treatment source", values_to = "sought" )
# 
# type_seek_wave$`Treatment source` <- as.factor(type_seek_wave$`Treatment source`)
# type_seek_wave$wave <- as.factor(type_seek_wave$wave)

type_seek_gender <- type_seek_gender %>%
  mutate(typeVirtual = case_when(
    `Treatment source` ==  "wherehelp_sought_emergency_mh" ~ "other",
    `Treatment source` ==  "wherehelp_sought_existing_mh_team" ~ "other",
    `Treatment source` ==  "wherehelp_sought_online_talk_therapy" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_gp" ~ "other",
    `Treatment source` ==  "wherehelp_sought_nhs_111" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_nonnhs_phone" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_gov_website" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_nongov_website" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_selfguide_online" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_struc_therapy" ~ "other",
    `Treatment source` ==  "wherehelp_sought_other" ~ "other"))


percent_type_seek_gender <- type_seek_gender %>%
  filter(sought != "NA") %>%
  dplyr::group_by(Gender, `Treatment source`) %>%
  summarise(n = sum(sought==1)) %>%
  mutate(percent = n/sum(n)*100)

percent_type_seek_gender_cat <- type_seek_gender %>%
  filter(sought != "NA") %>%
  dplyr::group_by(Gender, typeVirtual) %>%
  summarise(n = sum(sought==1)) %>%
  mutate(percent = n/sum(n)*100)

percent_type_seek_gender %>% 
  ggplot(mapping = aes(Gender, percent, fill = `Treatment source`)) +
  geom_bar(aes(),
           stat = "identity",
           position = "stack") +
  coord_flip() +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Gender",  y = "Percent (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm"))

percent_type_seek_gender_cat %>% 
  ggplot(mapping = aes(Gender, percent, fill = typeVirtual)) +
  geom_bar(aes(),
           stat = "identity",
           position = "stack") +
  coord_flip() +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Gender",  y = "Percent (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm"))

```

### Treatment seeking rates by Age
```{r treatment seeking freq by age}

treat_sought_age <- treat_dat %>%
  group_by(AgeRecoded) %>%
  count(soughthelp_for_self)

#summarise to just full categories for chi-square
tx_sought_age <- treat_sought_age[c(2:3,5:6,8:9,11:12,14:15,17:18,20:21),]

wide_tx_sought_age <- tx_sought_age %>%
  pivot_wider(id_cols = AgeRecoded, names_from = soughthelp_for_self, values_from = n)

tx_sought_age_chisq <- chisq.test(wide_tx_sought_age[-1])
tx_sought_age_chisq$p.value
tx_sought_age_chisq

#as proportions
wide_tx_sought_age$prop_sought <- wide_tx_sought_age$`1`/(wide_tx_sought_age$`1` + wide_tx_sought_age$`0`)*100
wide_tx_sought_age$prop_not_sought <- wide_tx_sought_age$`0`/(wide_tx_sought_age$`1` + wide_tx_sought_age$`0`)*100
wide_tx_sought_age

#N for chisq test
sum(wide_tx_sought_age$`0`) + sum(wide_tx_sought_age$`1`)
```

### ***Type of treatment sought by age***

```{r type seek by age}

type_seek_age <- treat_dat %>%
  filter(soughthelp_for_self == 1) 
  
type_seek_age <- pivot_longer(data = type_seek_age, cols = c(wherehelp_sought_emergency_mh, wherehelp_sought_existing_mh_team, wherehelp_sought_online_talk_therapy, wherehelp_sought_gp, wherehelp_sought_nhs_111, wherehelp_sought_nonnhs_phone, wherehelp_sought_gov_website, wherehelp_sought_nongov_website, wherehelp_sought_selfguide_online, wherehelp_sought_struc_therapy, wherehelp_sought_other), names_to = "Treatment source", values_to = "sought" )
# 
# type_seek_wave$`Treatment source` <- as.factor(type_seek_wave$`Treatment source`)
# type_seek_wave$wave <- as.factor(type_seek_wave$wave)

type_seek_age <- type_seek_age %>%
  mutate(typeVirtual = case_when(
    `Treatment source` ==  "wherehelp_sought_emergency_mh" ~ "other",
    `Treatment source` ==  "wherehelp_sought_existing_mh_team" ~ "other",
    `Treatment source` ==  "wherehelp_sought_online_talk_therapy" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_gp" ~ "other",
    `Treatment source` ==  "wherehelp_sought_nhs_111" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_nonnhs_phone" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_gov_website" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_nongov_website" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_selfguide_online" ~ "exclusively virtual",
    `Treatment source` ==  "wherehelp_sought_struc_therapy" ~ "other",
    `Treatment source` ==  "wherehelp_sought_other" ~ "other"))


percent_type_seek_age <- type_seek_age %>%
  filter(sought != "NA") %>%
  dplyr::group_by(AgeRecoded, `Treatment source`) %>%
  summarise(n = sum(sought==1)) %>%
  mutate(percent = n/sum(n)*100)

percent_type_seek_age_cat <- type_seek_age %>%
  filter(sought != "NA") %>%
  dplyr::group_by(AgeRecoded, typeVirtual) %>%
  summarise(n = sum(sought==1)) %>%
  mutate(percent = n/sum(n)*100)

percent_type_seek_age %>% 
  ggplot(mapping = aes(AgeRecoded, percent, fill = `Treatment source`)) +
  geom_bar(aes(),
           stat = "identity",
           position = "stack") +
  coord_flip() +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Gender",  y = "Percent (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm"))

percent_type_seek_age_cat %>% 
  ggplot(mapping = aes(AgeRecoded, percent, fill = typeVirtual)) +
  geom_bar(aes(),
           stat = "identity",
           position = "stack") +
  coord_flip() +
 theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Gender",  y = "Percent (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm"))

```

###*Summary reasons not received - BY GENDER*
```{r reasons not received - by gender}

reason_not_received_female <- tibble(reason = c("Systemic","Client","Other"), `Self guided` = 1:3, `Supported` = 1:3)

reason_not_received_male <- tibble(reason = c("Systemic","Client","Other"), `Self guided` = 1:3, `Supported` = 1:3)

reason_not_received_nbsd <- tibble(reason = c("Systemic","Client","Other"), `Self guided` = 1:3, `Supported` = 1:3)

female_treat_dat <- filter(treat_dat, Gender == "Female")
male_treat_dat <- filter(treat_dat, Gender == "Male")
nbsd_treat_dat <- filter(treat_dat, Gender == "Non-binary" | Gender == "Prefer to self define")

reason_not_received_female[1,2] <- sum(female_treat_dat$PreventHelp_SelfGuided.Systemic==1,na.rm=TRUE)
reason_not_received_female[2,2] <- sum(female_treat_dat$PreventHelp_SelfGuided.Client==1,na.rm=TRUE)
reason_not_received_female[3,2] <- sum(female_treat_dat$PreventHelp_SelfGuided.Other==1,na.rm=TRUE)
reason_not_received_female[1,3] <- sum(female_treat_dat$PreventHelp_Supported.Systemic==1,na.rm=TRUE)
reason_not_received_female[2,3] <- sum(female_treat_dat$PreventHelp_Supported.Client==1,na.rm=TRUE)
reason_not_received_female[3,3] <- sum(female_treat_dat$PreventHelp_Supported.Other==1,na.rm=TRUE)

reason_not_received_male[1,2] <- sum(male_treat_dat$PreventHelp_SelfGuided.Systemic==1,na.rm=TRUE)
reason_not_received_male[2,2] <- sum(male_treat_dat$PreventHelp_SelfGuided.Client==1,na.rm=TRUE)
reason_not_received_male[3,2] <- sum(male_treat_dat$PreventHelp_SelfGuided.Other==1,na.rm=TRUE)
reason_not_received_male[1,3] <- sum(male_treat_dat$PreventHelp_Supported.Systemic==1,na.rm=TRUE)
reason_not_received_male[2,3] <- sum(male_treat_dat$PreventHelp_Supported.Client==1,na.rm=TRUE)
reason_not_received_male[3,3] <- sum(male_treat_dat$PreventHelp_Supported.Other==1,na.rm=TRUE)

reason_not_received_nbsd[1,2] <- sum(nbsd_treat_dat$PreventHelp_SelfGuided.Systemic==1,na.rm=TRUE)
reason_not_received_nbsd[2,2] <- sum(nbsd_treat_dat$PreventHelp_SelfGuided.Client==1,na.rm=TRUE)
reason_not_received_nbsd[3,2] <- sum(nbsd_treat_dat$PreventHelp_SelfGuided.Other==1,na.rm=TRUE)
reason_not_received_nbsd[1,3] <- sum(nbsd_treat_dat$PreventHelp_Supported.Systemic==1,na.rm=TRUE)
reason_not_received_nbsd[2,3] <- sum(nbsd_treat_dat$PreventHelp_Supported.Client==1,na.rm=TRUE)
reason_not_received_nbsd[3,3] <- sum(nbsd_treat_dat$PreventHelp_Supported.Other==1,na.rm=TRUE)

self_guided_total_female <- sum(reason_not_received_female$`Self guided`)
supported_total_female <- sum(reason_not_received_female$`Supported`)
self_guided_total_male <- sum(reason_not_received_male$`Self guided`)
supported_total_male <- sum(reason_not_received_male$`Supported`)
self_guided_total_nbsd <- sum(reason_not_received_nbsd$`Self guided`)
supported_total_nbsd <- sum(reason_not_received_nbsd$`Supported`)

reason_not_received_percent_female <- reason_not_received_female[,1:3]
reason_not_received_percent_male <- reason_not_received_male[,1:3]
reason_not_received_percent_nbsd <- reason_not_received_nbsd[,1:3]

reason_not_received_percent_female$`Self guided` <- reason_not_received_percent_female$`Self guided` / self_guided_total_female*100
reason_not_received_percent_female$`Supported` <- reason_not_received_female$`Supported` / supported_total_female*100

reason_not_received_percent_male$`Self guided` <- reason_not_received_percent_male$`Self guided` / self_guided_total_male*100
reason_not_received_percent_male$`Supported` <- reason_not_received_male$`Supported` / supported_total_male*100

reason_not_received_percent_nbsd$`Self guided` <- reason_not_received_percent_nbsd$`Self guided` / self_guided_total_nbsd*100
reason_not_received_percent_nbsd$`Supported` <- reason_not_received_nbsd$`Supported` / supported_total_nbsd*100


reason_not_received_percent_female
reason_not_received_percent_male
reason_not_received_percent_nbsd
```

###*Summary reasons not received - BY AGE*
```{r reasons not received - by age}
#this is not the best way to code this, but will do for now
reason_not_received_16_25 <- tibble(reason = c("Systemic","Client","Other"), `Self guided` = 1:3, `Supported` = 1:3)
reason_not_received_26_35 <- tibble(reason = c("Systemic","Client","Other"), `Self guided` = 1:3, `Supported` = 1:3)
reason_not_received_36_45 <- tibble(reason = c("Systemic","Client","Other"), `Self guided` = 1:3, `Supported` = 1:3)
reason_not_received_46_55 <- tibble(reason = c("Systemic","Client","Other"), `Self guided` = 1:3, `Supported` = 1:3)
reason_not_received_56_65 <- tibble(reason = c("Systemic","Client","Other"), `Self guided` = 1:3, `Supported` = 1:3)
reason_not_received_66_75 <- tibble(reason = c("Systemic","Client","Other"), `Self guided` = 1:3, `Supported` = 1:3)
reason_not_received_76_plus <- tibble(reason = c("Systemic","Client","Other"), `Self guided` = 1:3, `Supported` = 1:3)

age16_25_treat_dat <- filter(treat_dat, AgeRecoded == "16-25")
age26_35_treat_dat <- filter(treat_dat, AgeRecoded == "26-35")
age36_45_treat_dat <- filter(treat_dat, AgeRecoded == "36-45")
age46_55_treat_dat <- filter(treat_dat, AgeRecoded == "46-55")
age56_65_treat_dat <- filter(treat_dat, AgeRecoded == "56-65")
age66_75_treat_dat <- filter(treat_dat, AgeRecoded == "66-75")
age76_plus_treat_dat <- filter(treat_dat, AgeRecoded == "76+")

#16-25
reason_not_received_16_25[1,2] <- sum(age16_25_treat_dat$PreventHelp_SelfGuided.Systemic==1,na.rm=TRUE)
reason_not_received_16_25[2,2] <- sum(age16_25_treat_dat$PreventHelp_SelfGuided.Client==1,na.rm=TRUE)
reason_not_received_16_25[3,2] <- sum(age16_25_treat_dat$PreventHelp_SelfGuided.Other==1,na.rm=TRUE)
reason_not_received_16_25[1,3] <- sum(age16_25_treat_dat$PreventHelp_Supported.Systemic==1,na.rm=TRUE)
reason_not_received_16_25[2,3] <- sum(age16_25_treat_dat$PreventHelp_Supported.Client==1,na.rm=TRUE)
reason_not_received_16_25[3,3] <- sum(age16_25_treat_dat$PreventHelp_Supported.Other==1,na.rm=TRUE)

#26-35
reason_not_received_26_35[1,2] <- sum(age26_35_treat_dat$PreventHelp_SelfGuided.Systemic==1,na.rm=TRUE)
reason_not_received_26_35[2,2] <- sum(age26_35_treat_dat$PreventHelp_SelfGuided.Client==1,na.rm=TRUE)
reason_not_received_26_35[3,2] <- sum(age26_35_treat_dat$PreventHelp_SelfGuided.Other==1,na.rm=TRUE)
reason_not_received_26_35[1,3] <- sum(age26_35_treat_dat$PreventHelp_Supported.Systemic==1,na.rm=TRUE)
reason_not_received_26_35[2,3] <- sum(age26_35_treat_dat$PreventHelp_Supported.Client==1,na.rm=TRUE)
reason_not_received_26_35[3,3] <- sum(age26_35_treat_dat$PreventHelp_Supported.Other==1,na.rm=TRUE)

#36-45
reason_not_received_36_45[1,2] <- sum(age36_45_treat_dat$PreventHelp_SelfGuided.Systemic==1,na.rm=TRUE)
reason_not_received_36_45[2,2] <- sum(age36_45_treat_dat$PreventHelp_SelfGuided.Client==1,na.rm=TRUE)
reason_not_received_36_45[3,2] <- sum(age36_45_treat_dat$PreventHelp_SelfGuided.Other==1,na.rm=TRUE)
reason_not_received_36_45[1,3] <- sum(age36_45_treat_dat$PreventHelp_Supported.Systemic==1,na.rm=TRUE)
reason_not_received_36_45[2,3] <- sum(age36_45_treat_dat$PreventHelp_Supported.Client==1,na.rm=TRUE)
reason_not_received_36_45[3,3] <- sum(age36_45_treat_dat$PreventHelp_Supported.Other==1,na.rm=TRUE)

#46-55
reason_not_received_46_55[1,2] <- sum(age46_55_treat_dat$PreventHelp_SelfGuided.Systemic==1,na.rm=TRUE)
reason_not_received_46_55[2,2] <- sum(age46_55_treat_dat$PreventHelp_SelfGuided.Client==1,na.rm=TRUE)
reason_not_received_46_55[3,2] <- sum(age46_55_treat_dat$PreventHelp_SelfGuided.Other==1,na.rm=TRUE)
reason_not_received_46_55[1,3] <- sum(age46_55_treat_dat$PreventHelp_Supported.Systemic==1,na.rm=TRUE)
reason_not_received_46_55[2,3] <- sum(age46_55_treat_dat$PreventHelp_Supported.Client==1,na.rm=TRUE)
reason_not_received_46_55[3,3] <- sum(age46_55_treat_dat$PreventHelp_Supported.Other==1,na.rm=TRUE)

#56-65
reason_not_received_56_65[1,2] <- sum(age56_65_treat_dat$PreventHelp_SelfGuided.Systemic==1,na.rm=TRUE)
reason_not_received_56_65[2,2] <- sum(age56_65_treat_dat$PreventHelp_SelfGuided.Client==1,na.rm=TRUE)
reason_not_received_56_65[3,2] <- sum(age56_65_treat_dat$PreventHelp_SelfGuided.Other==1,na.rm=TRUE)
reason_not_received_56_65[1,3] <- sum(age56_65_treat_dat$PreventHelp_Supported.Systemic==1,na.rm=TRUE)
reason_not_received_56_65[2,3] <- sum(age56_65_treat_dat$PreventHelp_Supported.Client==1,na.rm=TRUE)
reason_not_received_56_65[3,3] <- sum(age56_65_treat_dat$PreventHelp_Supported.Other==1,na.rm=TRUE)

#66-75
reason_not_received_66_75[1,2] <- sum(age66_75_treat_dat$PreventHelp_SelfGuided.Systemic==1,na.rm=TRUE)
reason_not_received_66_75[2,2] <- sum(age66_75_treat_dat$PreventHelp_SelfGuided.Client==1,na.rm=TRUE)
reason_not_received_66_75[3,2] <- sum(age66_75_treat_dat$PreventHelp_SelfGuided.Other==1,na.rm=TRUE)
reason_not_received_66_75[1,3] <- sum(age66_75_treat_dat$PreventHelp_Supported.Systemic==1,na.rm=TRUE)
reason_not_received_66_75[2,3] <- sum(age66_75_treat_dat$PreventHelp_Supported.Client==1,na.rm=TRUE)
reason_not_received_66_75[3,3] <- sum(age66_75_treat_dat$PreventHelp_Supported.Other==1,na.rm=TRUE)

#76+
reason_not_received_76_plus[1,2] <- sum(age76_plus_treat_dat$PreventHelp_SelfGuided.Systemic==1,na.rm=TRUE)
reason_not_received_76_plus[2,2] <- sum(age76_plus_treat_dat$PreventHelp_SelfGuided.Client==1,na.rm=TRUE)
reason_not_received_76_plus[3,2] <- sum(age76_plus_treat_dat$PreventHelp_SelfGuided.Other==1,na.rm=TRUE)
reason_not_received_76_plus[1,3] <- sum(age76_plus_treat_dat$PreventHelp_Supported.Systemic==1,na.rm=TRUE)
reason_not_received_76_plus[2,3] <- sum(age76_plus_treat_dat$PreventHelp_Supported.Client==1,na.rm=TRUE)
reason_not_received_76_plus[3,3] <- sum(age76_plus_treat_dat$PreventHelp_Supported.Other==1,na.rm=TRUE)

#TOTALS
self_guided_total_16_25 <- sum(reason_not_received_16_25$`Self guided`)
supported_total_16_25 <- sum(reason_not_received_16_25$`Supported`)
self_guided_total_26_35 <- sum(reason_not_received_26_35$`Self guided`)
supported_total_26_35 <- sum(reason_not_received_26_35$`Supported`)
self_guided_total_36_45 <- sum(reason_not_received_36_45$`Self guided`)
supported_total_36_45 <- sum(reason_not_received_36_45$`Supported`)
self_guided_total_46_55 <- sum(reason_not_received_46_55$`Self guided`)
supported_total_46_55 <- sum(reason_not_received_46_55$`Supported`)
self_guided_total_56_65 <- sum(reason_not_received_56_65$`Self guided`)
supported_total_56_65 <- sum(reason_not_received_56_65$`Supported`)
self_guided_total_66_75 <- sum(reason_not_received_66_75$`Self guided`)
supported_total_66_75 <- sum(reason_not_received_66_75$`Supported`)
self_guided_total_76_plus <- sum(reason_not_received_76_plus$`Self guided`)
supported_total_76_plus <- sum(reason_not_received_76_plus$`Supported`)

reason_not_received_percent_16_25 <- reason_not_received_16_25[,1:3]
reason_not_received_percent_26_35 <- reason_not_received_26_35[,1:3]
reason_not_received_percent_36_45 <- reason_not_received_36_45[,1:3]
reason_not_received_percent_46_55 <- reason_not_received_46_55[,1:3]
reason_not_received_percent_56_65 <- reason_not_received_56_65[,1:3]
reason_not_received_percent_66_75 <- reason_not_received_66_75[,1:3]
reason_not_received_percent_76_plus <- reason_not_received_76_plus[,1:3]

reason_not_received_percent_16_25$`Self guided` <- reason_not_received_percent_16_25$`Self guided` / self_guided_total_16_25*100
reason_not_received_percent_16_25$`Supported` <- reason_not_received_16_25$`Supported` / supported_total_16_25*100

reason_not_received_percent_26_35$`Self guided` <- reason_not_received_percent_26_35$`Self guided` / self_guided_total_26_35*100
reason_not_received_percent_26_35$`Supported` <- reason_not_received_26_35$`Supported` / supported_total_26_35*100

reason_not_received_percent_36_45$`Self guided` <- reason_not_received_percent_36_45$`Self guided` / self_guided_total_36_45*100
reason_not_received_percent_36_45$`Supported` <- reason_not_received_36_45$`Supported` / supported_total_36_45*100

reason_not_received_percent_46_55$`Self guided` <- reason_not_received_percent_46_55$`Self guided` / self_guided_total_46_55*100
reason_not_received_percent_46_55$`Supported` <- reason_not_received_46_55$`Supported` / supported_total_46_55*100

reason_not_received_percent_56_65$`Self guided` <- reason_not_received_percent_56_65$`Self guided` / self_guided_total_56_65*100
reason_not_received_percent_56_65$`Supported` <- reason_not_received_56_65$`Supported` / supported_total_56_65*100

reason_not_received_percent_66_75$`Self guided` <- reason_not_received_percent_66_75$`Self guided` / self_guided_total_66_75*100
reason_not_received_percent_66_75$`Supported` <- reason_not_received_66_75$`Supported` / supported_total_66_75*100

reason_not_received_percent_76_plus$`Self guided` <- reason_not_received_percent_76_plus$`Self guided` / self_guided_total_76_plus*100
reason_not_received_percent_76_plus$`Supported` <- reason_not_received_76_plus$`Supported` / supported_total_76_plus*100

reason_not_received_percent_16_25
reason_not_received_percent_26_35
reason_not_received_percent_36_45
reason_not_received_percent_46_55
reason_not_received_percent_56_65
reason_not_received_percent_66_75
reason_not_received_percent_76_plus
```

###**Chi square test Gender by reasons for not receiving treatment**
```{r treatment received by gender - supported and self-guided}
#supported
reason_not_received_supported <- tibble(reason = c("Systemic","Client","Other"), `Male` = 1:3, `Female` = 1:3)
reason_not_received_supported$Male <- reason_not_received_male$Supported
reason_not_received_supported$Female <- reason_not_received_female$Supported

reasons_gender_supported <- as.data.frame(reason_not_received_supported)

reasons_gender_supported_chisq <- chisq.test(reasons_gender_supported[-1])
reasons_gender_supported_chisq$p.value

reasons_gender_supported_chisq

#N for chisq test
sum(reasons_gender_supported$Male) + sum(reasons_gender_supported$Female)

#as percentages
total_male_supported <- sum(reasons_gender_supported$Male)
total_female_supported <- sum(reasons_gender_supported$Female)

reasons_gender_supported$Male_prop <- reasons_gender_supported$Male/total_male_supported*100
reasons_gender_supported$Female_prop <- reasons_gender_supported$Female/total_female_supported*100


#selfguided
reason_not_received_sg <- tibble(reason = c("Systemic","Client","Other"), `Male` = 1:3, `Female` = 1:3)
reason_not_received_sg$Male <- reason_not_received_male$`Self guided`
reason_not_received_sg$Female <- reason_not_received_female$`Self guided`

reasons_gender_sg <- as.data.frame(reason_not_received_sg)

reasons_gender_sg_chisq <- chisq.test(reasons_gender_sg[-1])
reasons_gender_sg_chisq$p.value

reasons_gender_sg_chisq

#N for chisq test
sum(reasons_gender_sg$Male) + sum(reasons_gender_sg$Female)

#as percentages
total_male_sg <- sum(reasons_gender_sg$Male)
total_female_sg <- sum(reasons_gender_sg$Female)

reasons_gender_sg$Male_prop <- reasons_gender_sg$Male/total_male_sg*100
reasons_gender_sg$Female_prop <- reasons_gender_sg$Female/total_female_sg*100

```

###**Chi square test AGE by reasons for not receiving treatment**
```{r treatment received by age - supported and self-guided}
#supported
reason_not_received_supported_age <- tibble(reason = c("Systemic","Client","Other"), `16-25` = 1:3, `26-35` = 1:3, `36-45` = 1:3, `46-55` = 1:3, `56-65` = 1:3, `66-75` = 1:3, `76_plus` = 1:3)
reason_not_received_supported_age$`16-25` <- reason_not_received_16_25$Supported
reason_not_received_supported_age$`26-35` <- reason_not_received_26_35$Supported
reason_not_received_supported_age$`36-45` <- reason_not_received_36_45$Supported
reason_not_received_supported_age$`46-55` <- reason_not_received_46_55$Supported
reason_not_received_supported_age$`56-65` <- reason_not_received_56_65$Supported
reason_not_received_supported_age$`66-75` <- reason_not_received_66_75$Supported
reason_not_received_supported_age$`76_plus` <- reason_not_received_76_plus$Supported

reasons_age_supported <- as.data.frame(reason_not_received_supported_age)

reasons_age_supported_chisq <- chisq.test(reasons_age_supported[,c(-1)])
reasons_age_supported_chisq$p.value
reasons_age_supported_chisq

#N for chisq test
sum(reasons_age_supported$`16-25`) + sum(reasons_age_supported$`26-35`) + sum(reasons_age_supported$`36-45`) + sum(reasons_age_supported$`46-55`) + sum(reasons_age_supported$`56-65`) + sum(reasons_age_supported$`66-75`) + sum(reasons_age_supported$`76_plus`) 

#as percentages
reasons_age_supported$`16-25_prop` <- reasons_age_supported$`16-25` /sum(reasons_age_supported$`16-25`)*100
reasons_age_supported$`26-35_prop` <- reasons_age_supported$`26-35` /sum(reasons_age_supported$`26-35`)*100
reasons_age_supported$`36-45_prop` <- reasons_age_supported$`36-45` /sum(reasons_age_supported$`36-45`)*100
reasons_age_supported$`46-55_prop` <- reasons_age_supported$`46-55` /sum(reasons_age_supported$`46-55`)*100
reasons_age_supported$`56-65_prop` <- reasons_age_supported$`56-65` /sum(reasons_age_supported$`56-65`)*100
reasons_age_supported$`66-75_prop` <- reasons_age_supported$`66-75` /sum(reasons_age_supported$`66-75`)*100
reasons_age_supported$`76_plus_prop` <- reasons_age_supported$`76_plus` /sum(reasons_age_supported$`76_plus`)*100

#selfguided
reason_not_received_selfguided_age <- tibble(reason = c("Systemic","Client","Other"), `16-25` = 1:3, `26-35` = 1:3, `36-45` = 1:3, `46-55` = 1:3, `56-65` = 1:3, `66-75` = 1:3, `76_plus` = 1:3)

reason_not_received_selfguided_age$`16-25` <- reason_not_received_16_25$`Self guided`
reason_not_received_selfguided_age$`26-35` <- reason_not_received_26_35$`Self guided`
reason_not_received_selfguided_age$`36-45` <- reason_not_received_36_45$`Self guided`
reason_not_received_selfguided_age$`46-55` <- reason_not_received_46_55$`Self guided`
reason_not_received_selfguided_age$`56-65` <- reason_not_received_56_65$`Self guided`
reason_not_received_selfguided_age$`66-75` <- reason_not_received_66_75$`Self guided`
reason_not_received_selfguided_age$`76_plus` <- reason_not_received_76_plus$`Self guided`

reasons_age_selfguided <- as.data.frame(reason_not_received_selfguided_age)

reasons_age_selfguided_chisq <- chisq.test(reasons_age_selfguided[,c(-1)])
reasons_age_selfguided_chisq$p.value
reasons_age_selfguided_chisq

#N for chisq test
sum(reasons_age_selfguided$`16-25`) + sum(reasons_age_selfguided$`26-35`) + sum(reasons_age_selfguided$`36-45`) + sum(reasons_age_selfguided$`46-55`) + sum(reasons_age_selfguided$`56-65`) + sum(reasons_age_selfguided$`66-75`) + sum(reasons_age_selfguided$`76_plus`)

#as percentages
reasons_age_selfguided$`16-25_prop` <- reasons_age_selfguided$`16-25` /sum(reasons_age_selfguided$`16-25`)*100
reasons_age_selfguided$`26-35_prop` <- reasons_age_selfguided$`26-35` /sum(reasons_age_selfguided$`26-35`)*100
reasons_age_selfguided$`36-45_prop` <- reasons_age_selfguided$`36-45` /sum(reasons_age_selfguided$`36-45`)*100
reasons_age_selfguided$`46-55_prop` <- reasons_age_selfguided$`46-55` /sum(reasons_age_selfguided$`46-55`)*100
reasons_age_selfguided$`56-65_prop` <- reasons_age_selfguided$`56-65` /sum(reasons_age_selfguided$`56-65`)*100
reasons_age_selfguided$`66-75_prop` <- reasons_age_selfguided$`66-75` /sum(reasons_age_selfguided$`66-75`)*100
reasons_age_selfguided$`76_plus_prop` <- reasons_age_selfguided$`76_plus` /sum(reasons_age_selfguided$`76_plus`)*100

```
###**Plot Gender by reasons for not receiving treatment**
```{r PLOT treatment received by gender - supported and self-guided}
reasons_gender_treatment <- tibble(reason = c("Systemic","Client","Other","Systemic","Client","Other"),source=c("Supported","Supported","Supported","Self-guided","Self-guided","Self-guided"), `Male` = 1:6, `Female` = 1:6)

reasons_gender_treatment$Male[1:3] <- reasons_gender_supported$Male_prop
reasons_gender_treatment$Male[4:6] <- reasons_gender_sg$Male_prop
reasons_gender_treatment$Female[1:3] <- reasons_gender_supported$Female_prop
reasons_gender_treatment$Female[4:6] <- reasons_gender_sg$Female_prop

long_reasons_gender_treatment <-  reasons_gender_treatment %>%
pivot_longer(cols = Male:Female, names_to = "Gender", values_to = "prop")

long_reasons_gender_treatment$reason <- as.factor(long_reasons_gender_treatment$reason)

long_reasons_gender_treatment$reason <- factor(long_reasons_gender_treatment$reason, levels = c("Other","Client","Systemic"),ordered = TRUE)

long_reasons_gender_treatment$source <- factor(long_reasons_gender_treatment$source, levels = c("Supported","Self-guided"),ordered = TRUE)

long_reasons_gender_treatment$Gender <- factor(long_reasons_gender_treatment$Gender, levels = c("Male","Female"),ordered = TRUE)


long_reasons_gender_treatment_plot <- long_reasons_gender_treatment %>%
  ggplot(mapping = aes(Gender, prop, fill = reason)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Type of treatment",  y = "Proportion of responses (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  coord_flip() +
  facet_grid(source ~ .) +
  scale_fill_manual(
    values = rev(COPINGpalette3)
  ) 
long_reasons_gender_treatment_plot

```

###**Plot Age by reasons for not receiving treatment**
```{r PLOT treatment received by age - supported and self-guided}
reasons_age_treatment <- tibble(reason = c("Systemic","Client","Other","Systemic","Client","Other"),source=c("Supported","Supported","Supported","Self-guided","Self-guided","Self-guided"), `16-25` = 1:6, `26-35` = 1:6, `36-45` = 1:6, `46-55` = 1:6, `56-65` = 1:6, `66-75` = 1:6, `76_plus` = 1:6)

reasons_age_treatment$`16-25`[1:3] <- reasons_age_supported$`16-25_prop`
reasons_age_treatment$`16-25`[4:6] <- reasons_age_selfguided$`16-25_prop`
reasons_age_treatment$`26-35`[1:3] <- reasons_age_supported$`26-35_prop`
reasons_age_treatment$`26-35`[4:6] <- reasons_age_selfguided$`26-35_prop`
reasons_age_treatment$`36-45`[1:3] <- reasons_age_supported$`36-45_prop`
reasons_age_treatment$`36-45`[4:6] <- reasons_age_selfguided$`36-45_prop`
reasons_age_treatment$`46-55`[1:3] <- reasons_age_supported$`46-55_prop`
reasons_age_treatment$`46-55`[4:6] <- reasons_age_selfguided$`46-55_prop`
reasons_age_treatment$`56-65`[1:3] <- reasons_age_supported$`56-65_prop`
reasons_age_treatment$`56-65`[4:6] <- reasons_age_selfguided$`56-65_prop`
reasons_age_treatment$`66-75`[1:3] <- reasons_age_supported$`66-75_prop`
reasons_age_treatment$`66-75`[4:6] <- reasons_age_selfguided$`66-75_prop`
reasons_age_treatment$`76_plus`[1:3] <- reasons_age_supported$`76_plus_prop`
reasons_age_treatment$`76_plus`[4:6] <- reasons_age_selfguided$`76_plus_prop`

long_reasons_age_treatment <-  reasons_age_treatment %>%
pivot_longer(cols = `16-25`:`76_plus`, names_to = "Age", values_to = "prop")

long_reasons_age_treatment$reason <- as.factor(long_reasons_age_treatment$reason)

long_reasons_age_treatment$reason <- factor(long_reasons_age_treatment$reason, levels = c("Other","Client","Systemic"),ordered = TRUE)

long_reasons_age_treatment$source <- factor(long_reasons_age_treatment$source, levels = c("Supported","Self-guided"),ordered = TRUE)

long_reasons_age_treatment$Age <- factor(long_reasons_age_treatment$Age, levels = c("16-25","26-35","36-45","46-55","56-65","66-75","76_plus"),ordered = TRUE)

long_reasons_age_treatment_plot <- long_reasons_age_treatment %>%
  ggplot(mapping = aes(Age, prop, fill = reason)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  theme(legend.position = "right", legend.title = element_blank())  +
  labs(x = "Age",  y = "Proportion of responses (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  coord_flip() +
  facet_grid(source ~ .) +
  scale_fill_manual(
    values = rev(COPINGpalette3)
  ) 
long_reasons_age_treatment_plot

```
###**Chi square test Gender by Type of treatment sought**
```{r treatment sought supported vs. self-guided}
tx_supported <- treat_dat %>%
  group_by(Gender) %>%
  count(TypeSought.Supported.Any)

tx_selfguided <- treat_dat %>%
  group_by(Gender) %>%
  count(TypeSought.SelfGuide.Any)

#summarise to just male-female for chi-square
tx_supported_mf <- tx_supported[c(10:11,13:14),]
tx_selfguided_mf <- tx_selfguided[c(10:11,13:14),]
#compare nbsd
tx_supported_nbsd <- tx_supported[c(16:17,19:20),]
tx_selfguided_nbsd <- tx_selfguided[c(16:17,19:20),]

tx_supported_nbsd <- pivot_wider(tx_supported_nbsd,names_from = TypeSought.Supported.Any, values_from = n)
total_supported_nbsd <- sum(tx_supported_nbsd$`Sought Supported`)

tx_selfguided_nbsd <- pivot_wider(tx_selfguided_nbsd,names_from = TypeSought.SelfGuide.Any, values_from = n)
total_selfguided_nbsd <- sum(tx_selfguided_nbsd$`Sought Self-guided`)

#prop_sought_supported_nbsd
print("prop_sought_supported_nbsd: ")
total_supported_nbsd/(total_supported_nbsd+total_selfguided_nbsd)*100 

#prop_sought_selfguided_nbsd
print("prop_sought_selfguided_nbsd: ")
total_selfguided_nbsd/(total_supported_nbsd+total_selfguided_nbsd)*100 

tx_prop_mf <- tx_supported_mf[1]
tx_prop_mf[1,2] <- "Supported"
tx_prop_mf[2,2] <- "Self guided"
tx_prop_mf[3,2] <- "Supported"
tx_prop_mf[4,2] <- "Self guided"
colnames(tx_prop_mf)[2] <- "Type"

tx_prop_mf[1,3] <- tx_supported_mf$n[2]
tx_prop_mf[2,3] <- tx_selfguided_mf$n[2]
tx_prop_mf[3,3] <- tx_supported_mf$n[4]
tx_prop_mf[4,3] <- tx_selfguided_mf$n[4]

colnames(tx_prop_mf)[3] <- "n"

wide_tx_prop_mf <- tx_prop_mf %>%
pivot_wider(id_cols = Gender, names_from = Type, values_from = n)

wide_tx_prop_mf <- wide_tx_prop_mf %>%
  as.data.frame()

tx_gender_chisq <- chisq.test(wide_tx_prop_mf[-1])

tx_gender_chisq

#as proportions
wide_tx_prop_mf$prop_supported <- wide_tx_prop_mf$Supported/(wide_tx_prop_mf$`Self guided` + wide_tx_prop_mf$Supported)
wide_tx_prop_mf$prop_selfguided <- wide_tx_prop_mf$`Self guided`/(wide_tx_prop_mf$`Self guided` + wide_tx_prop_mf$Supported)

wide_tx_prop_mf

#N for chisq test
sum(wide_tx_prop_mf$Supported) + sum(wide_tx_prop_mf$`Self guided`)
```
###**Chi square test Age by Type of treatment sought**
```{r treatment sought supported vs. self-guided - age}
tx_supported_age <- treat_dat %>%
  group_by(AgeRecoded) %>%
  count(TypeSought.Supported.Any)

tx_selfguided_age <- treat_dat %>%
  group_by(AgeRecoded) %>%
  count(TypeSought.SelfGuide.Any)

#summarise to just ages of interest for chi-square
tx_supported_age <- tx_supported_age[c(2:3,5:6,8:9,11:12,14:15,17:18,20:21),]
tx_selfguided_age <- tx_selfguided_age[c(2:3,5:6,8:9,11:12,14:15,17:18,20:21),]

tx_prop_age <- tx_supported_age[1]
tx_prop_age[c(1,3,5,7,9,11,13),2] <- "Supported"
tx_prop_age[c(2,4,6,8,10,12,14),2] <- "Self guided"
colnames(tx_prop_age)[2] <- "Type"

tx_prop_age[1,3] <- tx_supported_age$n[2]
tx_prop_age[2,3] <- tx_selfguided_age$n[2]
tx_prop_age[3,3] <- tx_supported_age$n[4]
tx_prop_age[4,3] <- tx_selfguided_age$n[4]
tx_prop_age[5,3] <- tx_supported_age$n[6]
tx_prop_age[6,3] <- tx_selfguided_age$n[6]
tx_prop_age[7,3] <- tx_supported_age$n[8]
tx_prop_age[8,3] <- tx_selfguided_age$n[8]
tx_prop_age[9,3] <- tx_supported_age$n[10]
tx_prop_age[10,3] <- tx_selfguided_age$n[10]
tx_prop_age[11,3] <- tx_supported_age$n[12]
tx_prop_age[12,3] <- tx_selfguided_age$n[12]
tx_prop_age[13,3] <- tx_supported_age$n[14]
tx_prop_age[14,3] <- tx_selfguided_age$n[14]

colnames(tx_prop_age)[3] <- "n"

wide_tx_prop_age <- tx_prop_age %>%
pivot_wider(id_cols = AgeRecoded, names_from = Type, values_from = n)

wide_tx_prop_age <- wide_tx_prop_age %>%
  as.data.frame()

tx_age_chisq <- chisq.test(wide_tx_prop_age[1:7,2:3])
tx_age_chisq

#as proportions
wide_tx_prop_age$prop_supported <- wide_tx_prop_age$Supported/(wide_tx_prop_age$`Self guided` + wide_tx_prop_age$Supported)*100
wide_tx_prop_age$prop_selfguided <- wide_tx_prop_age$`Self guided`/(wide_tx_prop_age$`Self guided` + wide_tx_prop_age$Supported)*100

wide_tx_prop_age

#N for chisq test
sum(wide_tx_prop_age$Supported) + sum(wide_tx_prop_age$`Self guided`)
```
###**Plot Gender by Type of treatment sought**
```{r Plot treatment sought supported vs. self-guided}

percent_treatment_type_gender <- wide_tx_prop_mf[,c(1,4:5)]
colnames(percent_treatment_type_gender)[2] <- "Supported"
colnames(percent_treatment_type_gender)[3] <- "Self-guided"
percent_treatment_type_gender <- percent_treatment_type_gender %>%  pivot_longer(!Gender,names_to="type",values_to = "percent")
percent_treatment_type_gender$percent <- percent_treatment_type_gender$percent*100

percent_treatment_type_gender_plot <- percent_treatment_type_gender %>%
  ggplot(mapping = aes(Gender, percent, fill = type)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  labs( x = "Gender",  y = "Proportion of sample (%)") +
  theme_personal +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "top", legend.title = element_blank())  +
    scale_fill_manual(
    values = rev(COPINGpalette2)
  ) + 
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  guides(fill=guide_legend(nrow=3,byrow=TRUE))

percent_treatment_type_gender_plot

```

###**Plot Age by Type of treatment sought**
```{r Plot treatment sought supported vs. self-guided - age}

percent_treatment_type_age <- wide_tx_prop_age[,c(1,4:5)]
colnames(percent_treatment_type_age)[2] <- "Supported"
colnames(percent_treatment_type_age)[3] <- "Self-guided"
percent_treatment_type_age <- percent_treatment_type_age %>%  pivot_longer(!AgeRecoded,names_to="type",values_to = "percent")

percent_treatment_type_age_plot <- percent_treatment_type_age %>%
  ggplot(mapping = aes(AgeRecoded, percent, fill = type)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  labs( x = "Age",  y = "Proportion of sample (%)") +
  theme_personal +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "top", legend.title = element_blank())  +
    scale_fill_manual(
    values = rev(COPINGpalette2)
  ) + 
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  guides(fill=guide_legend(nrow=3,byrow=TRUE))

percent_treatment_type_age_plot

```

###**Chi square test Gender by Treatment seeking and gap**
```{r Chi square test Gender by Treatment gap}

treat_dat_seek_gender <- treat_dat %>%
  group_by(Gender) %>%
  count(soughthelp_for_self)
  
treat_dat_gap_gender <- treat_dat %>%
  group_by(Gender) %>%
  count(AnyReceived)

#pivot wider
treat_dat_seek_gender <- pivot_wider(treat_dat_seek_gender, names_from = soughthelp_for_self, values_from = n) 
treat_dat_gap_gender <- pivot_wider(treat_dat_gap_gender, names_from = AnyReceived, values_from = n) 

#extract nbsd
treat_dat_seek_nbsd <- tibble(sought = 1)
treat_dat_gap_nbsd <- tibble(received = 1)

treat_dat_seek_nbsd$sought <- sum(treat_dat_seek_gender$`1`[6:7])
treat_dat_seek_nbsd$not_sought <- sum(treat_dat_seek_gender$`0`[6:7])

treat_dat_gap_nbsd$received <- sum(treat_dat_gap_gender$`1`[6:7])
treat_dat_gap_nbsd$not_received <- treat_dat_seek_nbsd$sought - treat_dat_gap_nbsd$received

#as proportions
treat_dat_seek_nbsd$prop_sought <- treat_dat_seek_nbsd$sought/(treat_dat_seek_nbsd$sought+treat_dat_seek_nbsd$not_sought)*100
treat_dat_seek_nbsd$prop_not_sought <- treat_dat_seek_nbsd$not_sought/(treat_dat_seek_nbsd$sought+treat_dat_seek_nbsd$not_sought)*100
print("Proportion of NB-SD gender seeking treatment: ")
treat_dat_seek_nbsd

treat_dat_gap_nbsd$prop_received <- treat_dat_gap_nbsd$received/(treat_dat_gap_nbsd$received+treat_dat_gap_nbsd$not_received)*100
treat_dat_gap_nbsd$prop_not_received <- treat_dat_gap_nbsd$not_received/(treat_dat_gap_nbsd$received+treat_dat_gap_nbsd$not_received)*100
print("Proportion of NB-SD gender receiving treatment: ")
treat_dat_gap_nbsd

#limit to just male and female
treat_dat_seek_gender <- treat_dat_seek_gender[4:5,]
treat_dat_gap_gender <- treat_dat_gap_gender[4:5,]

#drop NAs
treat_dat_seek_gender <- treat_dat_seek_gender[,-c(4)]

#test for gender difference in treatment seeking
colnames(treat_dat_seek_gender)[3] <- "n sought"
colnames(treat_dat_seek_gender)[2] <- "n not sought"

treat_dat_seek_gender <- treat_dat_seek_gender %>%
  as.data.frame()

tx_seek_gender_chisq <- chisq.test(treat_dat_seek_gender[-1])
print("Gender treatment seeking chisq: ")

tx_seek_gender_chisq
#as proportions
treat_dat_seek_gender$prop_sought <- treat_dat_seek_gender$`n sought`/(treat_dat_seek_gender$`n sought`+treat_dat_seek_gender$`n not sought`)
treat_dat_seek_gender$prop_not_sought <- treat_dat_seek_gender$`n not sought`/(treat_dat_seek_gender$`n sought`+treat_dat_seek_gender$`n not sought`)

#combine seeking and gap - test for gender difference in treatment gap
treat_dat_seek_gender

#===================================
#limit to just those seeking

treat_dat_gap_gender <- treat_dat_gap_gender[,c(1,3)]
treat_dat_gap_gender$total_sought <- treat_dat_seek_gender$`n sought`
colnames(treat_dat_seek_gender)[2] <- "n sought"
colnames(treat_dat_gap_gender)[2] <- "n received"

treat_dat_gap_gender$`n not received` <- treat_dat_gap_gender$total_sought - treat_dat_gap_gender$`n received`

treat_dat_gap_gender <- treat_dat_gap_gender[,c(1,2,4)]

treat_dat_gap_gender <- treat_dat_gap_gender %>%
  as.data.frame()

tx_gender_chisq <- chisq.test(treat_dat_gap_gender[-1])

print("Gender treatment receipt chisq: ")
tx_gender_chisq
#as proportions
treat_dat_gap_gender$prop_received <- treat_dat_gap_gender$`n received`/(treat_dat_gap_gender$`n received`+treat_dat_gap_gender$`n not received`)
treat_dat_gap_gender$prop_not_received <- treat_dat_gap_gender$`n not received`/(treat_dat_gap_gender$`n received`+treat_dat_gap_gender$`n not received`)

treat_dat_gap_gender

#N for chisq test
sum(treat_dat_gap_gender$`n received`) + sum(treat_dat_gap_gender$`n not received`)
```

###**Chi square test AGE by Treatment seeking and gap**
```{r Chi square test AGE by Treatment gap}

treat_dat_seek_age <- treat_dat %>%
  group_by(AgeRecoded) %>%
  count(soughthelp_for_self)
  
treat_dat_gap_age <- treat_dat %>%
  group_by(AgeRecoded) %>%
  count(AnyReceived)

#pivot wider
treat_dat_seek_age <- pivot_wider(treat_dat_seek_age, names_from = soughthelp_for_self, values_from = n) 
treat_dat_gap_age <- pivot_wider(treat_dat_gap_age, names_from = AnyReceived, values_from = n) 

#limit to real answers
treat_dat_seek_age <- treat_dat_seek_age[2:8,]
treat_dat_gap_age <- treat_dat_gap_age[2:8,]

#drop NAs
treat_dat_seek_age <- treat_dat_seek_age[,-c(2)]
treat_dat_gap_age <- treat_dat_gap_age[,-c(2)]

#test for age difference in treatment seeking
colnames(treat_dat_seek_age)[3] <- "n sought"
colnames(treat_dat_seek_age)[2] <- "n not sought"

treat_dat_seek_age <- treat_dat_seek_age %>%
  as.data.frame()

tx_seek_age_chisq <- chisq.test(treat_dat_seek_age[-1])
print("Age treatment seeking chisq: ")
tx_seek_age_chisq

#as proportions
treat_dat_seek_age$prop_sought <- treat_dat_seek_age$`n sought`/(treat_dat_seek_age$`n sought`+treat_dat_seek_age$`n not sought`)*100
treat_dat_seek_age$prop_not_sought <- treat_dat_seek_age$`n not sought`/(treat_dat_seek_age$`n sought`+treat_dat_seek_age$`n not sought`)*100

#combine seeking and gap - test for age difference in treatment gap
treat_dat_seek_age

#N for chisq test
sum(treat_dat_seek_age$`n not sought`) + sum(treat_dat_seek_age$`n sought`)

#===================================
#limit to just those seeking

treat_dat_gap_age <- treat_dat_gap_age[,c(1,3)]
treat_dat_gap_age$total_sought <- treat_dat_seek_age$`n sought`
colnames(treat_dat_seek_age)[2] <- "n sought"
colnames(treat_dat_gap_age)[2] <- "n received"

treat_dat_gap_age$`n not received` <- treat_dat_gap_age$total_sought - treat_dat_gap_age$`n received`

treat_dat_gap_age <- treat_dat_gap_age[,c(1,2,4)]

treat_dat_gap_age <- treat_dat_gap_age %>%
  as.data.frame()

tx_age_chisq <- chisq.test(treat_dat_gap_age[-1])

print("Age treatment receipt chisq: ")
tx_age_chisq
#as proportions
treat_dat_gap_age$prop_received <- treat_dat_gap_age$`n received`/(treat_dat_gap_age$`n received`+treat_dat_gap_age$`n not received`)*100
treat_dat_gap_age$prop_not_received <- treat_dat_gap_age$`n not received`/(treat_dat_gap_age$`n received`+treat_dat_gap_age$`n not received`)*100

treat_dat_gap_age

#N for chisq test
sum(treat_dat_gap_age$`n received`) + sum(treat_dat_gap_age$`n not received`)
```
###*Plot treatment seeking by gender*
```{r plot treatment seeking by gender}

treat_dat_seek_gender_for_plot <- treat_dat_seek_gender[c(1,4:5)]
treat_dat_seek_gender_for_plot$prop_sought <- treat_dat_seek_gender_for_plot$prop_sought*100
treat_dat_seek_gender_for_plot$prop_not_sought <- treat_dat_seek_gender_for_plot$prop_not_sought*100
colnames(treat_dat_seek_gender_for_plot)[2] <- "Sought"
colnames(treat_dat_seek_gender_for_plot)[3] <- "Not sought"

treat_dat_seek_gender_for_plot <- treat_dat_seek_gender_for_plot %>%
  pivot_longer(!Gender, names_to = "sought",values_to = "percent")

treat_dat_seek_gender_for_plot$sought <- as.factor(treat_dat_seek_gender_for_plot$sought)

treat_dat_seek_gender_for_plot$sought <- factor(treat_dat_seek_gender_for_plot$sought, levels=c("Not sought","Sought"), ordered=TRUE)

treat_dat_seek_gender_plot <- treat_dat_seek_gender_for_plot %>%
  ggplot(mapping = aes(Gender, percent, fill = sought)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  labs( x = "Gender",  y = "Proportion of sample (%)") +
  theme_personal +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "top", legend.title = element_blank())  +
    scale_fill_manual(
    values = rev(COPINGpalette2)
  ) + 
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  guides(fill=guide_legend(nrow=3,byrow=TRUE))

treat_dat_seek_gender_plot

```
###*Plot treatment seeking by age*
```{r plot treatment seeking by age}

treat_dat_seek_age_for_plot <- treat_dat_seek_age[c(1,4:5)]
colnames(treat_dat_seek_age_for_plot)[2] <- "Sought"
colnames(treat_dat_seek_age_for_plot)[3] <- "Not sought"

treat_dat_seek_age_for_plot <- treat_dat_seek_age_for_plot %>%
  pivot_longer(!AgeRecoded, names_to = "sought",values_to = "percent")

treat_dat_seek_age_for_plot$sought <- as.factor(treat_dat_seek_age_for_plot$sought)

treat_dat_seek_age_for_plot$sought <- factor(treat_dat_seek_age_for_plot$sought, levels=c("Not sought","Sought"), ordered=TRUE)

treat_dat_seek_age_plot <- treat_dat_seek_age_for_plot %>%
  ggplot(mapping = aes(AgeRecoded, percent, fill = sought)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  labs( x = "Age",  y = "Proportion of sample (%)") +
  theme_personal +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "top", legend.title = element_blank())  +
    scale_fill_manual(
    values = rev(COPINGpalette2)
  ) + 
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  guides(fill=guide_legend(nrow=3,byrow=TRUE))

treat_dat_seek_age_plot

```
###*Plot treatment gap by gender*
```{r plot treatment gap by gender}

treat_dat_gap_gender_plot <- treat_dat_gap_gender[c(1,4:5)]
colnames(treat_dat_gap_gender_plot)[2] <- "Received"
colnames(treat_dat_gap_gender_plot)[3] <- "Not received"
treat_dat_gap_gender_plot <- treat_dat_gap_gender_plot %>%
  pivot_longer(!Gender, names_to = "received",values_to = "percent")

treat_dat_gap_gender_plot$percent <- treat_dat_gap_gender_plot$percent*100
treat_dat_gap_gender_plot$received <- as.factor(treat_dat_gap_gender_plot$received)

treat_dat_gap_gender_plot$received <- factor(treat_dat_gap_gender_plot$received, levels=c("Not received","Received"), ordered=TRUE)

treat_dat_gap_gender_ggplot <- treat_dat_gap_gender_plot %>%
  ggplot(mapping = aes(Gender, percent, fill = received)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  labs( x = "Gender",  y = "Proportion of sample (%)") +
  theme_personal +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "top", legend.title = element_blank())  +
    scale_fill_manual(
    values = rev(COPINGpalette2)
  ) + 
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  guides(fill=guide_legend(nrow=3,byrow=TRUE))

treat_dat_gap_gender_ggplot

```

###*Plot treatment gap by age*
```{r plot treatment gap by age}

treat_dat_gap_age_plot <- treat_dat_gap_age[c(1,4:5)]
colnames(treat_dat_gap_age_plot)[2] <- "Received"
colnames(treat_dat_gap_age_plot)[3] <- "Not received"
treat_dat_gap_age_plot <- treat_dat_gap_age_plot %>%
  pivot_longer(!AgeRecoded, names_to = "received",values_to = "percent")

treat_dat_gap_age_plot$received <- as.factor(treat_dat_gap_age_plot$received)

treat_dat_gap_age_plot$received <- factor(treat_dat_gap_age_plot$received, levels=c("Not received","Received"), ordered=TRUE)

treat_dat_gap_age_ggplot <- treat_dat_gap_age_plot %>%
  ggplot(mapping = aes(AgeRecoded, percent, fill = received)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  labs( x = "Age",  y = "Proportion of sample (%)") +
  theme_personal +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "top", legend.title = element_blank())  +
    scale_fill_manual(
    values = rev(COPINGpalette2)
  ) + 
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  guides(fill=guide_legend(nrow=3,byrow=TRUE))

treat_dat_gap_age_ggplot

```
By sample

###**Ordinal logistic regression: tx_type*helpfulness**

```{r OLR treatment type and helpfulness}
if(!require(MASS)){
  install.packages("MASS")
  library(MASS)
}

require(foreign)
require(MASS)
require(Hmisc)
require(reshape2)

helpfulness_freq_supported <- treat_dat %>%
  freq(Helpfulness_Supported)

helpfulness_freq_self_guided <- treat_dat %>%
  freq(Helpfulness_SelfGuided)

helpfulness_supported <- as.data.frame(helpfulness_freq_supported)
helpfulness_selfguided <- as.data.frame(helpfulness_freq_self_guided)

helpfulness_freq <- helpfulness_supported[1:7,c(1,2)]
colnames(helpfulness_freq)[1] <- "Supported"
helpfulness_freq$`Self guided` <- helpfulness_selfguided[1:7,1]
helpfulness_freq$`% Valid` <- NULL

helpfulness_freq$labels <- c("Extremely unhelpful","Very unhelpful","Somewhat unhelpful","Neither helpful nor unhelpful","Somewhat helpful","Very helpful","Extremely helpful")

long_helpfulness_freq <-  helpfulness_freq %>%
pivot_longer(!labels, names_to = "Type", values_to = "n")

#Apply OLR see - https://stats.idre.ucla.edu/r/dae/ordinal-logistic-regression/
long_helpfulness_freq$labels <- as.factor(long_helpfulness_freq$labels)
m <- polr(labels ~ Type + n, data = long_helpfulness_freq, Hess=TRUE)
summary(m)

#calculate p values
ctable <- coef(summary(m))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
(ctable <- cbind(ctable, "p value" = p))
#calculate confidence intervals
(ci <- confint(m)) 

```

###**Ordinal logistic regression: gender*helpfulness**
```{r OLR gender and helpfulness}

#group helpfulness by gender
gender_helpful_self_guide <- treat_dat %>%
  group_by(Gender) %>%
  freq(Helpfulness_SelfGuided)

gender_helpful_supported <- treat_dat %>%
  group_by(Gender) %>%
  freq(Helpfulness_Supported)

#limit to just M and F
gender_helpful_self_guide <- gender_helpful_self_guide[-c(1:3,6:8)]
gender_helpful_supported <- gender_helpful_supported[-c(1:3,6:8)]

MF_helpful_self_guide <- as.data.frame(gender_helpful_self_guide)
MF_helpful_supported <- as.data.frame(gender_helpful_supported)

#limit to just frequency column, remove NA/total rows
MF_helpful_self_guide <- MF_helpful_self_guide[-c(8:9),c(1,6)]
MF_helpful_supported <- MF_helpful_supported[-c(8:9),c(1,6)]

#rename columns
colnames(MF_helpful_self_guide)[1] <- "Male"
colnames(MF_helpful_supported)[1] <- "Male"
colnames(MF_helpful_self_guide)[2] <- "Female"
colnames(MF_helpful_supported)[2] <- "Female"
MF_helpful_self_guide$labels <- c("Extremely unhelpful","Very unhelpful","Somewhat unhelpful","Neither helpful nor unhelpful","Somewhat helpful","Very helpful","Extremely helpful")
MF_helpful_supported$labels <- c("Extremely unhelpful","Very unhelpful","Somewhat unhelpful","Neither helpful nor unhelpful","Somewhat helpful","Very helpful","Extremely helpful")

long_MF_helpful_self_guide <- MF_helpful_self_guide %>% 
pivot_longer(!labels, names_to = "Gender", values_to = "n")

long_MF_helpful_supported <- MF_helpful_supported %>% pivot_longer(!labels, names_to = "Gender", values_to = "n")

long_MF_helpful_self_guide$labels <- as.factor(long_MF_helpful_self_guide$labels)
long_MF_helpful_supported$labels <- as.factor(long_MF_helpful_supported$labels)
```

####Effect of gender on helpfulness: self-guided interventions
```{r Effect of gender on helpfulness: self-guided interventions}

#Apply OLR see - https://stats.idre.ucla.edu/r/dae/ordinal-logistic-regression/

#effect of gender on helpfulness - self guided
m_mf_self <- polr(labels ~ Gender + n, data = long_MF_helpful_self_guide, Hess=TRUE)
summary(m_mf_self)

#calculate p values
ctable_mf_self <- coef(summary(m_mf_self))
p_mf_self <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
(ctable_mf_self <- cbind(ctable_mf_self, "p value" = p_mf_self))
(ci_mf_self <- confint(m_mf_self)) 
```

####Effect of gender on helpfulness: supported interventions
```{r Effect of gender on helpfulness: supported interventions}
#effect of gender on helpfulness - supported
m_mf_supp <- polr(labels ~ Gender + n, data = long_MF_helpful_supported, Hess=TRUE)
summary(m_mf_supp)

#calculate p values
ctable_mf_supp <- coef(summary(m_mf_supp))
p_mf_supp <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
(ctable_mf_supp <- cbind(ctable_mf_supp, "p value" = p_mf_supp))
(ci_mf_supp <- confint(m_mf_supp)) 

```
####**Effect of gender on helpfulness: plots**
```{r Effect of gender on helpfulness: plots,eval=FALSE}

#convert to percent

MF_helpful_self_guide_prop <- MF_helpful_self_guide
MF_helpful_supported_prop <- MF_helpful_supported
  
MF_helpful_self_guide_prop$Male <- MF_helpful_self_guide$Male/sum(MF_helpful_self_guide$Male)*100
MF_helpful_self_guide_prop$Female <- MF_helpful_self_guide$Female/sum(MF_helpful_self_guide$Female)*100

MF_helpful_supported_prop$Male <- MF_helpful_supported$Male/sum(MF_helpful_supported$Male)*100
MF_helpful_supported_prop$Female <- MF_helpful_supported$Female/sum(MF_helpful_supported$Female)*100

#pivot longer
long_MF_helpful_self_guide <- MF_helpful_self_guide_prop %>%
  pivot_longer(Male:Female, names_to = "Gender", values_to = "percent")

long_MF_helpful_supported <- MF_helpful_supported_prop %>%
  pivot_longer(Male:Female, names_to = "Gender", values_to = "percent")

long_MF_helpful <- long_MF_helpful_self_guide
colnames(long_MF_helpful)[3] <- "self_guided"
long_MF_helpful$supported <- long_MF_helpful_supported$percent

long_MF_helpful <- long_MF_helpful %>%
  pivot_longer(self_guided:supported, names_to = "Type", values_to= "percent")

MF_helpfulness_plot <- long_MF_helpful %>%
  ggplot(mapping = aes(Gender, percent, fill = labels)
    ) +
    geom_bar(aes(),
      stat="identity",
     position = "stack"
    ) +
  theme(legend.position = "right", legend.title = element_blank())  +
  facet_grid(. ~ Type) +
  labs( x = "Type of treatment",  y = "Proportion of responses (%)") +
  theme_personal +
  theme(legend.title = element_blank()) +
  theme(legend.text = element_text(size = 8)) +
  theme(legend.key.size = unit(.25, "cm")) +
  scale_fill_manual(
    values = (RAMPlikertpalette)
  ) 
MF_helpfulness_plot
```

```{r treatment seeking freq by wave by sample gender,eval=FALSE}

treat_dat %>%
  group_by(wave,Sample,Gender) %>%
  freq(soughthelp_for_self)

```

### Reasons by gender


***Emergency mental health team***
```{r barriers by agency em mh gendergender,eval=FALSE}

treat_dat %>%
  group_by(wave,Gender) %>%
  freq(preventhelp_emergency_mh)

```
By sample
```{r barriers by agency em mh by samplegender,eval=FALSE}

treat_dat %>%
  group_by(wave,Sample,Gender) %>%
  freq(preventhelp_emergency_mh)

```

***Existing mental health team***
```{r barriers by agency existing mh gendergender,eval=FALSE}

treat_dat %>%
  group_by(wave,Gender) %>%
  freq(preventhelp_existing_mh_team)

```
By sample
```{r barriers by agency existing mh by samplegender,eval=FALSE}

treat_dat %>%
  group_by(wave,Sample,Gender) %>%
  freq(preventhelp_existing_mh_team)

```

***Online talk therapy***
```{r barriers by agency online talk gendergender,eval=FALSE}

treat_dat %>%
  group_by(wave,Gender) %>%
  freq(preventhelp_online_talk_therapy)

```
By sample
```{r barriers by agency online talk by sample gender,eval=FALSE}

treat_dat %>%
  group_by(wave,Sample,Gender) %>%
  freq(preventhelp_online_talk_therapy)

```

***GP***
```{r barriers by agency GP gendergender,eval=FALSE}

treat_dat %>%
  group_by(wave,Gender) %>%
  freq(preventhelp_gp)

```
By sample
```{r barriers by agency gp by samplegender,eval=FALSE}

treat_dat %>%
  group_by(wave,Sample,Gender) %>%
  freq(preventhelp_gp)

```

***NHS 111***
```{r barriers by agency nhs 111 gendergender,eval=FALSE}

treat_dat %>%
  group_by(wave,Gender) %>%
  freq(preventhelp_nhs_111)

```
By sample
```{r barriers by agency nhs 111 by sample gendergender,eval=FALSE}

treat_dat %>%
  group_by(wave,Sample,Gender) %>%
  freq(preventhelp_nhs_111)

```

***Non NHS phone***
```{r barriers by agency phone gendergender,eval=FALSE}

treat_dat %>%
  group_by(wave,Gender) %>%
  freq(preventhelp_nonnhs_phone)

```
By sample
```{r barriers by agencyphone by samplegender,eval=FALSE}

treat_dat %>%
  group_by(wave,Sample,Gender) %>%
  freq(preventhelp_nonnhs_phone)

```

#### Self guided

***Government website***
```{r barriers by agency gov sitegender,eval=FALSE}

treat_dat %>%
  group_by(wave,Gender) %>%
  freq(preventhelp_gov_website)

```
By sample
```{r barriers by agency gove site by samplegender,eval=FALSE}

treat_dat %>%
  group_by(wave,Sample,Gender) %>%
  freq(preventhelp_gov_website)

```

***Non-government website***
```{r barriers by agency non gov sitegender,eval=FALSE}

treat_dat %>%
  group_by(wave,Gender) %>%
  freq(preventhelp_nongov_website)

```
By sample
```{r barriers by agency non gov site by samplegender,eval=FALSE}

treat_dat %>%
  group_by(wave,Sample,Gender) %>%
  freq(preventhelp_nongov_website)

```

***Online self-therapy***
```{r barriers by agency online self therapygender,eval=FALSE}

treat_dat %>%
  group_by(wave,Gender) %>%
  freq(preventhelp_online_self_therapy)

```
By sample
```{r barriers by agency online self therapy by samplegender,eval=FALSE}

treat_dat %>%
  group_by(wave,Sample,Gender) %>%
  freq(preventhelp_online_self_therapy)

```

***Structured therapeutic activity***
```{r barriers by agency structured therapeutic activitygender,eval=FALSE}

treat_dat %>%
  group_by(wave,Gender) %>%
  freq(preventhelp_struc_therapy)

```
By sample
```{r barriers by agency structured therapeutic activity by samplegender,eval=FALSE}

treat_dat %>%
  group_by(wave,Sample,Gender) %>%
  freq(preventhelp_struc_therapy)

```

### Why not seek treatment by gender

```{r no treat seek by gen feel fine,eval=FALSE}

treat_dat %>%
  group_by(Gender) %>%
  freq(reasonNohelp_feel_fine)

```

```{r no treat seek by gen feel better,eval=FALSE}

treat_dat %>%
  group_by(Gender) %>%
  freq(reasonNohelp_I_feel_better)

```

```{r no treat seek by dont feel bad,eval=FALSE}

treat_dat %>%
  group_by(Gender) %>%
  freq(reasonNohelp_I_dont_think_I_feel_bad_enough)

```

```{r no treat seek want it dont think its there,eval=FALSE}

treat_dat %>%
  group_by(Gender) %>%
  freq(reasonNohelp_I_want_help_dont_think_its_available)

```

```{r no treat seek past bad experiences,eval=FALSE}

treat_dat %>%
  group_by(Gender) %>%
  freq(reasonNohelp_Bad_experiences_in_past)

```

```{r no treat seek want it havent,eval=FALSE}

treat_dat %>%
  group_by(Gender) %>%
  freq(reasonNohelp_I_want_to_but_havent)

```


```{r no treat seek too busy,eval=FALSE}

treat_dat %>%
  group_by(Gender) %>%
  freq(reasonNohelp_Too_busy)

```

```{r no treat seek didnt know,eval=FALSE}

treat_dat %>%
  group_by(Gender) %>%
  freq(reasonNohelp_I_didnt_know_where_to_find)

```

```{r no treat seek reasonNohelp_other,eval=FALSE}

treat_dat %>%
  group_by(Gender) %>%
  freq(reasonNohelp_other)

```


### Frequency of different levels of helpfulness by treatment type (supported/client led) by wave by gender

**For supported options**
```{r check helpfulness by wave supported Gender,eval=FALSE}
treat_dat %>%
  group_by(wave,Gender) %>%
  freq(Helpfulness_Supported)
```
By sample
```{r check helpfulness by wave supported by sample Gender,eval=FALSE}
treat_dat %>%
  group_by(wave,Sample,Gender) %>%
  freq(Helpfulness_Supported)
```

**For  client led options**
```{r check helpfulness by wave client led Gender,eval=FALSE}
treat_dat %>%
  group_by(wave,Gender) %>%
  freq(Helpfulness_SelfGuided)
```
By sample
```{r check helpfulness by wave client led by sample Gender,eval=FALSE}
treat_dat %>%
  group_by(wave,Sample,Gender) %>%
  freq(Helpfulness_SelfGuided)
```

## *Multi-panel plot*
```{r multi-panel plot graphs together, fig.height=10,fig.width=7.8}

p1 <- ggarrange(NULL,NULL,treat_dat_received_plot,treat_dat_seek_count_plot,
          labels = c("A: Treatment *seeking*","B: Reasons for seeking treatment","",""),hjust = 0,
          ncol = 2, nrow =2,heights=c(.1,1))
  
p2 <- ggarrange(pie, 
          labels = c("C: Reasons for not seeking treatment"),hjust = 0,vjust=1,
          ncol = 1, nrow =1)

p3 <- ggarrange(NULL,NULL,treat_dat_not_received_plot, helpfulness_plot,
          labels = c("D: Reasons for not receiving treatment","E: Treatment helpfulness","",""),hjust = 0,
          ncol = 2, nrow =2,widths=c(.95,1.05),heights=c(.1,1))

multiplot <- ggarrange(p1,NULL,p2,NULL,p3,ncol=1,nrow=5,heights = c(1,.05,1,.05,1))

multiplot

```

## *Gender multi-panel plot*
```{r Gender multi-panel plot, fig.height=10,fig.width=10}

gp1 <- ggarrange(NULL,NULL,NULL,treat_dat_seek_gender_plot,percent_treatment_type_gender_plot+ rremove("ylab"),treat_dat_gap_gender_ggplot+ rremove("ylab"), 
          labels = c("A: Treatment *seeking*","B: Type of treatment sought","C:Treatment receipt","","",""),hjust = 0,
          ncol = 3, nrow =2,heights=c(.1,1))

gp2 <- ggarrange(NULL,long_reasons_gender_treatment_plot,
          labels = c("D: Reasons treatment not received",""),hjust = 0,
          ncol = 1, nrow =2,heights=c(.1,1))

gender_multiplot <- ggarrange(gp1,NULL,gp2,ncol=1,nrow=3,heights = c(1,.05,1))

gender_multiplot

```

## *Age multi-panel plot*
```{r Age multi-panel plot, fig.height=10,fig.width=10}

gp1 <- ggarrange(NULL,NULL,NULL,treat_dat_seek_age_plot,percent_treatment_type_age_plot+ rremove("ylab"),treat_dat_gap_age_ggplot+ rremove("ylab"), 
          labels = c("A: Treatment seeking","B: Type of treatment sought","C:Treatment receipt","","",""),hjust = 0,
          ncol = 3, nrow =2,heights=c(.1,1))

gp2 <- ggarrange(NULL,long_reasons_age_treatment_plot,
          labels = c("D: Reasons treatment not received",""),hjust = 0,
          ncol = 1, nrow =2,heights=c(.1,1))

age_multiplot <- ggarrange(gp1,NULL,gp2,ncol=1,nrow=3,heights = c(1,.05,1))

age_multiplot

```

## Geographic

Project postcode data onto map of the UK. Use downloaded long/lat data mapped to postcodes from [this site](https://www.freemaptools.com/download-uk-postcode-lat-lng.htm) and city names from [here](https://www.doogal.co.uk/UKPostcodes.php).

### Create clean, labelled and flat outcode dataset

```{r process downloaded geographic data, eval=FALSE}
setwd(wd)
source("./scripts/Create_labelled_outcode_dataset.R")
head(postcode_df_area)
```

### Create counts of treatment seeking and barriers by region

#### read in map libraries

```{r read in map libs, eval=FALSE}
if(!require(maps)){
  install.packages("maps")
  library(maps)
}
# get Uk from maps

UK <- map_data("world") %>% filter(region=="UK")


if(!require(mapproj)){
  install.packages("mapproj")
  library(mapproj)
}

```


```{r process and count treatment by area, eval=FALSE}
 setwd(wd)
 source("./scripts/RAMP_postcode_cleaning.R")

```


### Merge sample data to downloaded UK data

```{r merge national and RAMP data, eval=FALSE}
# 
postcode_full_seek <- left_join(postcode_seek,postcode_df_area,by="Outcode")
postcode_full <- left_join(postcode_full_seek,postcode_receive,by="Outcode")
# 
# # drop rows with no ID data as this indicates they did not exist in the downloaded Uk reference data
 postcode_full<- postcode_full[(!is.na(postcode_full$id) == T),]


```

### create counts by county and district

```{r county count dataset, eval=FALSE}
 setwd(wd)
 source("./scripts/Count_treatment_by_County.R")

```


check county data
```{r check head and count looks fine county, eval=FALSE}
head(postcode_full_County)

```

check district data
```{r check head and count looks fine district, eval=FALSE}
head(postcode_full_District)

```

## test building a UK map with districts plotted

```{r map district project test, eval=FALSE}

bb <- c(10,50,100,500,1000,5000,10000,15000)

maptest <- 
 postcode_full_County %>%
 arrange(longitude) %>%
  
 ggplot() +
    geom_polygon(data = UK, aes(x=long, y = lat, group = group), 
                 fill="grey", alpha=1) +
  geom_polygon( aes(x=longitude, y = latitude, group = County), 
                 fill="black", alpha=1)  +
  theme_void() + 
  coord_map() + 
  theme(legend.position="right") 

```

## Seeking attempts by total responses maps

### Treatment seeking by county (no labels)
Size of the circles = total number of responses
Colour of circles = percent of responses that indicated treatment seeking
```{r map for seeking by county colour no label,warning=FALSE, eval=FALSE}

bb <- c(10,50,100,500,1000,5000,10000,15000)

mapcolour <- 
 postcode_full_County %>%
  
 ggplot() +
    geom_polygon(data = UK, aes(x=long, y = lat, group = group), 
                 fill="grey", alpha=1) +
    geom_point( aes(x=longitude, y=latitude, 
                    size=TotalResponsesCounty, 
                    color=CountyGapProportionTotalSeek), 
                alpha=1) +
    scale_size_continuous(range = c(1,30),
                          breaks = bb,
                          limits = c(1,15000)) +

  scale_color_viridis(trans="log10",alpha = 1,option = "D") +
  theme_void() + 
  ylim(50,59) + 
  coord_map() + 
  theme(legend.position="right") 


#ggsave(paste0(wdirect,"RAMPparticipantMap_colour.png"),mapcolour,dpi=300)

mapcolour

```
### Treatment seeking by district (no labels)

Size of the circles = total number of responses
Colour of circles = percent of responses that indicated treatment seeking
```{r map for seeking by district colour no label,warning=FALSE, eval=FALSE}

bb <- c(10,100,500,1000,2000,3000)

mapcolour <- 
 postcode_full_District %>%
  
 ggplot() +
    geom_polygon(data = UK, aes(x=long, y = lat, group = group), 
                 fill="grey", alpha=1) +
    geom_point( aes(x=longitude, y=latitude, 
                    size=TotalResponsesDistrict, 
                    color=SeekProportionTotalDistrict), 
                alpha=1) +
    scale_size_continuous(range = c(1,20),
                          breaks = bb,
                          limits = c(1,3000)) +

  scale_color_viridis(trans="log10",alpha = 1,option = "D") +
  theme_void() + 
  ylim(50,59) + 
  coord_map() + 
  theme(legend.position="right") 


#ggsave(paste0(wdirect,"RAMPparticipantMap_colour.png"),mapcolour,dpi=300)

mapcolour

```


### Labelled the 5 counties ith greatest proporton seeking by total responses

#### county
```{r map for seeking by county colour labelled,warning=FALSE, eval=FALSE}
bb <- c(10,50,100,500,1000,5000,10000,15000)

mapcolourlabel <- 
 postcode_full_County %>%
  
 ggplot() +
    geom_polygon(data = UK, aes(x=long, y = lat, group = group), fill="grey", alpha=0.5) +
  
    geom_point( aes(x=longitude, y=latitude, size=TotalResponsesCounty, color=CountyGapProportionTotalSeek), alpha=0.8) +
  
    geom_text_repel( data=postcode_full_County %>% 
                       arrange(CountyGapProportionTotalSeek) %>% 
                       tail(5), 
                     aes(x=longitude, y=latitude, label=County), 
                     size=4) +
  
   geom_point( data=postcode_full_County %>% 
                 arrange(CountyGapProportionTotalSeek) %>% 
                 tail(5), 
               aes(x=longitude, y=latitude), 
               color="#78D9C5", 
               size=2) +
  
    scale_size_continuous(range = c(1,40),
                          breaks = bb,
                          limits = c(1,15000)) +

  scale_color_viridis(trans="log10",alpha = 1,option = "D") +
  
  theme_void() + 
  ylim(50,59) + 
  coord_map() + 
  theme(legend.position="right") 


#ggsave(paste0(wdirect,"RAMPparticipantMap_colour.png"),mapcolour,dpi=300)

mapcolourlabel

```


#### district labelled with marker points for most percentage seek attempts by responses
orange markers for top 5 biggest gap, with labels

```{r map for seeking by district colour labelled markers,warning=FALSE, eval=FALSE}

bb <- c(10,100,500,1000,2000,3000)

mapcolourlabel <- 
 postcode_full_District %>%
  
 ggplot() +
    geom_polygon(data = UK, aes(x=long, y = lat, group = group), fill="grey", alpha=0.5) +
  
    geom_point( aes(x=longitude, y=latitude, size=TotalResponsesDistrict, color=SeekProportionTotalDistrict), alpha=0.8) +
  
    geom_text_repel( data=postcode_full_District %>% 
                       arrange(SeekProportionTotalDistrict) %>% 
                       tail(10), 
                     aes(x=longitude, y=latitude, label=District), 
                     size=4) +
  
   geom_point( data=postcode_full_District %>% 
                 arrange(SeekProportionTotalDistrict) %>% 
                 tail(10), 
               aes(x=longitude, y=latitude), 
               color="#78D9C5", 
               size=2) +
  
    scale_size_continuous(range = c(1,20),
                          breaks = bb,
                          limits = c(1,3000)) +

  scale_color_viridis(trans="log10",alpha = 1,option = "D") +
  
  theme_void() + 
  ylim(50,59) + 
  coord_map() + 
  theme(legend.position="right") 


#ggsave(paste0(wdirect,"RAMPparticipantMap_colour.png"),mapcolour,dpi=300)

mapcolourlabel

```

#### district labelled with marker points (no labels)
orange markers for top 5 biggest gap, WITHOUT labels

```{r map for seeking by district colour markers no labels,warning=FALSE, eval=FALSE}

bb <- c(10,100,500,1000,2000,3000)

mapcolourlabel <- 
 postcode_full_District %>%
  
 ggplot() +
    geom_polygon(data = UK, aes(x=long, y = lat, group = group), fill="grey", alpha=0.5) +
  
    geom_point( aes(x=longitude, y=latitude, size=TotalResponsesDistrict, color=SeekProportionTotalDistrict), alpha=0.8) +
  
   geom_point( data=postcode_full_District %>% 
                 arrange(SeekProportionTotalDistrict) %>% 
                 tail(10), 
               aes(x=longitude, y=latitude), 
               color="orange", 
               size=2) +
  
    scale_size_continuous(range = c(1,20),
                          breaks = bb,
                          limits = c(1,3000)) +

  scale_color_viridis(trans="log10",alpha = 1,option = "D") +
  
  theme_void() + 
  ylim(50,59) + 
  coord_map() + 
  theme(legend.position="right") 

#ggsave(paste0(wdirect,"RAMPparticipantMap_colour.png"),mapcolour,dpi=300)

mapcolourlabel

```

#### district - only top ten gap treatment seeking attemps

```{r map for seeking by district colour labelled top ten only,warning=FALSE, eval=FALSE}

bb <- c(100,300,500)

mapcolourlabel <- 
 postcode_full_District %>%
  arrange(SeekProportionTotalDistrict) %>% 
  tail(10) %>%
  
 ggplot() +
    geom_polygon(data = UK, aes(x=long, y = lat, group = group), fill="grey", alpha=0.5) +
  
    geom_point( aes(x=longitude, y=latitude, size=TotalResponsesDistrict, color=SeekProportionTotalDistrict), alpha=0.8) +
  
    geom_text_repel( data=postcode_full_District %>% 
                       arrange(SeekProportionTotalDistrict) %>% 
                       tail(10), 
                     aes(x=longitude, y=latitude, label=District), 
                     size=4) +
  
  
  
    scale_size_continuous(range = c(1,20),
                          breaks = bb,
                          limits = c(1,600)) +

  scale_color_viridis(trans="log10",alpha = 1,option = "D") +
  
  theme_void() + 
  ylim(50,59) + 
  coord_map() + 
  theme(legend.position="right") 


#ggsave(paste0(wdirect,"RAMPparticipantMap_colour.png"),mapcolour,dpi=300)

mapcolourlabel


```


## Treatment gaps by total treatment seeking

### Treatment gap by county (no labels)
Size of the circles = total number of seeking attempts
Colour of circles = percent of times treatment was not received when it was sought
```{r map for gap by county colour no label,warning=FALSE, eval=FALSE}

bb <- c(10,100,500,1000,2000,3000)

mapcolour <- 
 postcode_full_County %>%
  
 ggplot() +
    geom_polygon(data = UK, aes(x=long, y = lat, group = group), 
                 fill="grey", alpha=1) +
    geom_point( aes(x=longitude, y=latitude, 
                    size=SeekAttemptsCountyTotal, 
                    color=CountyGapProportionTotalSeek), 
                alpha=1) +
    scale_size_continuous(range = c(1,40),
                          breaks = bb,
                          limits = c(1,2500)) +

  scale_color_viridis(trans="log10",alpha = 1,option = "D") +
  theme_void() + 
  ylim(50,59) + 
  coord_map() + 
  theme(legend.position="right") 


#ggsave(paste0(wdirect,"RAMPparticipantMap_colour.png"),mapcolour,dpi=300)

mapcolour

```
### Treatment gap by district (no labels)

Size of the circles = total number of responses
Colour of circles = percent of responses that indicated treatment gap
```{r map for gap by district colour no label,warning=FALSE, eval=FALSE}

bb <- c(10,50,100,300,500)

mapcolour <- 
 postcode_full_District %>%
  
 ggplot() +
    geom_polygon(data = UK, aes(x=long, y = lat, group = group), 
                 fill="grey", alpha=1) +
    geom_point( aes(x=longitude, y=latitude, 
                    size=SeekAttemptsDistrictTotal, 
                    color=DistrictGapProportionTotalSeek), 
                alpha=1) +
    scale_size_continuous(range = c(1,12),
                          breaks = bb,
                          limits = c(1,500)) +

  scale_color_viridis(trans="log10",alpha = 1,option = "D") +
  theme_void() + 
  ylim(50,59) + 
  coord_map() + 
  theme(legend.position="right") 


#ggsave(paste0(wdirect,"RAMPparticipantMap_colour.png"),mapcolour,dpi=300)

mapcolour

```


### Labelled the 5 counties ith greatest proporton gap by total responses

#### county
```{r map for gap by county colour labelled,warning=FALSE, eval=FALSE}
bb <- c(10,50,100,300,500)

mapcolourlabel <- 
 postcode_full_County %>%
  
 ggplot() +
    geom_polygon(data = UK, aes(x=long, y = lat, group = group), fill="grey", alpha=0.5) +
  
    geom_point( aes(x=longitude, y=latitude, size=SeekAttemptsCountyTotal, color=CountyGapProportionTotalSeek), alpha=0.8) +
  
    geom_text_repel( data=postcode_full_County %>% 
                       arrange(CountyGapProportionTotalSeek) %>% 
                       tail(5), 
                     aes(x=longitude, y=latitude, label=County), 
                     size=4) +
  
   geom_point( data=postcode_full_County %>% 
                 arrange(CountyGapProportionTotalSeek) %>% 
                 tail(5), 
               aes(x=longitude, y=latitude), 
               color="#78D9C5", 
               size=2) +
  
    scale_size_continuous(range = c(1,40),
                          breaks = bb,
                          limits = c(1,2500)) +

  scale_color_viridis(trans="log10",alpha = 1,option = "D") +
  
  theme_void() + 
  ylim(50,59) + 
  coord_map() + 
  theme(legend.position="right") 


#ggsave(paste0(wdirect,"RAMPparticipantMap_colour.png"),mapcolour,dpi=300)

mapcolourlabel

```


#### district labelled with marker points for most percentage seek attempts by responses
orange markers for top 5 biggest gap, with labels

```{r map for gap by district colour labelled markers,warning=FALSE, eval=FALSE}

bb <- c(10,50,100,300,500)

mapcolourlabel <- 
 postcode_full_District %>%
  
 ggplot() +
    geom_polygon(data = UK, aes(x=long, y = lat, group = group), fill="grey", alpha=0.5) +
  
    geom_point( aes(x=longitude, y=latitude, size=SeekAttemptsDistrictTotal, color=DistrictGapProportionTotalSeek), alpha=0.8) +
  
    geom_text_repel( data=postcode_full_District %>% 
                       arrange(DistrictGapProportionTotalSeek) %>% 
                       tail(10), 
                     aes(x=longitude, y=latitude, label=District), 
                     size=4) +
  
   geom_point( data=postcode_full_District %>% 
                 arrange(DistrictGapProportionTotalSeek) %>% 
                 tail(10), 
               aes(x=longitude, y=latitude), 
               color="#78D9C5", 
               size=2) +
  
    scale_size_continuous(range = c(1,12),
                          breaks = bb,
                          limits = c(1,500)) +

  scale_color_viridis(trans="log10",alpha = 1,option = "D") +
  
  theme_void() + 
  ylim(50,59) + 
  coord_map() + 
  theme(legend.position="right") 


#ggsave(paste0(wdirect,"RAMPparticipantMap_colour.png"),mapcolour,dpi=300)

mapcolourlabel

```

#### district labelled with marker points (no labels)
orange markers for top 5 biggest gap, WITHOUT labels

```{r map for gap by district colour markers no labels,warning=FALSE, eval=FALSE}

bb <- c(10,50,100,300,500)

mapcolourlabel <- 
 postcode_full_District %>%
  
 ggplot() +
    geom_polygon(data = UK, aes(x=long, y = lat, group = group), fill="grey", alpha=0.5) +
  
    geom_point( aes(x=longitude, y=latitude, size=SeekAttemptsDistrictTotal, color=DistrictGapProportionTotalSeek), alpha=0.8) +
  
   geom_point( data=postcode_full_District %>% 
                 arrange(DistrictGapProportionTotalSeek) %>% 
                 tail(10), 
               aes(x=longitude, y=latitude), 
               color="orange", 
               size=2) +
  
    scale_size_continuous(range = c(1,12),
                          breaks = bb,
                          limits = c(1,500)) +

  scale_color_viridis(trans="log10",alpha = 1,option = "D") +
  
  theme_void() + 
  ylim(50,59) + 
  coord_map() + 
  theme(legend.position="right") 

#ggsave(paste0(wdirect,"RAMPparticipantMap_colour.png"),mapcolour,dpi=300)

mapcolourlabel

```

#### district - only top ten gap treatment gap attemps

Filtered to districts where fewer than 5 seek attempts in the district
```{r map for gap by district colour labelled top ten only,warning=FALSE, eval=FALSE}

bb <- c(10,50,100,150)

mapcolourlabel <- 
 postcode_full_District %>%
  filter(SeekAttemptsDistrictTotal > 5) %>%
  arrange(DistrictGapProportionTotalSeek) %>% 
  tail(10) %>%
  
 ggplot() +
    geom_polygon(data = UK, aes(x=long, y = lat, group = group), fill="grey", alpha=0.5) +
  
    geom_point( aes(x=longitude, y=latitude, size=SeekAttemptsDistrictTotal, color=DistrictGapProportionTotalSeek), alpha=0.8) +
  
    geom_text_repel( data=postcode_full_District %>% 
                       filter(SeekAttemptsDistrictTotal > 5) %>%
                       arrange(DistrictGapProportionTotalSeek) %>% 
                       tail(10), 
                     aes(x=longitude, y=latitude, label=District), 
                     size=4) +
  
  
  
    scale_size_continuous(range = c(1,30),
                          breaks = bb,
                          limits = c(1,600)) +

  scale_color_viridis(trans="log10",alpha = 1,option = "D") +
  
  theme_void() + 
  ylim(50,59) + 
  coord_map() + 
  theme(legend.position="right") 


#ggsave(paste0(wdirect,"RAMPparticipantMap_colour.png"),mapcolour,dpi=300)

mapcolourlabel


```


## Mapping alongside indices of multiple deprivation
used most recent in all cases (2019 for England and Wales, 2020 for Scotland, 2017 for Northern Ireland)

### Indices of multiple deprivation were downloaded from:

[England](https://opendatacommunities.org/resource?uri=http%3A%2F%2Fopendatacommunities.org%2Fdata%2Fsocietal-wellbeing%2Fimd2019%2Findices)
[Ireland](https://www.nisra.gov.uk/publications/nimdm17-soa-level-results)
[Scotland](https://www.gov.scot/publications/scottish-index-of-multiple-deprivation-2020v2-ranks/)
*note: using the revised 2020 version for Scotland. See note on Website. Description of indicators is available on sheet 2 of excel downloaded from this link*
[Wales](https://statswales.gov.wales/Catalogue/Community-Safety-and-Social-Inclusion/Welsh-Index-of-Multiple-Deprivation/WIMD-2019/localauthorityanalysis)

### Shapefiles for mapping districts were downloaded from:
[GB (excluding Ireland)](https://www.ordnancesurvey.co.uk/business-government/products/boundaryline)
[IRE](https://www.opendatani.gov.uk/dataset/osni-open-data-largescale-boundaries-ni-outline1)

Projection of shapefiles converted to the Ordnance Survey Great Britain 1936 system (OSGB36 - EPSG code: 27700) to project into common space

### Notes

Using MDI rank for the time being - so ranks within each boundary will be comparable

## clean IMD data

```{r  clean indices of multiple deprivation data, eval=FALSE}

setwd(wd)
source("./scripts/clean_MDI_data.R")

```

## create shapefiles for maps with polygons for plotting district boundaries

```{r shapefile creation, eval=FALSE}

setwd(wd)
source("./scripts/choropelth_map_districts.R")

```


## combine the IMD and shapefiles

```{r combine IMD and shapes, eval=FALSE}
setwd(wd)
source("./scripts/merge_mapShapefiles_and_IMD_data.R")
```


## Plot IMD on map

```{r IMD map plot, eval=FALSE}

## draw plot using ggplot and geom_sf

pl <- UK_ll %>% 
  left_join(IMD_only) %>%
  ggplot() + 
  geom_sf(lwd = .1,color = 'black', aes(fill = Rank)) + 
  theme_void() +
  lims(fill = c(10,4000)) + 
  scale_fill_viridis_c(option = 'plasma') + 
  labs(title = "Title of the plot\nwith a sub title", 
       fill = 'No. responses:') + 
  theme(legend.position = 'left') +
  theme(title = element_text(size = 12), 
        legend.title = element_text(size = 8))

pl

```
### only IMD

### with treatmetn seeking

### with treatment gap

## Analytic decision notes

### Including cohort as a covariate

This would likely be a collider (sx severity is going to be associated with both cohort and treatment seeking)

#### NOTE TO SELF:: fix any treatment barrier stuff
#### make sure the counts are referring to the right thing!


